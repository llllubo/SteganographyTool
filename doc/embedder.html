<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 11.2.0"/>
    <title>embedder API documentation</title>
            <link rel="icon" href="vut_logo.ico"/>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc > section.module-info details > summary{top:-20px;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="index.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;
                Module Index
            </a>

<a href="fit_logo.png">            <img src="fit_logo.png" class="logo" alt="project logo"/>
</a>
            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#Embedder">Embedder</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Embedder.__init__">Embedder</a>
                        </li>
                        <li>
                                <a class="function" href="#Embedder.get_secret_data">get_secret_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Embedder.compress">compress</a>
                        </li>
                        <li>
                                <a class="function" href="#Embedder.encrypt_data">encrypt_data</a>
                        </li>
                        <li>
                                <a class="function" href="#Embedder.xor_data_len">xor_data_len</a>
                        </li>
                        <li>
                                <a class="function" href="#Embedder.xor_fext">xor_fext</a>
                        </li>
                        <li>
                                <a class="function" href="#Embedder.check_cap">check_cap</a>
                        </li>
                        <li>
                                <a class="function" href="#Embedder.embed">embed</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
embedder    </h1>

                        <div class="docstring"><p><code><a href="#Embedder">Embedder</a></code> module</p>

<p>Author:  <em>Ľuboš Bever</em></p>

<p>Date:    <em>11.05.2022</em></p>

<p>Version: <em>1.0</em></p>

<p>Project: <em>Bachelor's thesis, BUT FIT Brno</em></p>
</div>

                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="L-0"><a href="#L-0"><span class="linenos">  0</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">`Embedder` module</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">Author:  *Ľuboš Bever*</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">Date:    *11.05.2022*</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">Version: *1.0*</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">Project: *Bachelor&#39;s thesis, BUT FIT Brno*</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span> <span class="nn">re</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">import</span> <span class="nn">lzma</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span> <span class="nn">iced_x86</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span> <span class="nn">bitarray</span> <span class="kn">import</span> <span class="o">*</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span> <span class="nn">analyzer</span> <span class="kn">import</span> <span class="n">Analyzer</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">from</span> <span class="nn">eq_classes_processor</span> <span class="kn">import</span> <span class="n">EqClassesProcessor</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">import</span> <span class="nn">common</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="kn">from</span> <span class="nn">my_instruction</span> <span class="kn">import</span> <span class="n">MyInstruction</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="k">class</span> <span class="nc">Embedder</span><span class="p">:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a><span class="sd">    `Embedder` is responsible for preprocessing secret message and</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">    embedding it.</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">__b_passwd</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">    Storage of given password in bytes.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>    
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>    <span class="k">def</span> <span class="nf">get_secret_data</span><span class="p">(</span><span class="n">secret_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        Parse given secret message. If file path was given, content of</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">        it is going to be converted to bytes and embedded, and file</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">        extension is parsed and converted as well. If only string was</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        given it&#39;s coverted to bytes as well, and file extension txt</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        will be embedded.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>        
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">secret_message</span><span class="p">):</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>            <span class="c1"># The whole file is going to be embedded.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>            <span class="n">b_fext</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_file_extension</span><span class="p">(</span><span class="n">secret_message</span><span class="p">)</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>            
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>                <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">secret_message</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR! Can not access file of embedding data: </span><span class="si">{args.secret_message}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>            
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>            <span class="n">b_secret_data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>            <span class="c1"># Embedded will be just string.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>            <span class="n">b_secret_data</span> <span class="o">=</span> <span class="n">secret_message</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>            <span class="c1"># If no file was given, txt extension will be used (8 bytes).</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>            <span class="n">b_fext</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;txt&#39;</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>            <span class="n">b_fext</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_fext</span><span class="p">))</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">b_secret_data</span><span class="p">,</span> <span class="n">b_fext</span><span class="p">)</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">        Compress given bytes with LZMA algorithm.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="n">lzc</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMACompressor</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">lzma</span><span class="o">.</span><span class="n">FORMAT_XZ</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>            <span class="n">b_comp1</span> <span class="o">=</span> <span class="n">lzc</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="k">except</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMAError</span><span class="p">:</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR! While preprocessing secret message an error occured.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="n">b_comp2</span> <span class="o">=</span> <span class="n">lzc</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">b_comp1</span> <span class="o">+</span> <span class="n">b_comp2</span><span class="p">)</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>    <span class="k">def</span> <span class="nf">encrypt_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">passwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        Encrypt given data in bytes with given password.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="n">b_key</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">gen_key_from_passwd</span><span class="p">(</span><span class="n">passwd</span><span class="p">)</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>        <span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">b_key</span><span class="p">)</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="n">b_encrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>        
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>        <span class="k">return</span> <span class="n">b_encrypted</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>    
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>    <span class="k">def</span> <span class="nf">xor_data_len</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">        Function returns XORed length of embedding data.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="c1"># Must be in bytes, because password is in the bytes as well.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="n">b_encrypted_len</span> <span class="o">=</span> \
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>           <span class="nb">len</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="c1"># Prepare password length ONLY for XOR operation.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>            <span class="n">b_passwd</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">))</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">[:</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">]</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>        <span class="c1"># Data length bytes are going to be XORed with password of same</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="c1"># size. If given password is longer, it&#39;s truncated. This is</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="c1"># security reason as if whole password bytes were XORed with null</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="c1"># padding of data length bytes, password characters would map to</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>        <span class="c1"># the XORed data length and could be readable. Reversed cycle is</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="c1"># used to avoid problem when null byte is in the middle of data.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="n">null_padding</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">b_encrypted_len</span><span class="p">):</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>                <span class="k">break</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="n">null_padding</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>        
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="n">null_padding</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="n">b_xored_len</span> <span class="o">=</span> \
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>            <span class="nb">bytes</span><span class="p">([</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">b_encrypted_len</span><span class="p">,</span> <span class="n">b_passwd</span><span class="p">[:</span><span class="n">i</span><span class="p">])])</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="c1"># Add null bytes after XOR.</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="n">b_xored_len</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_xored_len</span><span class="p">))</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>        <span class="k">return</span> <span class="n">b_xored_len</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>    
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>    <span class="k">def</span> <span class="nf">xor_fext</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a><span class="sd">        XOR given file extension in bytes with password and return it.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="sd">        &quot;&quot;&quot;</span>   
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="c1"># XOR only if there is any file extension.</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="k">if</span> <span class="n">fext</span> <span class="o">!=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">):</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="c1"># Prepare password length ONLY for XOR operation.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">:</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                <span class="n">b_passwd</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">))</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">[:</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">]</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="c1"># File extension bytes are going to be XORed with password</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>            <span class="c1"># of same size. If given password is longer, it&#39;s truncated.</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="c1"># This is security reason as if whole password bytes were</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>            <span class="c1"># XORed with null padding of data length bytes, password</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="c1"># characters would map to the XORed data length and could be</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>            <span class="c1"># readable. Reversed cycle is used to avoid problem when</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="c1"># null byte is in the middle of data.</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="n">null_padding</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>            
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">fext</span><span class="p">):</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>                <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>                    <span class="k">break</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>                <span class="n">null_padding</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="n">null_padding</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>            
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="n">b_xored_fext</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fext</span><span class="p">,</span> <span class="n">b_passwd</span><span class="p">[:</span><span class="n">i</span><span class="p">])])</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>            <span class="c1"># Add null bytes after XOR.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>            <span class="n">b_xored_fext</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_xored_fext</span><span class="p">))</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>            <span class="k">return</span> <span class="n">b_xored_fext</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="n">fext</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>    
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>    
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>    <span class="k">def</span> <span class="nf">check_cap</span><span class="p">(</span><span class="n">mess_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">Analyzer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="sd">        Check if message with given length after preprocessing can be</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">        embedded and exit the program if not.</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="k">if</span> <span class="n">mess_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">min_capacity</span> <span class="o">/</span> <span class="mi">8</span><span class="p">):</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR! Capacity of cover-file is not sufficient and data can not be embedded!&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>                
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>                
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>    <span class="k">def</span> <span class="nf">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">:</span> <span class="n">EqClassesProcessor</span><span class="p">,</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>                           <span class="n">bits_mess</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">        Map first bits (of reasonable lenght) from message bits to the</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        encoding index of particular equivalent class member index.</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="n">mem_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="n">is_power_of_2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">mem_len</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_power_of_2</span><span class="p">:</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>            <span class="c1"># If variable length encoding was used, 1st try is to take</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>            <span class="c1"># maximum number of bits that can be embedded by current</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>            <span class="c1"># equivalent class.</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>            <span class="n">max_bits</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">mem_len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="c1"># Fixed length encoding was used, therefore only max. number</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="c1"># of bits will be tested.</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="n">max_bits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">mem_len</span><span class="p">))</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>        
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="c1"># Correctness of message length if last bits are going to be</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>        <span class="c1"># embedded - zeros padding.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>        <span class="n">added_nulls</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>        <span class="k">if</span> <span class="n">max_bits</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_mess</span><span class="p">):</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="n">added_nulls</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">max_bits</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_mess</span><span class="p">))</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="n">added_nulls</span><span class="o">.</span><span class="n">setall</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="n">bits_mess</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">added_nulls</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>        
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>        <span class="c1"># 1st try to find appropriate encoding with max. allowed length</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>        <span class="c1"># and also the only one try if fixed length encoding was used.</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">encoded_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">):</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>            <span class="k">if</span> <span class="n">encoded_idx</span> <span class="o">==</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="n">max_bits</span><span class="p">]:</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                <span class="k">return</span> <span class="n">idx</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>        <span class="c1"># 2nd try to find appropriate encoding with min. allowed length.</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>        <span class="c1"># This has to always find useable encoding, if 1st try was</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="c1"># unsuccessful, in case of variable length encoding.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_power_of_2</span><span class="p">:</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="n">min_bits</span> <span class="o">=</span> <span class="n">max_bits</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>            <span class="c1"># Pop zero padding if was added.</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="k">if</span> <span class="n">added_nulls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="n">bits_mess</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>            
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">encoded_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">):</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>                <span class="k">if</span> <span class="n">encoded_idx</span> <span class="o">==</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="n">min_bits</span><span class="p">]:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                    <span class="k">return</span> <span class="n">idx</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>            
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>            
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>    <span class="k">def</span> <span class="nf">__get_rex_idx</span><span class="p">(</span><span class="n">instr_fromf</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">        REX prefix, if present, is placed immediately before opcode,</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">        return its index within whole instruction bytes.</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>        
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="k">if</span> <span class="n">opcode_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="c1"># Try to find out if REX prefix is present.</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">opcode_idx</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="n">rex</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                <span class="c1"># Check if there is any more byte opcode prefix (LEGACY).</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                <span class="k">if</span> <span class="n">instr_fromf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x0f</span><span class="s2">&quot;</span> <span class="ow">or</span> \
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                    <span class="n">instr_fromf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x38</span><span class="s2">&quot;</span> <span class="ow">or</span> \
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                    <span class="n">instr_fromf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x3a</span><span class="s2">&quot;</span><span class="p">:</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>                        <span class="c1"># There is no REX, only more bytes long opcode.</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>                    <span class="c1"># Go and check next byte.</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                    <span class="c1"># Here must be REX prefix, if not REX is not present.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>                    <span class="n">rex</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">instr_fromf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>                    <span class="k">if</span> <span class="n">rex</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;0100&#39;</span><span class="p">):</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>                        <span class="c1"># Found REX prefix.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                        <span class="k">return</span> <span class="n">i</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                        <span class="c1"># There is no REX prefix.</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>            <span class="c1"># There is no REX prefix.</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>    
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>    
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>    <span class="k">def</span> <span class="nf">__can_schedule_mov</span><span class="p">(</span><span class="n">instr_mov0</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>                       <span class="n">instr_mov1</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a><span class="sd">        Decide if MOVs will be used for embedding - same check will be</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a><span class="sd">        done by extractor.</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="n">mov0</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr_mov0</span><span class="o">.</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="n">mov1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr_mov1</span><span class="o">.</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov0</span><span class="p">)</span> <span class="o">==</span> \
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov1</span><span class="p">):</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>            <span class="c1"># It is signing tak they can not be scheduled. It happens</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="c1"># extremely rare.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>        <span class="k">return</span> <span class="kc">True</span>        
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>    
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>    
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>    <span class="k">def</span> <span class="nf">__should_swap_mov</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                          <span class="n">instr_mov0</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>                          <span class="n">instr_mov1</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                          <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        Decide if MOV pair should be swapped according to the next</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">        embedding bit of information.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="c1"># Get instruction string.</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="n">mov0</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr_mov0</span><span class="o">.</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>        <span class="n">mov1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr_mov1</span><span class="o">.</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="c1"># There is possibility that both will have set only scheduling</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="c1"># flag and then could not be decided what ordering would be</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="c1"># used. Therefore must be accessed to the array of all</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>        <span class="c1"># equivalent classes and read out configured ordering from file.</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="k">for</span> <span class="n">eq_class</span> <span class="ow">in</span> <span class="n">EqClassesProcessor</span><span class="o">.</span><span class="n">all_eq_classes</span><span class="p">:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="k">if</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;MOV Scheduling&quot;</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>                <span class="n">ordering</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>        
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="k">if</span> <span class="n">ordering</span> <span class="o">==</span> <span class="s2">&quot;Ascending&quot;</span> <span class="ow">and</span> \
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov1</span><span class="p">):</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="k">elif</span> <span class="n">ordering</span> <span class="o">==</span> <span class="s2">&quot;Descending&quot;</span> <span class="ow">and</span> \
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov1</span><span class="p">):</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>    <span class="k">def</span> <span class="nf">__should_swap_base_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instr</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">        Find out if base and index memory registers should be swapped</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        according to desired order determined by next encoding bit of</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        message.</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Ascending&quot;</span> <span class="ow">and</span> \
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>            <span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">memory_base</span> <span class="o">&gt;</span> <span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">memory_index</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Descending&quot;</span> <span class="ow">and</span> \
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">memory_base</span> <span class="o">&lt;</span> <span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">memory_index</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>    <span class="k">def</span> <span class="nf">__swap_base_index</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>                          <span class="n">opcode_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>                          <span class="n">bits_instr</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="sd">        Last parameter of function is going to be changed and then</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        will be used outside function.</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>        
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="c1"># First, swap REX prefix bits if available.</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="k">if</span> <span class="n">rex_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>            <span class="c1"># There was REX prefix detected.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>            <span class="n">rex_b_bit_offset</span> <span class="o">=</span> <span class="n">rex_idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="n">rex_b_bit</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_b_bit_offset</span><span class="p">]</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>            <span class="n">rex_x_bit_offset</span> <span class="o">=</span> <span class="n">rex_idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="n">rex_x_bit</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_x_bit_offset</span><span class="p">]</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_b_bit_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">rex_x_bit</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_x_bit_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">rex_b_bit</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="c1"># Second, swap SIB.base and SIB.index registers.</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>        <span class="n">sib_sign_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        <span class="k">if</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">sib_sign_offset</span><span class="p">:</span><span class="n">sib_sign_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> \
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">):</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="c1"># Just to make sure, that SIB byte is present.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="n">sib_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            <span class="n">base_offset</span> <span class="o">=</span> <span class="n">sib_offset</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="n">index_offset</span> <span class="o">=</span> <span class="n">sib_offset</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="n">bits_base</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">base_offset</span><span class="p">:</span><span class="n">base_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>            <span class="n">bits_index</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">index_offset</span><span class="p">:</span><span class="n">index_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">base_offset</span><span class="p">:</span><span class="n">base_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits_index</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">index_offset</span><span class="p">:</span><span class="n">index_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits_base</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="c1"># Something goes wrong and SIB byte sign is not</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="c1"># ok - instruction is not used for embedding.</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>    
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>    
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>    <span class="k">def</span> <span class="nf">__swap_rm_r_operands</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>                             <span class="n">opcode_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>                             <span class="n">bits_instr</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">        Last parameter of function is going to be changed and then</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">        will be used outside function.</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>        
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="c1"># First, swap REX prefix bits if available.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="k">if</span> <span class="n">rex_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>            <span class="c1"># There was REX prefix detected.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>            <span class="n">rex_b_bit_offset</span> <span class="o">=</span> <span class="n">rex_idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>            <span class="n">rex_b_bit</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_b_bit_offset</span><span class="p">]</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            <span class="n">rex_r_bit_offset</span> <span class="o">=</span> <span class="n">rex_idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="n">rex_r_bit</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_r_bit_offset</span><span class="p">]</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_b_bit_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">rex_r_bit</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_r_bit_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">rex_b_bit</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="c1"># Locate Reg/Opcode field inside ModR/M byte.</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="n">reg_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="n">reg_bits</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="c1"># Locate rm field inside ModR/M byte.</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>        <span class="n">rm_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="n">rm_bits</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rm_field_offset</span><span class="p">:(</span><span class="n">rm_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>        <span class="c1"># Rewrite required Reg/Opcode field bits inside instruction.</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rm_bits</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="c1"># Rewrite required rm field bits inside instruction.</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="n">bits_instr</span><span class="p">[</span><span class="n">rm_field_offset</span><span class="p">:(</span><span class="n">rm_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">reg_bits</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>    
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>    
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>    <span class="k">def</span> <span class="nf">__create_opcode</span><span class="p">(</span><span class="n">instr</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a><span class="sd">        Create desired OPCODE for instructions of equivalent classes</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a><span class="sd">        &#39;TEST/AND/OR&#39; and &#39;SUB/XOR&#39;.</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>        
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="k">if</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">operand_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>            <span class="c1"># Correctness of OPCODE if 1 byte operand.</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>            <span class="n">new_opcode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">new_opcode</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="n">b_new_opcode</span> <span class="o">=</span> <span class="n">new_opcode</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code_len</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>            
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="c1"># Without any correctness, only get OPCODE from</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="c1"># class member.</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="n">b_new_opcode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>        <span class="k">return</span> <span class="n">b_new_opcode</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>    <span class="k">def</span> <span class="nf">__make_ADD_SUB_opcode</span><span class="p">(</span><span class="n">instr</span><span class="p">:</span> <span class="n">Instruction</span><span class="p">,</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>                                <span class="n">opcode_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>                                <span class="n">bits_to_embed</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">,</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>                                <span class="n">bits_instr</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a><span class="sd">        Embed ADD or SUB OPCODE according to the next encoding bits.</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">        There is special case of AL register operand when OPCODES of</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">        ADD and SUB differ and they must be changed. Also, in this</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">        case there is no ModR/M byte, so Reg/Opcode can not be</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">        modified. Otherwise, OPCODES stay same and Reg/Opcode field of</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">        ModR/M byte is changed only.</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">        Last parameter of function is going to be changed and then</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">        will be used outside function.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">op0_kind</span> <span class="o">==</span> <span class="n">OpKind</span><span class="o">.</span><span class="n">REGISTER</span> <span class="ow">and</span> \
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="n">instr</span><span class="o">.</span><span class="n">op0_register</span> <span class="o">==</span> <span class="n">Register</span><span class="o">.</span><span class="n">AL</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="c1"># Register AL has special OPCODE without ModR/M.</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>            <span class="n">new_opcode</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>            <span class="k">if</span> <span class="n">bits_to_embed</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;000&#39;</span><span class="p">):</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                <span class="c1"># ADD is going to be embedded.</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="n">new_opcode</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;04&quot;</span><span class="p">))</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>                <span class="c1"># SUB is going to be embedded.</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>                <span class="n">new_opcode</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;2c&quot;</span><span class="p">))</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>            <span class="n">opcode_offset</span> <span class="o">=</span> <span class="n">opcode_idx</span> <span class="o">*</span> <span class="mi">8</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="n">opcode_len</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code_len</span> <span class="o">*</span> <span class="mi">8</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">opcode_offset</span><span class="p">:(</span><span class="n">opcode_offset</span> <span class="o">+</span> <span class="n">opcode_len</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_opcode</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>            <span class="c1"># Locate Reg/Opcode field inside ModR/M byte.</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="n">reg_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>            <span class="c1"># Rewrite required bits inside instruction.</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bits_to_embed</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>    
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>    
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>    <span class="k">def</span> <span class="nf">__twos_complement</span><span class="p">(</span><span class="n">instr</span><span class="p">:</span> <span class="n">Instruction</span><span class="p">,</span> <span class="n">op_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a><span class="sd">        Make two&#39;s complement of immediate operand.</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>        
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>        <span class="n">bits_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:08b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="n">flipped_bits_number</span> <span class="o">=</span> <span class="o">~</span> <span class="n">bits_number</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="n">flipped_bits_number</span> <span class="o">=</span> <span class="n">flipped_bits_number</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>        <span class="n">str_twos_complement</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">flipped_bits_number</span><span class="p">)</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>            
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_twos_complement</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>            <span class="n">op_size</span><span class="p">,</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">,</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>            <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>            
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>    <span class="k">def</span> <span class="nf">__get_imm_idx</span><span class="p">(</span><span class="n">instr_fromf</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">imm</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">op_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">        Get index position of immediate operand inside instruction.</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="n">b_imm</span> <span class="o">=</span> <span class="n">imm</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">op_size</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>        <span class="k">return</span> <span class="n">instr_fromf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b_imm</span><span class="p">)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>    
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>    <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>              <span class="n">fexe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>              <span class="n">mess</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>              <span class="n">potential_my_instrs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>              <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">        Embed given secret message.</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="c1"># Skip flag defines how many next instructions should be</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="c1"># skipped as they were already used by first instruction</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>        <span class="c1"># from their group (3 and 2 Bytes Long NOP classes).</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>        <span class="c1"># Determines if MOVs were already scheduled. It&#39;s False at the</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="c1"># beginning, but first MOV set it to True after they are</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="c1"># scheduled.</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>        <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>        <span class="n">bits_mess</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>        <span class="n">bits_mess</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">mess</span><span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>            <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fexe</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR! Can not open cover file for embedding: </span><span class="si">{</span><span class="n">fexe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="k">for</span> <span class="n">instr_idx</span><span class="p">,</span> <span class="n">my_instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">potential_my_instrs</span><span class="p">):</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>            
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                <span class="c1"># Skip current NOP instruction.</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>                <span class="n">skip</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>                <span class="k">continue</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>            <span class="c1"># For speed performance.</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="n">eq_class</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">eq_class</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>            <span class="n">instr</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">instruction</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>            
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>            <span class="c1"># Instructions that don&#39;t have encoding LEGACY are skipped.</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>            <span class="c1"># Legacy encoding for opcodes of instructions is mainly used</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>            <span class="c1"># in each PE and ELF (32- and 64-bit) executables and others</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            <span class="c1"># encodings are very rare.</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>            <span class="k">if</span> <span class="n">eq_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>                <span class="n">instr</span><span class="o">.</span><span class="n">encoding</span> <span class="o">==</span> <span class="n">EncodingKind</span><span class="o">.</span><span class="n">LEGACY</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>                
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                <span class="c1"># Encoding is lexicographic order of used instructions</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                <span class="c1"># strings and it&#39;s determined by configuration file.</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;MOV Scheduling&quot;</span> <span class="ow">or</span> \
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                    <span class="n">my_instr</span><span class="o">.</span><span class="n">mov_scheduling_flag</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">movs_scheduled</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>                    <span class="c1">## Second MOV is current, both can be scheduled now.</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>                    <span class="c1"># Set flag with first MOV - This is only tag for</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>                    <span class="c1"># knowledge that first MOV was tried to be scheduled.</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>                    <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>                    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__can_schedule_mov</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>                                              <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>                    
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>                        <span class="n">next_mov</span> <span class="o">=</span> <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>                        
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>                        <span class="c1"># Find out desired order for MOVs according to</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>                        <span class="c1"># the encoding.</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>                        <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>                        <span class="c1"># Decide if both MOVs should be swapped according to</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>                        <span class="c1"># the next secret message bits or if they are in the</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>                        <span class="c1"># right order.</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>                        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__should_swap_mov</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">next_mov</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>                            <span class="c1"># MOVs are going to be swapped.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>                            
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>                            <span class="c1"># Read instruction bytes of 1st MOV.</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>                            <span class="n">b_mov0_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>                            
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>                            <span class="c1"># Read instruction bytes of 2nd MOV.</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>                            <span class="n">b_mov1_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">instruction</span><span class="p">))</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>                            
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>                            <span class="c1"># Swap them.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_mov1_fromf</span><span class="p">)</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>                            
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">instruction</span><span class="p">))</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_mov0_fromf</span><span class="p">)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>                            
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>                        <span class="c1"># Delete already embedded order bit from list.</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>                        <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>                    <span class="c1"># Unset flag with second MOV.</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>                    <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>                
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>                
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:MOV|ADD|SUB|AND|OR|XOR|CMP|ADC|SBB)$&quot;</span><span class="p">,</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>                          <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="p">):</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>                    <span class="c1"># Form of instruction changes (r/m, r &lt;=&gt; r, r/m),</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>                    <span class="c1"># therefore, also, operands must be changed. If REX</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>                    <span class="c1"># prefix is present, proper bits of prefix are</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>                    <span class="c1"># exchanged, as well.</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>                    <span class="c1"># MOV instruction form this class can also be</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>                    <span class="c1"># scheduled.</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>                    <span class="c1"># modify it.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>                    
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>                    
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>                    
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>                    
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>                    <span class="c1"># Find Direction bit to embed according to the</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>                    <span class="c1"># encoding.</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>                    <span class="n">new_dir_bit</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                    
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                    <span class="n">dir_bit_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                    <span class="c1"># decide if Direction bit is going to be swapped.</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                    <span class="k">if</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> \
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>                        <span class="n">new_dir_bit</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>                    
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>                        <span class="c1"># Direction bit is going to be changed.</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>                        <span class="n">rex_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_rex_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>                        
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>                        <span class="c1"># Exchange Reg/Opcode and rm field of ModR/M byte.</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>                        <span class="bp">cls</span><span class="o">.</span><span class="n">__swap_rm_r_operands</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">,</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>                                                <span class="n">opcode_idx</span><span class="p">,</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>                                                <span class="n">bits_instr</span><span class="p">)</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>                        
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>                        <span class="c1"># Rewrite Direction bit inside opcode of instruction.</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>                        <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>                            <span class="n">new_dir_bit</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>                        
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>                        <span class="c1"># Embed to the executable.</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>                    
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>                    <span class="c1"># Always 1, because embedded was only Direction bit.</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>                
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>                
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>                <span class="c1"># Encoding is lexicographic order of used registers name</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>                <span class="c1"># and it&#39;s determined by configuration file.</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>                <span class="k">if</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;Swap base-index registers 32-bit&quot;</span><span class="p">:</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>                    <span class="c1"># Instruction form changes (SIB.base &lt;=&gt; SIB.index),</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>                    <span class="c1"># therefore, also, operands must be changed. If REX</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>                    <span class="c1"># prefix is present, proper bits of prefix are</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>                    <span class="c1"># exchanged, as well.</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>                    <span class="c1"># MOV instruction form this class can also be</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>                    <span class="c1"># scheduled.</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>                    <span class="c1"># Find out desired order for base-index according to</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>                    <span class="c1"># the encoding.</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>                    
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>                    <span class="c1"># Decide if base and index registers should be</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>                    <span class="c1"># swapped according to the next secret message bits</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>                    <span class="c1"># or if they are in the right order.</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>                    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__should_swap_base_index</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>                        <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>                        <span class="c1"># modify it.</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>                        <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>                       
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>                        <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>                        <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>                        <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>                        
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>                        <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>                        <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>                        
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>                        <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>                                                           <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>                        
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>                        <span class="n">rex_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_rex_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>                        
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>                        <span class="c1"># Swap registers. If swap is not successful,</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>                        <span class="c1"># nothing is embeddded and instr. is skipped.</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>                        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__swap_base_index</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">,</span> <span class="n">bits_instr</span><span class="p">):</span>                        
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>                            <span class="c1"># Embed to the executable.</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>                            
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>                            <span class="c1"># Delete already embedded bit from list.</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>                            <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>                        <span class="c1"># Delete already embedded bit from list.</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>                        <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>                        
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>                
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>                <span class="c1"># Classes can be together as their usage is based on</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>                <span class="c1"># exactly same principle.</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;2 Bytes Long NOP&quot;</span> <span class="ow">or</span> \
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;3 Bytes Long NOP&quot;</span><span class="p">:</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>                    <span class="c1"># Set skip flag for next instructions skipping.</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>                    <span class="n">skip</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">set_skip_flag</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>                                                <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>                    <span class="c1"># Find bits to embed according to the encoding.</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>                    
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>                
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>                <span class="c1"># Class does not encodes class members, as it does not</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>                <span class="c1"># have any. In this case, bits from message are simply</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>                <span class="c1"># embedded to the last useable instruction bytes.</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;&gt;3 Bytes Long NOP&quot;</span><span class="p">:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>                    <span class="c1"># Get number of bits available for embedding.</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>                    <span class="n">bits_cnt</span> <span class="o">=</span> \
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>                        <span class="n">common</span><span class="o">.</span><span class="n">count_useable_bits_from_nop</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>                                                           <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)))</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>                    <span class="c1"># Take bits needed to embed.</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="n">bits_cnt</span><span class="p">]</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>                    <span class="c1"># There is 100% chance that it will be multiple of 8.</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>                    <span class="n">b_cnt</span> <span class="o">=</span> <span class="n">bits_cnt</span> <span class="o">//</span> <span class="mi">8</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>                    
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>                    <span class="n">pos</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">-</span> <span class="n">b_cnt</span><span class="p">)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_to_embed</span><span class="p">)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">bits_to_embed</span><span class="p">)]</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>                
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>                <span class="c1"># These two classes can be merged as they modify only</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>                <span class="c1"># Reg/Opcode field inside ModR/M byte.</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SHL/SAL&quot;</span> <span class="ow">or</span> \
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;TEST non-accumulator register&quot;</span><span class="p">:</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>                    <span class="c1"># modify it.</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>                    
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>                    
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>                    
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>                    <span class="c1"># Find bits to embed according to the encoding.</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>                    <span class="c1"># Locate Reg/Opcode field inside ModR/M byte.</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>                    <span class="n">reg_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>                    <span class="c1"># Rewrite required bits inside instruction.</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>                    <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> \
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>                        <span class="n">bits_to_embed</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>                
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>                
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:ADD|SUB|AND|OR|XOR|CMP|ADC|SBB) 32-bit$&quot;</span><span class="p">,</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>                          <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="p">):</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>                    <span class="c1"># modify it.</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>                    
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>                    
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>                    <span class="c1"># Find Direction bit to embed according to the</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>                    <span class="c1"># encoding.</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>                    <span class="n">dir_bit</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>                    
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>                    <span class="c1"># Rewrite Direction bit inside opcode of instruction.</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>                    <span class="n">dir_bit_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>                    <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir_bit</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>                    
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>                    <span class="c1"># Always 1, because embedded was only Direction bit.</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a>                
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a>                
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SUB/XOR&quot;</span> <span class="ow">or</span> \
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;TEST/AND/OR&quot;</span><span class="p">:</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a>                    <span class="c1"># modify it.</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a>                    
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>                    
</span><span id="L-841"><a href="#L-841"><span class="linenos">841</span></a>                    <span class="c1"># Find Reg/Opcode bits to embed according to the</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos">842</span></a>                    <span class="c1"># encoding.</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos">843</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos">844</span></a>                    
</span><span id="L-845"><a href="#L-845"><span class="linenos">845</span></a>                    <span class="c1"># Creates desired opcode according to encoding bits.</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos">846</span></a>                    <span class="n">b_new_opcode</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__create_opcode</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos">847</span></a>                    
</span><span id="L-848"><a href="#L-848"><span class="linenos">848</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos">849</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos">850</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_new_opcode</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos">851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos">852</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos">853</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos">854</span></a>
</span><span id="L-855"><a href="#L-855"><span class="linenos">855</span></a>                
</span><span id="L-856"><a href="#L-856"><span class="linenos">856</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;ADD negated&quot;</span> <span class="ow">or</span> \
</span><span id="L-857"><a href="#L-857"><span class="linenos">857</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SUB negated&quot;</span><span class="p">:</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos">858</span></a>                    <span class="k">continue</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos">859</span></a>                    <span class="nb">print</span><span class="p">()</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos">860</span></a>                    <span class="c1">## nulu nemozem negovat, zachovam ju</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos">861</span></a>                    <span class="c1"># NEGACIA imm je dvojkovy doplnek</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos">862</span></a>                    <span class="c1"># ^^ 0x42 =&gt; -0x42 == (extended sign)FFF..BE</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos">863</span></a>                    
</span><span id="L-864"><a href="#L-864"><span class="linenos">864</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos">865</span></a>                    <span class="c1"># modify it.</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos">866</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos">867</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos">868</span></a>                    
</span><span id="L-869"><a href="#L-869"><span class="linenos">869</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos">870</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos">871</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos">872</span></a>                    
</span><span id="L-873"><a href="#L-873"><span class="linenos">873</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos">874</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos">875</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos">876</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos">877</span></a>                    
</span><span id="L-878"><a href="#L-878"><span class="linenos">878</span></a>                    <span class="c1"># Find Reg/Opcode bits to embed according to the</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos">879</span></a>                    <span class="c1"># encoding.</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos">880</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos">881</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos">882</span></a>                    
</span><span id="L-883"><a href="#L-883"><span class="linenos">883</span></a>                    <span class="n">operand_size</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">operand_size</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos">884</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class: </span><span class="si">{</span><span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">instr: </span><span class="si">{</span><span class="n">instr</span><span class="si">}</span><span class="se">\n</span><span class="s2">b_instr_fromf: </span><span class="si">{</span><span class="n">b_instr_fromf</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">operand_size: </span><span class="si">{</span><span class="n">operand_size</span><span class="si">}</span><span class="se">\n</span><span class="s2">bits_to_embed: </span><span class="si">{</span><span class="n">bits_to_embed</span><span class="si">}</span><span class="se">\n</span><span class="s2">instr_opcode: </span><span class="si">{</span><span class="n">instr_opcode</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">opcode_idx</span><span class="si">}</span><span class="se">\n</span><span class="s2">bits_instr: </span><span class="si">{</span><span class="n">bits_instr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos">885</span></a>                    
</span><span id="L-886"><a href="#L-886"><span class="linenos">886</span></a>                    <span class="c1"># Embed ADD or SUB according to next encoding bits.</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos">887</span></a>                    <span class="c1"># There is special case for 1 byte long AL register</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos">888</span></a>                    <span class="c1"># operand which is also handled.</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos">889</span></a>                    <span class="bp">cls</span><span class="o">.</span><span class="n">__make_ADD_SUB_opcode</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos">890</span></a>                                              <span class="n">opcode_idx</span><span class="p">,</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos">891</span></a>                                              <span class="n">bits_to_embed</span><span class="p">,</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos">892</span></a>                                              <span class="n">bits_instr</span><span class="p">)</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos">893</span></a>                
</span><span id="L-894"><a href="#L-894"><span class="linenos">894</span></a>                    <span class="c1"># Make two&#39;s Complement of immediate (always last</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos">895</span></a>                    <span class="c1"># bytes) if required - if ADD was changed to SUB and</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos">896</span></a>                    <span class="c1"># vice versa. Also zero immediate can not be negated</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos">897</span></a>                    <span class="c1"># as it has only one representation in two&#39;s</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos">898</span></a>                    <span class="c1"># complement code.</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos">899</span></a>                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> \
</span><span id="L-900"><a href="#L-900"><span class="linenos">900</span></a>                        <span class="p">(</span> <span class="p">(</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos">901</span></a>                            <span class="n">instr</span><span class="o">.</span><span class="n">mnemonic</span> <span class="o">==</span> <span class="n">Mnemonic</span><span class="o">.</span><span class="n">ADD</span> <span class="ow">and</span> \
</span><span id="L-902"><a href="#L-902"><span class="linenos">902</span></a>                            <span class="n">bits_to_embed</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;101&#39;</span><span class="p">)</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos">903</span></a>                        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos">904</span></a>                            <span class="n">instr</span><span class="o">.</span><span class="n">mnemonic</span> <span class="o">==</span> <span class="n">Mnemonic</span><span class="o">.</span><span class="n">SUB</span> <span class="ow">and</span> \
</span><span id="L-905"><a href="#L-905"><span class="linenos">905</span></a>                            <span class="n">bits_to_embed</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;000&#39;</span><span class="p">)</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos">906</span></a>                        <span class="p">)</span> <span class="p">):</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos">907</span></a>                        <span class="c1"># It&#39;s ADD changing to SUB =&gt; swap sign.</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos">908</span></a>                        <span class="c1"># or..</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos">909</span></a>                        <span class="c1"># It&#39;s SUB changing to ADD =&gt; swap sign.</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos">910</span></a>                        
</span><span id="L-911"><a href="#L-911"><span class="linenos">911</span></a>                        <span class="c1"># Get operand size in bytes.</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos">912</span></a>                        <span class="n">op_size</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">operand_size</span> <span class="o">//</span> <span class="mi">8</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos">913</span></a>                        <span class="k">if</span> <span class="n">op_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos">914</span></a>                            <span class="c1"># For 1 byte long operands function returns 0.</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos">915</span></a>                            <span class="n">op_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos">916</span></a>                        <span class="k">elif</span> <span class="n">op_size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos">917</span></a>                            <span class="c1"># For all ADD/SUB instructions are always</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos">918</span></a>                            <span class="c1"># 64 bits long immediates truncated to 32.</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos">919</span></a>                            <span class="c1"># It can be done as Stack instructions are</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos">920</span></a>                            <span class="c1"># not supported in this program (they do not</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos">921</span></a>                            <span class="c1"># truncate 64 bits to 32).</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos">922</span></a>                            <span class="n">op_size</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos">923</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">op_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos">924</span></a>                        <span class="c1"># Make 2&#39;s complement to negate immediate.</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos">925</span></a>                        <span class="n">b_imm_compl</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__twos_complement</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">op_size</span><span class="p">)</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos">926</span></a>                        <span class="c1"># Get position in instruction bytes where</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos">927</span></a>                        <span class="c1"># immediate begins.</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos">928</span></a>                        <span class="n">imm_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_imm_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos">929</span></a>                                                    <span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos">930</span></a>                                                    <span class="n">op_size</span><span class="p">)</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos">931</span></a>                        
</span><span id="L-932"><a href="#L-932"><span class="linenos">932</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;imm_idx: </span><span class="si">{</span><span class="n">imm_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos">933</span></a>                        <span class="c1"># Substitute immediate operand for his 2&#39;s comp.</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos">934</span></a>                        <span class="n">bits_imm</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos">935</span></a>                        <span class="n">bits_imm</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_imm_compl</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos">936</span></a>                        <span class="c1"># Truncate long sign extension.</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos">937</span></a>                        <span class="n">imm_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">[</span><span class="n">imm_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:])</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos">938</span></a>                        <span class="n">bits_instr</span><span class="p">[</span><span class="n">imm_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:]</span> <span class="o">=</span> <span class="n">bits_imm</span><span class="p">[:</span><span class="n">imm_len</span><span class="p">]</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos">939</span></a>                        
</span><span id="L-940"><a href="#L-940"><span class="linenos">940</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b_imm_compl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos">941</span></a>                                                
</span><span id="L-942"><a href="#L-942"><span class="linenos">942</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bits_instr</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos">943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos">944</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos">945</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos">946</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos">947</span></a>
</span><span id="L-948"><a href="#L-948"><span class="linenos">948</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos">949</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos">950</span></a>                    <span class="c1"># sys.exit()</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos">951</span></a>    
</span><span id="L-952"><a href="#L-952"><span class="linenos">952</span></a>                
</span><span id="L-953"><a href="#L-953"><span class="linenos">953</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos">954</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CAN NOT BE USED - NOT LEGACY INSTRUCTION.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos">955</span></a>                
</span><span id="L-956"><a href="#L-956"><span class="linenos">956</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_mess</span><span class="p">):</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos">957</span></a>                <span class="c1"># All bits were embedded (whole message).</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos">958</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos">959</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All data was successfully embedded.&quot;</span><span class="p">)</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos">960</span></a>                <span class="k">break</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos">961</span></a>            
</span><span id="L-962"><a href="#L-962"><span class="linenos">962</span></a>        <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>

        </details>

            </section>
                <section id="Embedder">
                                <div class="attr class">
        <a class="headerlink" href="#Embedder">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">Embedder</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embedder-29"><a href="#Embedder-29"><span class="linenos"> 29</span></a><span class="k">class</span> <span class="nc">Embedder</span><span class="p">:</span>
</span><span id="Embedder-30"><a href="#Embedder-30"><span class="linenos"> 30</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-31"><a href="#Embedder-31"><span class="linenos"> 31</span></a><span class="sd">    `Embedder` is responsible for preprocessing secret message and</span>
</span><span id="Embedder-32"><a href="#Embedder-32"><span class="linenos"> 32</span></a><span class="sd">    embedding it.</span>
</span><span id="Embedder-33"><a href="#Embedder-33"><span class="linenos"> 33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Embedder-34"><a href="#Embedder-34"><span class="linenos"> 34</span></a>    
</span><span id="Embedder-35"><a href="#Embedder-35"><span class="linenos"> 35</span></a>    <span class="n">__b_passwd</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Embedder-36"><a href="#Embedder-36"><span class="linenos"> 36</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-37"><a href="#Embedder-37"><span class="linenos"> 37</span></a><span class="sd">    Storage of given password in bytes.</span>
</span><span id="Embedder-38"><a href="#Embedder-38"><span class="linenos"> 38</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Embedder-39"><a href="#Embedder-39"><span class="linenos"> 39</span></a>    
</span><span id="Embedder-40"><a href="#Embedder-40"><span class="linenos"> 40</span></a>    
</span><span id="Embedder-41"><a href="#Embedder-41"><span class="linenos"> 41</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-42"><a href="#Embedder-42"><span class="linenos"> 42</span></a>    <span class="k">def</span> <span class="nf">get_secret_data</span><span class="p">(</span><span class="n">secret_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="Embedder-43"><a href="#Embedder-43"><span class="linenos"> 43</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-44"><a href="#Embedder-44"><span class="linenos"> 44</span></a><span class="sd">        Parse given secret message. If file path was given, content of</span>
</span><span id="Embedder-45"><a href="#Embedder-45"><span class="linenos"> 45</span></a><span class="sd">        it is going to be converted to bytes and embedded, and file</span>
</span><span id="Embedder-46"><a href="#Embedder-46"><span class="linenos"> 46</span></a><span class="sd">        extension is parsed and converted as well. If only string was</span>
</span><span id="Embedder-47"><a href="#Embedder-47"><span class="linenos"> 47</span></a><span class="sd">        given it&#39;s coverted to bytes as well, and file extension txt</span>
</span><span id="Embedder-48"><a href="#Embedder-48"><span class="linenos"> 48</span></a><span class="sd">        will be embedded.</span>
</span><span id="Embedder-49"><a href="#Embedder-49"><span class="linenos"> 49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-50"><a href="#Embedder-50"><span class="linenos"> 50</span></a>        
</span><span id="Embedder-51"><a href="#Embedder-51"><span class="linenos"> 51</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">secret_message</span><span class="p">):</span>
</span><span id="Embedder-52"><a href="#Embedder-52"><span class="linenos"> 52</span></a>            <span class="c1"># The whole file is going to be embedded.</span>
</span><span id="Embedder-53"><a href="#Embedder-53"><span class="linenos"> 53</span></a>            <span class="n">b_fext</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_file_extension</span><span class="p">(</span><span class="n">secret_message</span><span class="p">)</span>
</span><span id="Embedder-54"><a href="#Embedder-54"><span class="linenos"> 54</span></a>            
</span><span id="Embedder-55"><a href="#Embedder-55"><span class="linenos"> 55</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Embedder-56"><a href="#Embedder-56"><span class="linenos"> 56</span></a>                <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">secret_message</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
</span><span id="Embedder-57"><a href="#Embedder-57"><span class="linenos"> 57</span></a>            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="Embedder-58"><a href="#Embedder-58"><span class="linenos"> 58</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR! Can not access file of embedding data: </span><span class="si">{args.secret_message}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder-59"><a href="#Embedder-59"><span class="linenos"> 59</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="Embedder-60"><a href="#Embedder-60"><span class="linenos"> 60</span></a>            
</span><span id="Embedder-61"><a href="#Embedder-61"><span class="linenos"> 61</span></a>            <span class="n">b_secret_data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Embedder-62"><a href="#Embedder-62"><span class="linenos"> 62</span></a>            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Embedder-63"><a href="#Embedder-63"><span class="linenos"> 63</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-64"><a href="#Embedder-64"><span class="linenos"> 64</span></a>            <span class="c1"># Embedded will be just string.</span>
</span><span id="Embedder-65"><a href="#Embedder-65"><span class="linenos"> 65</span></a>            <span class="n">b_secret_data</span> <span class="o">=</span> <span class="n">secret_message</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="Embedder-66"><a href="#Embedder-66"><span class="linenos"> 66</span></a>            <span class="c1"># If no file was given, txt extension will be used (8 bytes).</span>
</span><span id="Embedder-67"><a href="#Embedder-67"><span class="linenos"> 67</span></a>            <span class="n">b_fext</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;txt&#39;</span>
</span><span id="Embedder-68"><a href="#Embedder-68"><span class="linenos"> 68</span></a>            <span class="n">b_fext</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_fext</span><span class="p">))</span>
</span><span id="Embedder-69"><a href="#Embedder-69"><span class="linenos"> 69</span></a>        
</span><span id="Embedder-70"><a href="#Embedder-70"><span class="linenos"> 70</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">b_secret_data</span><span class="p">,</span> <span class="n">b_fext</span><span class="p">)</span>
</span><span id="Embedder-71"><a href="#Embedder-71"><span class="linenos"> 71</span></a>    
</span><span id="Embedder-72"><a href="#Embedder-72"><span class="linenos"> 72</span></a>    
</span><span id="Embedder-73"><a href="#Embedder-73"><span class="linenos"> 73</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-74"><a href="#Embedder-74"><span class="linenos"> 74</span></a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder-75"><a href="#Embedder-75"><span class="linenos"> 75</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-76"><a href="#Embedder-76"><span class="linenos"> 76</span></a><span class="sd">        Compress given bytes with LZMA algorithm.</span>
</span><span id="Embedder-77"><a href="#Embedder-77"><span class="linenos"> 77</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-78"><a href="#Embedder-78"><span class="linenos"> 78</span></a>        
</span><span id="Embedder-79"><a href="#Embedder-79"><span class="linenos"> 79</span></a>        <span class="n">lzc</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMACompressor</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">lzma</span><span class="o">.</span><span class="n">FORMAT_XZ</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Embedder-80"><a href="#Embedder-80"><span class="linenos"> 80</span></a>        
</span><span id="Embedder-81"><a href="#Embedder-81"><span class="linenos"> 81</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Embedder-82"><a href="#Embedder-82"><span class="linenos"> 82</span></a>            <span class="n">b_comp1</span> <span class="o">=</span> <span class="n">lzc</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="Embedder-83"><a href="#Embedder-83"><span class="linenos"> 83</span></a>        <span class="k">except</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMAError</span><span class="p">:</span>
</span><span id="Embedder-84"><a href="#Embedder-84"><span class="linenos"> 84</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR! While preprocessing secret message an error occured.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder-85"><a href="#Embedder-85"><span class="linenos"> 85</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="Embedder-86"><a href="#Embedder-86"><span class="linenos"> 86</span></a>        
</span><span id="Embedder-87"><a href="#Embedder-87"><span class="linenos"> 87</span></a>        <span class="n">b_comp2</span> <span class="o">=</span> <span class="n">lzc</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="Embedder-88"><a href="#Embedder-88"><span class="linenos"> 88</span></a>        
</span><span id="Embedder-89"><a href="#Embedder-89"><span class="linenos"> 89</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">b_comp1</span> <span class="o">+</span> <span class="n">b_comp2</span><span class="p">)</span>
</span><span id="Embedder-90"><a href="#Embedder-90"><span class="linenos"> 90</span></a>    
</span><span id="Embedder-91"><a href="#Embedder-91"><span class="linenos"> 91</span></a>    
</span><span id="Embedder-92"><a href="#Embedder-92"><span class="linenos"> 92</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder-93"><a href="#Embedder-93"><span class="linenos"> 93</span></a>    <span class="k">def</span> <span class="nf">encrypt_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">passwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder-94"><a href="#Embedder-94"><span class="linenos"> 94</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-95"><a href="#Embedder-95"><span class="linenos"> 95</span></a><span class="sd">        Encrypt given data in bytes with given password.</span>
</span><span id="Embedder-96"><a href="#Embedder-96"><span class="linenos"> 96</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-97"><a href="#Embedder-97"><span class="linenos"> 97</span></a>        <span class="n">b_key</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">gen_key_from_passwd</span><span class="p">(</span><span class="n">passwd</span><span class="p">)</span>
</span><span id="Embedder-98"><a href="#Embedder-98"><span class="linenos"> 98</span></a>        <span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">b_key</span><span class="p">)</span>
</span><span id="Embedder-99"><a href="#Embedder-99"><span class="linenos"> 99</span></a>        <span class="n">b_encrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Embedder-100"><a href="#Embedder-100"><span class="linenos">100</span></a>        
</span><span id="Embedder-101"><a href="#Embedder-101"><span class="linenos">101</span></a>        <span class="k">return</span> <span class="n">b_encrypted</span>
</span><span id="Embedder-102"><a href="#Embedder-102"><span class="linenos">102</span></a>    
</span><span id="Embedder-103"><a href="#Embedder-103"><span class="linenos">103</span></a>    
</span><span id="Embedder-104"><a href="#Embedder-104"><span class="linenos">104</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder-105"><a href="#Embedder-105"><span class="linenos">105</span></a>    <span class="k">def</span> <span class="nf">xor_data_len</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder-106"><a href="#Embedder-106"><span class="linenos">106</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-107"><a href="#Embedder-107"><span class="linenos">107</span></a><span class="sd">        Function returns XORed length of embedding data.</span>
</span><span id="Embedder-108"><a href="#Embedder-108"><span class="linenos">108</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-109"><a href="#Embedder-109"><span class="linenos">109</span></a>
</span><span id="Embedder-110"><a href="#Embedder-110"><span class="linenos">110</span></a>        <span class="c1"># Must be in bytes, because password is in the bytes as well.</span>
</span><span id="Embedder-111"><a href="#Embedder-111"><span class="linenos">111</span></a>        <span class="n">b_encrypted_len</span> <span class="o">=</span> \
</span><span id="Embedder-112"><a href="#Embedder-112"><span class="linenos">112</span></a>           <span class="nb">len</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="Embedder-113"><a href="#Embedder-113"><span class="linenos">113</span></a>        
</span><span id="Embedder-114"><a href="#Embedder-114"><span class="linenos">114</span></a>        <span class="c1"># Prepare password length ONLY for XOR operation.</span>
</span><span id="Embedder-115"><a href="#Embedder-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">:</span>
</span><span id="Embedder-116"><a href="#Embedder-116"><span class="linenos">116</span></a>            <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span>
</span><span id="Embedder-117"><a href="#Embedder-117"><span class="linenos">117</span></a>            <span class="n">b_passwd</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">))</span>
</span><span id="Embedder-118"><a href="#Embedder-118"><span class="linenos">118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-119"><a href="#Embedder-119"><span class="linenos">119</span></a>            <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">[:</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">]</span>
</span><span id="Embedder-120"><a href="#Embedder-120"><span class="linenos">120</span></a>
</span><span id="Embedder-121"><a href="#Embedder-121"><span class="linenos">121</span></a>        <span class="c1"># Data length bytes are going to be XORed with password of same</span>
</span><span id="Embedder-122"><a href="#Embedder-122"><span class="linenos">122</span></a>        <span class="c1"># size. If given password is longer, it&#39;s truncated. This is</span>
</span><span id="Embedder-123"><a href="#Embedder-123"><span class="linenos">123</span></a>        <span class="c1"># security reason as if whole password bytes were XORed with null</span>
</span><span id="Embedder-124"><a href="#Embedder-124"><span class="linenos">124</span></a>        <span class="c1"># padding of data length bytes, password characters would map to</span>
</span><span id="Embedder-125"><a href="#Embedder-125"><span class="linenos">125</span></a>        <span class="c1"># the XORed data length and could be readable. Reversed cycle is</span>
</span><span id="Embedder-126"><a href="#Embedder-126"><span class="linenos">126</span></a>        <span class="c1"># used to avoid problem when null byte is in the middle of data.</span>
</span><span id="Embedder-127"><a href="#Embedder-127"><span class="linenos">127</span></a>        <span class="n">null_padding</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Embedder-128"><a href="#Embedder-128"><span class="linenos">128</span></a>        
</span><span id="Embedder-129"><a href="#Embedder-129"><span class="linenos">129</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">b_encrypted_len</span><span class="p">):</span>
</span><span id="Embedder-130"><a href="#Embedder-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder-131"><a href="#Embedder-131"><span class="linenos">131</span></a>                <span class="k">break</span>
</span><span id="Embedder-132"><a href="#Embedder-132"><span class="linenos">132</span></a>            <span class="n">null_padding</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Embedder-133"><a href="#Embedder-133"><span class="linenos">133</span></a>        
</span><span id="Embedder-134"><a href="#Embedder-134"><span class="linenos">134</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="n">null_padding</span>
</span><span id="Embedder-135"><a href="#Embedder-135"><span class="linenos">135</span></a>        
</span><span id="Embedder-136"><a href="#Embedder-136"><span class="linenos">136</span></a>        <span class="n">b_xored_len</span> <span class="o">=</span> \
</span><span id="Embedder-137"><a href="#Embedder-137"><span class="linenos">137</span></a>            <span class="nb">bytes</span><span class="p">([</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">b_encrypted_len</span><span class="p">,</span> <span class="n">b_passwd</span><span class="p">[:</span><span class="n">i</span><span class="p">])])</span>
</span><span id="Embedder-138"><a href="#Embedder-138"><span class="linenos">138</span></a>        
</span><span id="Embedder-139"><a href="#Embedder-139"><span class="linenos">139</span></a>        <span class="c1"># Add null bytes after XOR.</span>
</span><span id="Embedder-140"><a href="#Embedder-140"><span class="linenos">140</span></a>        <span class="n">b_xored_len</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_xored_len</span><span class="p">))</span>
</span><span id="Embedder-141"><a href="#Embedder-141"><span class="linenos">141</span></a>        
</span><span id="Embedder-142"><a href="#Embedder-142"><span class="linenos">142</span></a>        <span class="k">return</span> <span class="n">b_xored_len</span>
</span><span id="Embedder-143"><a href="#Embedder-143"><span class="linenos">143</span></a>    
</span><span id="Embedder-144"><a href="#Embedder-144"><span class="linenos">144</span></a>    
</span><span id="Embedder-145"><a href="#Embedder-145"><span class="linenos">145</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder-146"><a href="#Embedder-146"><span class="linenos">146</span></a>    <span class="k">def</span> <span class="nf">xor_fext</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder-147"><a href="#Embedder-147"><span class="linenos">147</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-148"><a href="#Embedder-148"><span class="linenos">148</span></a><span class="sd">        XOR given file extension in bytes with password and return it.</span>
</span><span id="Embedder-149"><a href="#Embedder-149"><span class="linenos">149</span></a><span class="sd">        &quot;&quot;&quot;</span>   
</span><span id="Embedder-150"><a href="#Embedder-150"><span class="linenos">150</span></a>
</span><span id="Embedder-151"><a href="#Embedder-151"><span class="linenos">151</span></a>        <span class="c1"># XOR only if there is any file extension.</span>
</span><span id="Embedder-152"><a href="#Embedder-152"><span class="linenos">152</span></a>        <span class="k">if</span> <span class="n">fext</span> <span class="o">!=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">):</span>
</span><span id="Embedder-153"><a href="#Embedder-153"><span class="linenos">153</span></a>            <span class="c1"># Prepare password length ONLY for XOR operation.</span>
</span><span id="Embedder-154"><a href="#Embedder-154"><span class="linenos">154</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">:</span>
</span><span id="Embedder-155"><a href="#Embedder-155"><span class="linenos">155</span></a>                <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span>
</span><span id="Embedder-156"><a href="#Embedder-156"><span class="linenos">156</span></a>                <span class="n">b_passwd</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">))</span>
</span><span id="Embedder-157"><a href="#Embedder-157"><span class="linenos">157</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-158"><a href="#Embedder-158"><span class="linenos">158</span></a>                <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">[:</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">]</span>
</span><span id="Embedder-159"><a href="#Embedder-159"><span class="linenos">159</span></a>            
</span><span id="Embedder-160"><a href="#Embedder-160"><span class="linenos">160</span></a>            <span class="c1"># File extension bytes are going to be XORed with password</span>
</span><span id="Embedder-161"><a href="#Embedder-161"><span class="linenos">161</span></a>            <span class="c1"># of same size. If given password is longer, it&#39;s truncated.</span>
</span><span id="Embedder-162"><a href="#Embedder-162"><span class="linenos">162</span></a>            <span class="c1"># This is security reason as if whole password bytes were</span>
</span><span id="Embedder-163"><a href="#Embedder-163"><span class="linenos">163</span></a>            <span class="c1"># XORed with null padding of data length bytes, password</span>
</span><span id="Embedder-164"><a href="#Embedder-164"><span class="linenos">164</span></a>            <span class="c1"># characters would map to the XORed data length and could be</span>
</span><span id="Embedder-165"><a href="#Embedder-165"><span class="linenos">165</span></a>            <span class="c1"># readable. Reversed cycle is used to avoid problem when</span>
</span><span id="Embedder-166"><a href="#Embedder-166"><span class="linenos">166</span></a>            <span class="c1"># null byte is in the middle of data.</span>
</span><span id="Embedder-167"><a href="#Embedder-167"><span class="linenos">167</span></a>            <span class="n">null_padding</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Embedder-168"><a href="#Embedder-168"><span class="linenos">168</span></a>            
</span><span id="Embedder-169"><a href="#Embedder-169"><span class="linenos">169</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">fext</span><span class="p">):</span>
</span><span id="Embedder-170"><a href="#Embedder-170"><span class="linenos">170</span></a>                <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder-171"><a href="#Embedder-171"><span class="linenos">171</span></a>                    <span class="k">break</span>
</span><span id="Embedder-172"><a href="#Embedder-172"><span class="linenos">172</span></a>                <span class="n">null_padding</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Embedder-173"><a href="#Embedder-173"><span class="linenos">173</span></a>            
</span><span id="Embedder-174"><a href="#Embedder-174"><span class="linenos">174</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="n">null_padding</span>
</span><span id="Embedder-175"><a href="#Embedder-175"><span class="linenos">175</span></a>            
</span><span id="Embedder-176"><a href="#Embedder-176"><span class="linenos">176</span></a>            <span class="n">b_xored_fext</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fext</span><span class="p">,</span> <span class="n">b_passwd</span><span class="p">[:</span><span class="n">i</span><span class="p">])])</span>
</span><span id="Embedder-177"><a href="#Embedder-177"><span class="linenos">177</span></a>            
</span><span id="Embedder-178"><a href="#Embedder-178"><span class="linenos">178</span></a>            <span class="c1"># Add null bytes after XOR.</span>
</span><span id="Embedder-179"><a href="#Embedder-179"><span class="linenos">179</span></a>            <span class="n">b_xored_fext</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_xored_fext</span><span class="p">))</span>
</span><span id="Embedder-180"><a href="#Embedder-180"><span class="linenos">180</span></a>            
</span><span id="Embedder-181"><a href="#Embedder-181"><span class="linenos">181</span></a>            <span class="k">return</span> <span class="n">b_xored_fext</span>
</span><span id="Embedder-182"><a href="#Embedder-182"><span class="linenos">182</span></a>        
</span><span id="Embedder-183"><a href="#Embedder-183"><span class="linenos">183</span></a>        <span class="k">return</span> <span class="n">fext</span>
</span><span id="Embedder-184"><a href="#Embedder-184"><span class="linenos">184</span></a>    
</span><span id="Embedder-185"><a href="#Embedder-185"><span class="linenos">185</span></a>    
</span><span id="Embedder-186"><a href="#Embedder-186"><span class="linenos">186</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-187"><a href="#Embedder-187"><span class="linenos">187</span></a>    <span class="k">def</span> <span class="nf">check_cap</span><span class="p">(</span><span class="n">mess_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">Analyzer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Embedder-188"><a href="#Embedder-188"><span class="linenos">188</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-189"><a href="#Embedder-189"><span class="linenos">189</span></a><span class="sd">        Check if message with given length after preprocessing can be</span>
</span><span id="Embedder-190"><a href="#Embedder-190"><span class="linenos">190</span></a><span class="sd">        embedded and exit the program if not.</span>
</span><span id="Embedder-191"><a href="#Embedder-191"><span class="linenos">191</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-192"><a href="#Embedder-192"><span class="linenos">192</span></a>
</span><span id="Embedder-193"><a href="#Embedder-193"><span class="linenos">193</span></a>        <span class="k">if</span> <span class="n">mess_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">min_capacity</span> <span class="o">/</span> <span class="mi">8</span><span class="p">):</span>
</span><span id="Embedder-194"><a href="#Embedder-194"><span class="linenos">194</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR! Capacity of cover-file is not sufficient and data can not be embedded!&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder-195"><a href="#Embedder-195"><span class="linenos">195</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="Embedder-196"><a href="#Embedder-196"><span class="linenos">196</span></a>                
</span><span id="Embedder-197"><a href="#Embedder-197"><span class="linenos">197</span></a>                
</span><span id="Embedder-198"><a href="#Embedder-198"><span class="linenos">198</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-199"><a href="#Embedder-199"><span class="linenos">199</span></a>    <span class="k">def</span> <span class="nf">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">:</span> <span class="n">EqClassesProcessor</span><span class="p">,</span>
</span><span id="Embedder-200"><a href="#Embedder-200"><span class="linenos">200</span></a>                           <span class="n">bits_mess</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Embedder-201"><a href="#Embedder-201"><span class="linenos">201</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-202"><a href="#Embedder-202"><span class="linenos">202</span></a><span class="sd">        Map first bits (of reasonable lenght) from message bits to the</span>
</span><span id="Embedder-203"><a href="#Embedder-203"><span class="linenos">203</span></a><span class="sd">        encoding index of particular equivalent class member index.</span>
</span><span id="Embedder-204"><a href="#Embedder-204"><span class="linenos">204</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-205"><a href="#Embedder-205"><span class="linenos">205</span></a>        
</span><span id="Embedder-206"><a href="#Embedder-206"><span class="linenos">206</span></a>        <span class="n">mem_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">)</span>
</span><span id="Embedder-207"><a href="#Embedder-207"><span class="linenos">207</span></a>        <span class="n">is_power_of_2</span> <span class="o">=</span> <span class="p">(</span><span class="nb">bin</span><span class="p">(</span><span class="n">mem_len</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Embedder-208"><a href="#Embedder-208"><span class="linenos">208</span></a>
</span><span id="Embedder-209"><a href="#Embedder-209"><span class="linenos">209</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_power_of_2</span><span class="p">:</span>
</span><span id="Embedder-210"><a href="#Embedder-210"><span class="linenos">210</span></a>            <span class="c1"># If variable length encoding was used, 1st try is to take</span>
</span><span id="Embedder-211"><a href="#Embedder-211"><span class="linenos">211</span></a>            <span class="c1"># maximum number of bits that can be embedded by current</span>
</span><span id="Embedder-212"><a href="#Embedder-212"><span class="linenos">212</span></a>            <span class="c1"># equivalent class.</span>
</span><span id="Embedder-213"><a href="#Embedder-213"><span class="linenos">213</span></a>            <span class="n">max_bits</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">mem_len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Embedder-214"><a href="#Embedder-214"><span class="linenos">214</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-215"><a href="#Embedder-215"><span class="linenos">215</span></a>            <span class="c1"># Fixed length encoding was used, therefore only max. number</span>
</span><span id="Embedder-216"><a href="#Embedder-216"><span class="linenos">216</span></a>            <span class="c1"># of bits will be tested.</span>
</span><span id="Embedder-217"><a href="#Embedder-217"><span class="linenos">217</span></a>            <span class="n">max_bits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">mem_len</span><span class="p">))</span>
</span><span id="Embedder-218"><a href="#Embedder-218"><span class="linenos">218</span></a>        
</span><span id="Embedder-219"><a href="#Embedder-219"><span class="linenos">219</span></a>        <span class="c1"># Correctness of message length if last bits are going to be</span>
</span><span id="Embedder-220"><a href="#Embedder-220"><span class="linenos">220</span></a>        <span class="c1"># embedded - zeros padding.</span>
</span><span id="Embedder-221"><a href="#Embedder-221"><span class="linenos">221</span></a>        <span class="n">added_nulls</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Embedder-222"><a href="#Embedder-222"><span class="linenos">222</span></a>        <span class="k">if</span> <span class="n">max_bits</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_mess</span><span class="p">):</span>
</span><span id="Embedder-223"><a href="#Embedder-223"><span class="linenos">223</span></a>            <span class="n">added_nulls</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">max_bits</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_mess</span><span class="p">))</span>
</span><span id="Embedder-224"><a href="#Embedder-224"><span class="linenos">224</span></a>            <span class="n">added_nulls</span><span class="o">.</span><span class="n">setall</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Embedder-225"><a href="#Embedder-225"><span class="linenos">225</span></a>            <span class="n">bits_mess</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">added_nulls</span><span class="p">)</span>
</span><span id="Embedder-226"><a href="#Embedder-226"><span class="linenos">226</span></a>        
</span><span id="Embedder-227"><a href="#Embedder-227"><span class="linenos">227</span></a>        <span class="c1"># 1st try to find appropriate encoding with max. allowed length</span>
</span><span id="Embedder-228"><a href="#Embedder-228"><span class="linenos">228</span></a>        <span class="c1"># and also the only one try if fixed length encoding was used.</span>
</span><span id="Embedder-229"><a href="#Embedder-229"><span class="linenos">229</span></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">encoded_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">):</span>
</span><span id="Embedder-230"><a href="#Embedder-230"><span class="linenos">230</span></a>            <span class="k">if</span> <span class="n">encoded_idx</span> <span class="o">==</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="n">max_bits</span><span class="p">]:</span>
</span><span id="Embedder-231"><a href="#Embedder-231"><span class="linenos">231</span></a>                <span class="k">return</span> <span class="n">idx</span>
</span><span id="Embedder-232"><a href="#Embedder-232"><span class="linenos">232</span></a>
</span><span id="Embedder-233"><a href="#Embedder-233"><span class="linenos">233</span></a>        <span class="c1"># 2nd try to find appropriate encoding with min. allowed length.</span>
</span><span id="Embedder-234"><a href="#Embedder-234"><span class="linenos">234</span></a>        <span class="c1"># This has to always find useable encoding, if 1st try was</span>
</span><span id="Embedder-235"><a href="#Embedder-235"><span class="linenos">235</span></a>        <span class="c1"># unsuccessful, in case of variable length encoding.</span>
</span><span id="Embedder-236"><a href="#Embedder-236"><span class="linenos">236</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_power_of_2</span><span class="p">:</span>
</span><span id="Embedder-237"><a href="#Embedder-237"><span class="linenos">237</span></a>            <span class="n">min_bits</span> <span class="o">=</span> <span class="n">max_bits</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="Embedder-238"><a href="#Embedder-238"><span class="linenos">238</span></a>            
</span><span id="Embedder-239"><a href="#Embedder-239"><span class="linenos">239</span></a>            <span class="c1"># Pop zero padding if was added.</span>
</span><span id="Embedder-240"><a href="#Embedder-240"><span class="linenos">240</span></a>            <span class="k">if</span> <span class="n">added_nulls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Embedder-241"><a href="#Embedder-241"><span class="linenos">241</span></a>                <span class="n">bits_mess</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="Embedder-242"><a href="#Embedder-242"><span class="linenos">242</span></a>            
</span><span id="Embedder-243"><a href="#Embedder-243"><span class="linenos">243</span></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">encoded_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">):</span>
</span><span id="Embedder-244"><a href="#Embedder-244"><span class="linenos">244</span></a>                <span class="k">if</span> <span class="n">encoded_idx</span> <span class="o">==</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="n">min_bits</span><span class="p">]:</span>
</span><span id="Embedder-245"><a href="#Embedder-245"><span class="linenos">245</span></a>                    <span class="k">return</span> <span class="n">idx</span>
</span><span id="Embedder-246"><a href="#Embedder-246"><span class="linenos">246</span></a>            
</span><span id="Embedder-247"><a href="#Embedder-247"><span class="linenos">247</span></a>            
</span><span id="Embedder-248"><a href="#Embedder-248"><span class="linenos">248</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-249"><a href="#Embedder-249"><span class="linenos">249</span></a>    <span class="k">def</span> <span class="nf">__get_rex_idx</span><span class="p">(</span><span class="n">instr_fromf</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Embedder-250"><a href="#Embedder-250"><span class="linenos">250</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-251"><a href="#Embedder-251"><span class="linenos">251</span></a><span class="sd">        REX prefix, if present, is placed immediately before opcode,</span>
</span><span id="Embedder-252"><a href="#Embedder-252"><span class="linenos">252</span></a><span class="sd">        return its index within whole instruction bytes.</span>
</span><span id="Embedder-253"><a href="#Embedder-253"><span class="linenos">253</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-254"><a href="#Embedder-254"><span class="linenos">254</span></a>        
</span><span id="Embedder-255"><a href="#Embedder-255"><span class="linenos">255</span></a>        <span class="k">if</span> <span class="n">opcode_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder-256"><a href="#Embedder-256"><span class="linenos">256</span></a>            <span class="c1"># Try to find out if REX prefix is present.</span>
</span><span id="Embedder-257"><a href="#Embedder-257"><span class="linenos">257</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">opcode_idx</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="Embedder-258"><a href="#Embedder-258"><span class="linenos">258</span></a>            <span class="n">rex</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder-259"><a href="#Embedder-259"><span class="linenos">259</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="Embedder-260"><a href="#Embedder-260"><span class="linenos">260</span></a>                <span class="c1"># Check if there is any more byte opcode prefix (LEGACY).</span>
</span><span id="Embedder-261"><a href="#Embedder-261"><span class="linenos">261</span></a>                <span class="k">if</span> <span class="n">instr_fromf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x0f</span><span class="s2">&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder-262"><a href="#Embedder-262"><span class="linenos">262</span></a>                    <span class="n">instr_fromf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x38</span><span class="s2">&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder-263"><a href="#Embedder-263"><span class="linenos">263</span></a>                    <span class="n">instr_fromf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\x3a</span><span class="s2">&quot;</span><span class="p">:</span>
</span><span id="Embedder-264"><a href="#Embedder-264"><span class="linenos">264</span></a>
</span><span id="Embedder-265"><a href="#Embedder-265"><span class="linenos">265</span></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder-266"><a href="#Embedder-266"><span class="linenos">266</span></a>                        <span class="c1"># There is no REX, only more bytes long opcode.</span>
</span><span id="Embedder-267"><a href="#Embedder-267"><span class="linenos">267</span></a>                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Embedder-268"><a href="#Embedder-268"><span class="linenos">268</span></a>                    <span class="c1"># Go and check next byte.</span>
</span><span id="Embedder-269"><a href="#Embedder-269"><span class="linenos">269</span></a>                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="Embedder-270"><a href="#Embedder-270"><span class="linenos">270</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-271"><a href="#Embedder-271"><span class="linenos">271</span></a>                    <span class="c1"># Here must be REX prefix, if not REX is not present.</span>
</span><span id="Embedder-272"><a href="#Embedder-272"><span class="linenos">272</span></a>                    <span class="n">rex</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">instr_fromf</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span><span id="Embedder-273"><a href="#Embedder-273"><span class="linenos">273</span></a>                    <span class="k">if</span> <span class="n">rex</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;0100&#39;</span><span class="p">):</span>
</span><span id="Embedder-274"><a href="#Embedder-274"><span class="linenos">274</span></a>                        <span class="c1"># Found REX prefix.</span>
</span><span id="Embedder-275"><a href="#Embedder-275"><span class="linenos">275</span></a>                        <span class="k">return</span> <span class="n">i</span>
</span><span id="Embedder-276"><a href="#Embedder-276"><span class="linenos">276</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-277"><a href="#Embedder-277"><span class="linenos">277</span></a>                        <span class="c1"># There is no REX prefix.</span>
</span><span id="Embedder-278"><a href="#Embedder-278"><span class="linenos">278</span></a>                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Embedder-279"><a href="#Embedder-279"><span class="linenos">279</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-280"><a href="#Embedder-280"><span class="linenos">280</span></a>            <span class="c1"># There is no REX prefix.</span>
</span><span id="Embedder-281"><a href="#Embedder-281"><span class="linenos">281</span></a>            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="Embedder-282"><a href="#Embedder-282"><span class="linenos">282</span></a>    
</span><span id="Embedder-283"><a href="#Embedder-283"><span class="linenos">283</span></a>    
</span><span id="Embedder-284"><a href="#Embedder-284"><span class="linenos">284</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-285"><a href="#Embedder-285"><span class="linenos">285</span></a>    <span class="k">def</span> <span class="nf">__can_schedule_mov</span><span class="p">(</span><span class="n">instr_mov0</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span>
</span><span id="Embedder-286"><a href="#Embedder-286"><span class="linenos">286</span></a>                       <span class="n">instr_mov1</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Embedder-287"><a href="#Embedder-287"><span class="linenos">287</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-288"><a href="#Embedder-288"><span class="linenos">288</span></a><span class="sd">        Decide if MOVs will be used for embedding - same check will be</span>
</span><span id="Embedder-289"><a href="#Embedder-289"><span class="linenos">289</span></a><span class="sd">        done by extractor.</span>
</span><span id="Embedder-290"><a href="#Embedder-290"><span class="linenos">290</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-291"><a href="#Embedder-291"><span class="linenos">291</span></a>        
</span><span id="Embedder-292"><a href="#Embedder-292"><span class="linenos">292</span></a>        <span class="n">mov0</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr_mov0</span><span class="o">.</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Embedder-293"><a href="#Embedder-293"><span class="linenos">293</span></a>        <span class="n">mov1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr_mov1</span><span class="o">.</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Embedder-294"><a href="#Embedder-294"><span class="linenos">294</span></a>        <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov0</span><span class="p">)</span> <span class="o">==</span> \
</span><span id="Embedder-295"><a href="#Embedder-295"><span class="linenos">295</span></a>            <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov1</span><span class="p">):</span>
</span><span id="Embedder-296"><a href="#Embedder-296"><span class="linenos">296</span></a>            <span class="c1"># It is signing tak they can not be scheduled. It happens</span>
</span><span id="Embedder-297"><a href="#Embedder-297"><span class="linenos">297</span></a>            <span class="c1"># extremely rare.</span>
</span><span id="Embedder-298"><a href="#Embedder-298"><span class="linenos">298</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Embedder-299"><a href="#Embedder-299"><span class="linenos">299</span></a>
</span><span id="Embedder-300"><a href="#Embedder-300"><span class="linenos">300</span></a>        <span class="k">return</span> <span class="kc">True</span>        
</span><span id="Embedder-301"><a href="#Embedder-301"><span class="linenos">301</span></a>    
</span><span id="Embedder-302"><a href="#Embedder-302"><span class="linenos">302</span></a>    
</span><span id="Embedder-303"><a href="#Embedder-303"><span class="linenos">303</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder-304"><a href="#Embedder-304"><span class="linenos">304</span></a>    <span class="k">def</span> <span class="nf">__should_swap_mov</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
</span><span id="Embedder-305"><a href="#Embedder-305"><span class="linenos">305</span></a>                          <span class="n">instr_mov0</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span>
</span><span id="Embedder-306"><a href="#Embedder-306"><span class="linenos">306</span></a>                          <span class="n">instr_mov1</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span>
</span><span id="Embedder-307"><a href="#Embedder-307"><span class="linenos">307</span></a>                          <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Embedder-308"><a href="#Embedder-308"><span class="linenos">308</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-309"><a href="#Embedder-309"><span class="linenos">309</span></a><span class="sd">        Decide if MOV pair should be swapped according to the next</span>
</span><span id="Embedder-310"><a href="#Embedder-310"><span class="linenos">310</span></a><span class="sd">        embedding bit of information.</span>
</span><span id="Embedder-311"><a href="#Embedder-311"><span class="linenos">311</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-312"><a href="#Embedder-312"><span class="linenos">312</span></a>        
</span><span id="Embedder-313"><a href="#Embedder-313"><span class="linenos">313</span></a>        <span class="c1"># Get instruction string.</span>
</span><span id="Embedder-314"><a href="#Embedder-314"><span class="linenos">314</span></a>        <span class="n">mov0</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr_mov0</span><span class="o">.</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Embedder-315"><a href="#Embedder-315"><span class="linenos">315</span></a>        <span class="n">mov1</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr_mov1</span><span class="o">.</span><span class="n">instruction</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Embedder-316"><a href="#Embedder-316"><span class="linenos">316</span></a>        
</span><span id="Embedder-317"><a href="#Embedder-317"><span class="linenos">317</span></a>        <span class="c1"># There is possibility that both will have set only scheduling</span>
</span><span id="Embedder-318"><a href="#Embedder-318"><span class="linenos">318</span></a>        <span class="c1"># flag and then could not be decided what ordering would be</span>
</span><span id="Embedder-319"><a href="#Embedder-319"><span class="linenos">319</span></a>        <span class="c1"># used. Therefore must be accessed to the array of all</span>
</span><span id="Embedder-320"><a href="#Embedder-320"><span class="linenos">320</span></a>        <span class="c1"># equivalent classes and read out configured ordering from file.</span>
</span><span id="Embedder-321"><a href="#Embedder-321"><span class="linenos">321</span></a>        <span class="k">for</span> <span class="n">eq_class</span> <span class="ow">in</span> <span class="n">EqClassesProcessor</span><span class="o">.</span><span class="n">all_eq_classes</span><span class="p">:</span>
</span><span id="Embedder-322"><a href="#Embedder-322"><span class="linenos">322</span></a>            <span class="k">if</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;MOV Scheduling&quot;</span><span class="p">:</span>
</span><span id="Embedder-323"><a href="#Embedder-323"><span class="linenos">323</span></a>                <span class="n">ordering</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder-324"><a href="#Embedder-324"><span class="linenos">324</span></a>        
</span><span id="Embedder-325"><a href="#Embedder-325"><span class="linenos">325</span></a>        <span class="k">if</span> <span class="n">ordering</span> <span class="o">==</span> <span class="s2">&quot;Ascending&quot;</span> <span class="ow">and</span> \
</span><span id="Embedder-326"><a href="#Embedder-326"><span class="linenos">326</span></a>            <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov1</span><span class="p">):</span>
</span><span id="Embedder-327"><a href="#Embedder-327"><span class="linenos">327</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Embedder-328"><a href="#Embedder-328"><span class="linenos">328</span></a>        
</span><span id="Embedder-329"><a href="#Embedder-329"><span class="linenos">329</span></a>        <span class="k">elif</span> <span class="n">ordering</span> <span class="o">==</span> <span class="s2">&quot;Descending&quot;</span> <span class="ow">and</span> \
</span><span id="Embedder-330"><a href="#Embedder-330"><span class="linenos">330</span></a>            <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">common</span><span class="o">.</span><span class="n">lexicographic_mov_sort</span><span class="p">(</span><span class="n">mov1</span><span class="p">):</span>
</span><span id="Embedder-331"><a href="#Embedder-331"><span class="linenos">331</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Embedder-332"><a href="#Embedder-332"><span class="linenos">332</span></a>        
</span><span id="Embedder-333"><a href="#Embedder-333"><span class="linenos">333</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Embedder-334"><a href="#Embedder-334"><span class="linenos">334</span></a>        
</span><span id="Embedder-335"><a href="#Embedder-335"><span class="linenos">335</span></a>        
</span><span id="Embedder-336"><a href="#Embedder-336"><span class="linenos">336</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder-337"><a href="#Embedder-337"><span class="linenos">337</span></a>    <span class="k">def</span> <span class="nf">__should_swap_base_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">instr</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Embedder-338"><a href="#Embedder-338"><span class="linenos">338</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-339"><a href="#Embedder-339"><span class="linenos">339</span></a><span class="sd">        Find out if base and index memory registers should be swapped</span>
</span><span id="Embedder-340"><a href="#Embedder-340"><span class="linenos">340</span></a><span class="sd">        according to desired order determined by next encoding bit of</span>
</span><span id="Embedder-341"><a href="#Embedder-341"><span class="linenos">341</span></a><span class="sd">        message.</span>
</span><span id="Embedder-342"><a href="#Embedder-342"><span class="linenos">342</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-343"><a href="#Embedder-343"><span class="linenos">343</span></a>
</span><span id="Embedder-344"><a href="#Embedder-344"><span class="linenos">344</span></a>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Ascending&quot;</span> <span class="ow">and</span> \
</span><span id="Embedder-345"><a href="#Embedder-345"><span class="linenos">345</span></a>            <span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">memory_base</span> <span class="o">&gt;</span> <span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">memory_index</span><span class="p">:</span>
</span><span id="Embedder-346"><a href="#Embedder-346"><span class="linenos">346</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Embedder-347"><a href="#Embedder-347"><span class="linenos">347</span></a>        
</span><span id="Embedder-348"><a href="#Embedder-348"><span class="linenos">348</span></a>        <span class="k">elif</span> <span class="n">instr</span><span class="o">.</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Descending&quot;</span> <span class="ow">and</span> \
</span><span id="Embedder-349"><a href="#Embedder-349"><span class="linenos">349</span></a>            <span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">memory_base</span> <span class="o">&lt;</span> <span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">memory_index</span><span class="p">:</span>
</span><span id="Embedder-350"><a href="#Embedder-350"><span class="linenos">350</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="Embedder-351"><a href="#Embedder-351"><span class="linenos">351</span></a>        
</span><span id="Embedder-352"><a href="#Embedder-352"><span class="linenos">352</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="Embedder-353"><a href="#Embedder-353"><span class="linenos">353</span></a>
</span><span id="Embedder-354"><a href="#Embedder-354"><span class="linenos">354</span></a>
</span><span id="Embedder-355"><a href="#Embedder-355"><span class="linenos">355</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-356"><a href="#Embedder-356"><span class="linenos">356</span></a>    <span class="k">def</span> <span class="nf">__swap_base_index</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Embedder-357"><a href="#Embedder-357"><span class="linenos">357</span></a>                          <span class="n">opcode_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Embedder-358"><a href="#Embedder-358"><span class="linenos">358</span></a>                          <span class="n">bits_instr</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="Embedder-359"><a href="#Embedder-359"><span class="linenos">359</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-360"><a href="#Embedder-360"><span class="linenos">360</span></a><span class="sd">        Last parameter of function is going to be changed and then</span>
</span><span id="Embedder-361"><a href="#Embedder-361"><span class="linenos">361</span></a><span class="sd">        will be used outside function.</span>
</span><span id="Embedder-362"><a href="#Embedder-362"><span class="linenos">362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-363"><a href="#Embedder-363"><span class="linenos">363</span></a>        
</span><span id="Embedder-364"><a href="#Embedder-364"><span class="linenos">364</span></a>        <span class="c1"># First, swap REX prefix bits if available.</span>
</span><span id="Embedder-365"><a href="#Embedder-365"><span class="linenos">365</span></a>        <span class="k">if</span> <span class="n">rex_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Embedder-366"><a href="#Embedder-366"><span class="linenos">366</span></a>            <span class="c1"># There was REX prefix detected.</span>
</span><span id="Embedder-367"><a href="#Embedder-367"><span class="linenos">367</span></a>            <span class="n">rex_b_bit_offset</span> <span class="o">=</span> <span class="n">rex_idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span>
</span><span id="Embedder-368"><a href="#Embedder-368"><span class="linenos">368</span></a>            <span class="n">rex_b_bit</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_b_bit_offset</span><span class="p">]</span>
</span><span id="Embedder-369"><a href="#Embedder-369"><span class="linenos">369</span></a>            <span class="n">rex_x_bit_offset</span> <span class="o">=</span> <span class="n">rex_idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="Embedder-370"><a href="#Embedder-370"><span class="linenos">370</span></a>            <span class="n">rex_x_bit</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_x_bit_offset</span><span class="p">]</span>
</span><span id="Embedder-371"><a href="#Embedder-371"><span class="linenos">371</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_b_bit_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">rex_x_bit</span>
</span><span id="Embedder-372"><a href="#Embedder-372"><span class="linenos">372</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_x_bit_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">rex_b_bit</span>
</span><span id="Embedder-373"><a href="#Embedder-373"><span class="linenos">373</span></a>        
</span><span id="Embedder-374"><a href="#Embedder-374"><span class="linenos">374</span></a>        <span class="c1"># Second, swap SIB.base and SIB.index registers.</span>
</span><span id="Embedder-375"><a href="#Embedder-375"><span class="linenos">375</span></a>        <span class="n">sib_sign_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="Embedder-376"><a href="#Embedder-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">sib_sign_offset</span><span class="p">:</span><span class="n">sib_sign_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> \
</span><span id="Embedder-377"><a href="#Embedder-377"><span class="linenos">377</span></a>            <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;100&#39;</span><span class="p">):</span>
</span><span id="Embedder-378"><a href="#Embedder-378"><span class="linenos">378</span></a>            <span class="c1"># Just to make sure, that SIB byte is present.</span>
</span><span id="Embedder-379"><a href="#Embedder-379"><span class="linenos">379</span></a>            <span class="n">sib_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span>
</span><span id="Embedder-380"><a href="#Embedder-380"><span class="linenos">380</span></a>            <span class="n">base_offset</span> <span class="o">=</span> <span class="n">sib_offset</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="Embedder-381"><a href="#Embedder-381"><span class="linenos">381</span></a>            <span class="n">index_offset</span> <span class="o">=</span> <span class="n">sib_offset</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="Embedder-382"><a href="#Embedder-382"><span class="linenos">382</span></a>            <span class="n">bits_base</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">base_offset</span><span class="p">:</span><span class="n">base_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="Embedder-383"><a href="#Embedder-383"><span class="linenos">383</span></a>            <span class="n">bits_index</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">index_offset</span><span class="p">:</span><span class="n">index_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span>
</span><span id="Embedder-384"><a href="#Embedder-384"><span class="linenos">384</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">base_offset</span><span class="p">:</span><span class="n">base_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits_index</span>
</span><span id="Embedder-385"><a href="#Embedder-385"><span class="linenos">385</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">index_offset</span><span class="p">:</span><span class="n">index_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits_base</span>
</span><span id="Embedder-386"><a href="#Embedder-386"><span class="linenos">386</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-387"><a href="#Embedder-387"><span class="linenos">387</span></a>            <span class="c1"># Something goes wrong and SIB byte sign is not</span>
</span><span id="Embedder-388"><a href="#Embedder-388"><span class="linenos">388</span></a>            <span class="c1"># ok - instruction is not used for embedding.</span>
</span><span id="Embedder-389"><a href="#Embedder-389"><span class="linenos">389</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="Embedder-390"><a href="#Embedder-390"><span class="linenos">390</span></a>
</span><span id="Embedder-391"><a href="#Embedder-391"><span class="linenos">391</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="Embedder-392"><a href="#Embedder-392"><span class="linenos">392</span></a>    
</span><span id="Embedder-393"><a href="#Embedder-393"><span class="linenos">393</span></a>    
</span><span id="Embedder-394"><a href="#Embedder-394"><span class="linenos">394</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-395"><a href="#Embedder-395"><span class="linenos">395</span></a>    <span class="k">def</span> <span class="nf">__swap_rm_r_operands</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Embedder-396"><a href="#Embedder-396"><span class="linenos">396</span></a>                             <span class="n">opcode_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Embedder-397"><a href="#Embedder-397"><span class="linenos">397</span></a>                             <span class="n">bits_instr</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Embedder-398"><a href="#Embedder-398"><span class="linenos">398</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-399"><a href="#Embedder-399"><span class="linenos">399</span></a><span class="sd">        Last parameter of function is going to be changed and then</span>
</span><span id="Embedder-400"><a href="#Embedder-400"><span class="linenos">400</span></a><span class="sd">        will be used outside function.</span>
</span><span id="Embedder-401"><a href="#Embedder-401"><span class="linenos">401</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-402"><a href="#Embedder-402"><span class="linenos">402</span></a>        
</span><span id="Embedder-403"><a href="#Embedder-403"><span class="linenos">403</span></a>        <span class="c1"># First, swap REX prefix bits if available.</span>
</span><span id="Embedder-404"><a href="#Embedder-404"><span class="linenos">404</span></a>        <span class="k">if</span> <span class="n">rex_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="Embedder-405"><a href="#Embedder-405"><span class="linenos">405</span></a>            <span class="c1"># There was REX prefix detected.</span>
</span><span id="Embedder-406"><a href="#Embedder-406"><span class="linenos">406</span></a>            <span class="n">rex_b_bit_offset</span> <span class="o">=</span> <span class="n">rex_idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span>
</span><span id="Embedder-407"><a href="#Embedder-407"><span class="linenos">407</span></a>            <span class="n">rex_b_bit</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_b_bit_offset</span><span class="p">]</span>
</span><span id="Embedder-408"><a href="#Embedder-408"><span class="linenos">408</span></a>            <span class="n">rex_r_bit_offset</span> <span class="o">=</span> <span class="n">rex_idx</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="Embedder-409"><a href="#Embedder-409"><span class="linenos">409</span></a>            <span class="n">rex_r_bit</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_r_bit_offset</span><span class="p">]</span>
</span><span id="Embedder-410"><a href="#Embedder-410"><span class="linenos">410</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_b_bit_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">rex_r_bit</span>
</span><span id="Embedder-411"><a href="#Embedder-411"><span class="linenos">411</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">rex_r_bit_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">rex_b_bit</span>
</span><span id="Embedder-412"><a href="#Embedder-412"><span class="linenos">412</span></a>        
</span><span id="Embedder-413"><a href="#Embedder-413"><span class="linenos">413</span></a>        <span class="c1"># Locate Reg/Opcode field inside ModR/M byte.</span>
</span><span id="Embedder-414"><a href="#Embedder-414"><span class="linenos">414</span></a>        <span class="n">reg_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="Embedder-415"><a href="#Embedder-415"><span class="linenos">415</span></a>        <span class="n">reg_bits</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span>
</span><span id="Embedder-416"><a href="#Embedder-416"><span class="linenos">416</span></a>        <span class="c1"># Locate rm field inside ModR/M byte.</span>
</span><span id="Embedder-417"><a href="#Embedder-417"><span class="linenos">417</span></a>        <span class="n">rm_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">5</span>
</span><span id="Embedder-418"><a href="#Embedder-418"><span class="linenos">418</span></a>        <span class="n">rm_bits</span> <span class="o">=</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">rm_field_offset</span><span class="p">:(</span><span class="n">rm_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span>
</span><span id="Embedder-419"><a href="#Embedder-419"><span class="linenos">419</span></a>        
</span><span id="Embedder-420"><a href="#Embedder-420"><span class="linenos">420</span></a>        <span class="c1"># Rewrite required Reg/Opcode field bits inside instruction.</span>
</span><span id="Embedder-421"><a href="#Embedder-421"><span class="linenos">421</span></a>        <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rm_bits</span>
</span><span id="Embedder-422"><a href="#Embedder-422"><span class="linenos">422</span></a>        <span class="c1"># Rewrite required rm field bits inside instruction.</span>
</span><span id="Embedder-423"><a href="#Embedder-423"><span class="linenos">423</span></a>        <span class="n">bits_instr</span><span class="p">[</span><span class="n">rm_field_offset</span><span class="p">:(</span><span class="n">rm_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">reg_bits</span>
</span><span id="Embedder-424"><a href="#Embedder-424"><span class="linenos">424</span></a>    
</span><span id="Embedder-425"><a href="#Embedder-425"><span class="linenos">425</span></a>    
</span><span id="Embedder-426"><a href="#Embedder-426"><span class="linenos">426</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-427"><a href="#Embedder-427"><span class="linenos">427</span></a>    <span class="k">def</span> <span class="nf">__create_opcode</span><span class="p">(</span><span class="n">instr</span><span class="p">:</span> <span class="n">MyInstruction</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder-428"><a href="#Embedder-428"><span class="linenos">428</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-429"><a href="#Embedder-429"><span class="linenos">429</span></a><span class="sd">        Create desired OPCODE for instructions of equivalent classes</span>
</span><span id="Embedder-430"><a href="#Embedder-430"><span class="linenos">430</span></a><span class="sd">        &#39;TEST/AND/OR&#39; and &#39;SUB/XOR&#39;.</span>
</span><span id="Embedder-431"><a href="#Embedder-431"><span class="linenos">431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-432"><a href="#Embedder-432"><span class="linenos">432</span></a>        
</span><span id="Embedder-433"><a href="#Embedder-433"><span class="linenos">433</span></a>        <span class="k">if</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">operand_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder-434"><a href="#Embedder-434"><span class="linenos">434</span></a>            <span class="c1"># Correctness of OPCODE if 1 byte operand.</span>
</span><span id="Embedder-435"><a href="#Embedder-435"><span class="linenos">435</span></a>            <span class="n">new_opcode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:],</span> <span class="mi">16</span><span class="p">)</span>
</span><span id="Embedder-436"><a href="#Embedder-436"><span class="linenos">436</span></a>            <span class="n">new_opcode</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="Embedder-437"><a href="#Embedder-437"><span class="linenos">437</span></a>            <span class="n">b_new_opcode</span> <span class="o">=</span> <span class="n">new_opcode</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">instruction</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code_len</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="Embedder-438"><a href="#Embedder-438"><span class="linenos">438</span></a>            
</span><span id="Embedder-439"><a href="#Embedder-439"><span class="linenos">439</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-440"><a href="#Embedder-440"><span class="linenos">440</span></a>            <span class="c1"># Without any correctness, only get OPCODE from</span>
</span><span id="Embedder-441"><a href="#Embedder-441"><span class="linenos">441</span></a>            <span class="c1"># class member.</span>
</span><span id="Embedder-442"><a href="#Embedder-442"><span class="linenos">442</span></a>            <span class="n">b_new_opcode</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span>
</span><span id="Embedder-443"><a href="#Embedder-443"><span class="linenos">443</span></a>            
</span><span id="Embedder-444"><a href="#Embedder-444"><span class="linenos">444</span></a>        <span class="k">return</span> <span class="n">b_new_opcode</span>
</span><span id="Embedder-445"><a href="#Embedder-445"><span class="linenos">445</span></a>
</span><span id="Embedder-446"><a href="#Embedder-446"><span class="linenos">446</span></a>
</span><span id="Embedder-447"><a href="#Embedder-447"><span class="linenos">447</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-448"><a href="#Embedder-448"><span class="linenos">448</span></a>    <span class="k">def</span> <span class="nf">__make_ADD_SUB_opcode</span><span class="p">(</span><span class="n">instr</span><span class="p">:</span> <span class="n">Instruction</span><span class="p">,</span>
</span><span id="Embedder-449"><a href="#Embedder-449"><span class="linenos">449</span></a>                                <span class="n">opcode_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="Embedder-450"><a href="#Embedder-450"><span class="linenos">450</span></a>                                <span class="n">bits_to_embed</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">,</span>
</span><span id="Embedder-451"><a href="#Embedder-451"><span class="linenos">451</span></a>                                <span class="n">bits_instr</span><span class="p">:</span> <span class="n">bitarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Embedder-452"><a href="#Embedder-452"><span class="linenos">452</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-453"><a href="#Embedder-453"><span class="linenos">453</span></a><span class="sd">        Embed ADD or SUB OPCODE according to the next encoding bits.</span>
</span><span id="Embedder-454"><a href="#Embedder-454"><span class="linenos">454</span></a><span class="sd">        There is special case of AL register operand when OPCODES of</span>
</span><span id="Embedder-455"><a href="#Embedder-455"><span class="linenos">455</span></a><span class="sd">        ADD and SUB differ and they must be changed. Also, in this</span>
</span><span id="Embedder-456"><a href="#Embedder-456"><span class="linenos">456</span></a><span class="sd">        case there is no ModR/M byte, so Reg/Opcode can not be</span>
</span><span id="Embedder-457"><a href="#Embedder-457"><span class="linenos">457</span></a><span class="sd">        modified. Otherwise, OPCODES stay same and Reg/Opcode field of</span>
</span><span id="Embedder-458"><a href="#Embedder-458"><span class="linenos">458</span></a><span class="sd">        ModR/M byte is changed only.</span>
</span><span id="Embedder-459"><a href="#Embedder-459"><span class="linenos">459</span></a><span class="sd">        Last parameter of function is going to be changed and then</span>
</span><span id="Embedder-460"><a href="#Embedder-460"><span class="linenos">460</span></a><span class="sd">        will be used outside function.</span>
</span><span id="Embedder-461"><a href="#Embedder-461"><span class="linenos">461</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-462"><a href="#Embedder-462"><span class="linenos">462</span></a>        
</span><span id="Embedder-463"><a href="#Embedder-463"><span class="linenos">463</span></a>        <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">op0_kind</span> <span class="o">==</span> <span class="n">OpKind</span><span class="o">.</span><span class="n">REGISTER</span> <span class="ow">and</span> \
</span><span id="Embedder-464"><a href="#Embedder-464"><span class="linenos">464</span></a>            <span class="n">instr</span><span class="o">.</span><span class="n">op0_register</span> <span class="o">==</span> <span class="n">Register</span><span class="o">.</span><span class="n">AL</span><span class="p">:</span>
</span><span id="Embedder-465"><a href="#Embedder-465"><span class="linenos">465</span></a>            <span class="c1"># Register AL has special OPCODE without ModR/M.</span>
</span><span id="Embedder-466"><a href="#Embedder-466"><span class="linenos">466</span></a>            
</span><span id="Embedder-467"><a href="#Embedder-467"><span class="linenos">467</span></a>            <span class="n">new_opcode</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder-468"><a href="#Embedder-468"><span class="linenos">468</span></a>            <span class="k">if</span> <span class="n">bits_to_embed</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;000&#39;</span><span class="p">):</span>
</span><span id="Embedder-469"><a href="#Embedder-469"><span class="linenos">469</span></a>                <span class="c1"># ADD is going to be embedded.</span>
</span><span id="Embedder-470"><a href="#Embedder-470"><span class="linenos">470</span></a>                <span class="n">new_opcode</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;04&quot;</span><span class="p">))</span>
</span><span id="Embedder-471"><a href="#Embedder-471"><span class="linenos">471</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-472"><a href="#Embedder-472"><span class="linenos">472</span></a>                <span class="c1"># SUB is going to be embedded.</span>
</span><span id="Embedder-473"><a href="#Embedder-473"><span class="linenos">473</span></a>                <span class="n">new_opcode</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&quot;2c&quot;</span><span class="p">))</span>
</span><span id="Embedder-474"><a href="#Embedder-474"><span class="linenos">474</span></a>            
</span><span id="Embedder-475"><a href="#Embedder-475"><span class="linenos">475</span></a>            <span class="n">opcode_offset</span> <span class="o">=</span> <span class="n">opcode_idx</span> <span class="o">*</span> <span class="mi">8</span>
</span><span id="Embedder-476"><a href="#Embedder-476"><span class="linenos">476</span></a>            <span class="n">opcode_len</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code_len</span> <span class="o">*</span> <span class="mi">8</span>
</span><span id="Embedder-477"><a href="#Embedder-477"><span class="linenos">477</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">opcode_offset</span><span class="p">:(</span><span class="n">opcode_offset</span> <span class="o">+</span> <span class="n">opcode_len</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_opcode</span>
</span><span id="Embedder-478"><a href="#Embedder-478"><span class="linenos">478</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-479"><a href="#Embedder-479"><span class="linenos">479</span></a>            <span class="c1"># Locate Reg/Opcode field inside ModR/M byte.</span>
</span><span id="Embedder-480"><a href="#Embedder-480"><span class="linenos">480</span></a>            <span class="n">reg_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="Embedder-481"><a href="#Embedder-481"><span class="linenos">481</span></a>            <span class="c1"># Rewrite required bits inside instruction.</span>
</span><span id="Embedder-482"><a href="#Embedder-482"><span class="linenos">482</span></a>            <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="n">bits_to_embed</span>
</span><span id="Embedder-483"><a href="#Embedder-483"><span class="linenos">483</span></a>    
</span><span id="Embedder-484"><a href="#Embedder-484"><span class="linenos">484</span></a>    
</span><span id="Embedder-485"><a href="#Embedder-485"><span class="linenos">485</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-486"><a href="#Embedder-486"><span class="linenos">486</span></a>    <span class="k">def</span> <span class="nf">__twos_complement</span><span class="p">(</span><span class="n">instr</span><span class="p">:</span> <span class="n">Instruction</span><span class="p">,</span> <span class="n">op_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder-487"><a href="#Embedder-487"><span class="linenos">487</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-488"><a href="#Embedder-488"><span class="linenos">488</span></a><span class="sd">        Make two&#39;s complement of immediate operand.</span>
</span><span id="Embedder-489"><a href="#Embedder-489"><span class="linenos">489</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-490"><a href="#Embedder-490"><span class="linenos">490</span></a>        
</span><span id="Embedder-491"><a href="#Embedder-491"><span class="linenos">491</span></a>        <span class="n">bits_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:08b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
</span><span id="Embedder-492"><a href="#Embedder-492"><span class="linenos">492</span></a>        <span class="n">flipped_bits_number</span> <span class="o">=</span> <span class="o">~</span> <span class="n">bits_number</span>
</span><span id="Embedder-493"><a href="#Embedder-493"><span class="linenos">493</span></a>        <span class="n">flipped_bits_number</span> <span class="o">=</span> <span class="n">flipped_bits_number</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="Embedder-494"><a href="#Embedder-494"><span class="linenos">494</span></a>        <span class="n">str_twos_complement</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">flipped_bits_number</span><span class="p">)</span>
</span><span id="Embedder-495"><a href="#Embedder-495"><span class="linenos">495</span></a>            
</span><span id="Embedder-496"><a href="#Embedder-496"><span class="linenos">496</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_twos_complement</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span>
</span><span id="Embedder-497"><a href="#Embedder-497"><span class="linenos">497</span></a>            <span class="n">op_size</span><span class="p">,</span>
</span><span id="Embedder-498"><a href="#Embedder-498"><span class="linenos">498</span></a>            <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">,</span>
</span><span id="Embedder-499"><a href="#Embedder-499"><span class="linenos">499</span></a>            <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Embedder-500"><a href="#Embedder-500"><span class="linenos">500</span></a>            
</span><span id="Embedder-501"><a href="#Embedder-501"><span class="linenos">501</span></a>            
</span><span id="Embedder-502"><a href="#Embedder-502"><span class="linenos">502</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder-503"><a href="#Embedder-503"><span class="linenos">503</span></a>    <span class="k">def</span> <span class="nf">__get_imm_idx</span><span class="p">(</span><span class="n">instr_fromf</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">imm</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">op_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Embedder-504"><a href="#Embedder-504"><span class="linenos">504</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-505"><a href="#Embedder-505"><span class="linenos">505</span></a><span class="sd">        Get index position of immediate operand inside instruction.</span>
</span><span id="Embedder-506"><a href="#Embedder-506"><span class="linenos">506</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-507"><a href="#Embedder-507"><span class="linenos">507</span></a>        <span class="n">b_imm</span> <span class="o">=</span> <span class="n">imm</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">op_size</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Embedder-508"><a href="#Embedder-508"><span class="linenos">508</span></a>        
</span><span id="Embedder-509"><a href="#Embedder-509"><span class="linenos">509</span></a>        <span class="k">return</span> <span class="n">instr_fromf</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b_imm</span><span class="p">)</span>
</span><span id="Embedder-510"><a href="#Embedder-510"><span class="linenos">510</span></a>
</span><span id="Embedder-511"><a href="#Embedder-511"><span class="linenos">511</span></a>    
</span><span id="Embedder-512"><a href="#Embedder-512"><span class="linenos">512</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder-513"><a href="#Embedder-513"><span class="linenos">513</span></a>    <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
</span><span id="Embedder-514"><a href="#Embedder-514"><span class="linenos">514</span></a>              <span class="n">fexe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Embedder-515"><a href="#Embedder-515"><span class="linenos">515</span></a>              <span class="n">mess</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="Embedder-516"><a href="#Embedder-516"><span class="linenos">516</span></a>              <span class="n">potential_my_instrs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="Embedder-517"><a href="#Embedder-517"><span class="linenos">517</span></a>              <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Embedder-518"><a href="#Embedder-518"><span class="linenos">518</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder-519"><a href="#Embedder-519"><span class="linenos">519</span></a><span class="sd">        Embed given secret message.</span>
</span><span id="Embedder-520"><a href="#Embedder-520"><span class="linenos">520</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder-521"><a href="#Embedder-521"><span class="linenos">521</span></a>
</span><span id="Embedder-522"><a href="#Embedder-522"><span class="linenos">522</span></a>        <span class="c1"># Skip flag defines how many next instructions should be</span>
</span><span id="Embedder-523"><a href="#Embedder-523"><span class="linenos">523</span></a>        <span class="c1"># skipped as they were already used by first instruction</span>
</span><span id="Embedder-524"><a href="#Embedder-524"><span class="linenos">524</span></a>        <span class="c1"># from their group (3 and 2 Bytes Long NOP classes).</span>
</span><span id="Embedder-525"><a href="#Embedder-525"><span class="linenos">525</span></a>        <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Embedder-526"><a href="#Embedder-526"><span class="linenos">526</span></a>        
</span><span id="Embedder-527"><a href="#Embedder-527"><span class="linenos">527</span></a>        <span class="c1"># Determines if MOVs were already scheduled. It&#39;s False at the</span>
</span><span id="Embedder-528"><a href="#Embedder-528"><span class="linenos">528</span></a>        <span class="c1"># beginning, but first MOV set it to True after they are</span>
</span><span id="Embedder-529"><a href="#Embedder-529"><span class="linenos">529</span></a>        <span class="c1"># scheduled.</span>
</span><span id="Embedder-530"><a href="#Embedder-530"><span class="linenos">530</span></a>        <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Embedder-531"><a href="#Embedder-531"><span class="linenos">531</span></a>        
</span><span id="Embedder-532"><a href="#Embedder-532"><span class="linenos">532</span></a>        <span class="n">bits_mess</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="Embedder-533"><a href="#Embedder-533"><span class="linenos">533</span></a>        <span class="n">bits_mess</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">mess</span><span class="p">)</span>
</span><span id="Embedder-534"><a href="#Embedder-534"><span class="linenos">534</span></a>        
</span><span id="Embedder-535"><a href="#Embedder-535"><span class="linenos">535</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Embedder-536"><a href="#Embedder-536"><span class="linenos">536</span></a>            <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fexe</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span>
</span><span id="Embedder-537"><a href="#Embedder-537"><span class="linenos">537</span></a>        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="Embedder-538"><a href="#Embedder-538"><span class="linenos">538</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR! Can not open cover file for embedding: </span><span class="si">{</span><span class="n">fexe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Embedder-539"><a href="#Embedder-539"><span class="linenos">539</span></a>                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder-540"><a href="#Embedder-540"><span class="linenos">540</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="Embedder-541"><a href="#Embedder-541"><span class="linenos">541</span></a>        
</span><span id="Embedder-542"><a href="#Embedder-542"><span class="linenos">542</span></a>        <span class="k">for</span> <span class="n">instr_idx</span><span class="p">,</span> <span class="n">my_instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">potential_my_instrs</span><span class="p">):</span>
</span><span id="Embedder-543"><a href="#Embedder-543"><span class="linenos">543</span></a>            
</span><span id="Embedder-544"><a href="#Embedder-544"><span class="linenos">544</span></a>            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
</span><span id="Embedder-545"><a href="#Embedder-545"><span class="linenos">545</span></a>                <span class="c1"># Skip current NOP instruction.</span>
</span><span id="Embedder-546"><a href="#Embedder-546"><span class="linenos">546</span></a>                <span class="n">skip</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="Embedder-547"><a href="#Embedder-547"><span class="linenos">547</span></a>                <span class="k">continue</span>
</span><span id="Embedder-548"><a href="#Embedder-548"><span class="linenos">548</span></a>            
</span><span id="Embedder-549"><a href="#Embedder-549"><span class="linenos">549</span></a>            <span class="c1"># For speed performance.</span>
</span><span id="Embedder-550"><a href="#Embedder-550"><span class="linenos">550</span></a>            <span class="n">eq_class</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">eq_class</span>
</span><span id="Embedder-551"><a href="#Embedder-551"><span class="linenos">551</span></a>            <span class="n">instr</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">instruction</span>
</span><span id="Embedder-552"><a href="#Embedder-552"><span class="linenos">552</span></a>            
</span><span id="Embedder-553"><a href="#Embedder-553"><span class="linenos">553</span></a>            <span class="c1"># Instructions that don&#39;t have encoding LEGACY are skipped.</span>
</span><span id="Embedder-554"><a href="#Embedder-554"><span class="linenos">554</span></a>            <span class="c1"># Legacy encoding for opcodes of instructions is mainly used</span>
</span><span id="Embedder-555"><a href="#Embedder-555"><span class="linenos">555</span></a>            <span class="c1"># in each PE and ELF (32- and 64-bit) executables and others</span>
</span><span id="Embedder-556"><a href="#Embedder-556"><span class="linenos">556</span></a>            <span class="c1"># encodings are very rare.</span>
</span><span id="Embedder-557"><a href="#Embedder-557"><span class="linenos">557</span></a>            <span class="k">if</span> <span class="n">eq_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
</span><span id="Embedder-558"><a href="#Embedder-558"><span class="linenos">558</span></a>                <span class="n">instr</span><span class="o">.</span><span class="n">encoding</span> <span class="o">==</span> <span class="n">EncodingKind</span><span class="o">.</span><span class="n">LEGACY</span><span class="p">:</span>
</span><span id="Embedder-559"><a href="#Embedder-559"><span class="linenos">559</span></a>                
</span><span id="Embedder-560"><a href="#Embedder-560"><span class="linenos">560</span></a>                <span class="c1"># Encoding is lexicographic order of used instructions</span>
</span><span id="Embedder-561"><a href="#Embedder-561"><span class="linenos">561</span></a>                <span class="c1"># strings and it&#39;s determined by configuration file.</span>
</span><span id="Embedder-562"><a href="#Embedder-562"><span class="linenos">562</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;MOV Scheduling&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder-563"><a href="#Embedder-563"><span class="linenos">563</span></a>                    <span class="n">my_instr</span><span class="o">.</span><span class="n">mov_scheduling_flag</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">movs_scheduled</span><span class="p">:</span>
</span><span id="Embedder-564"><a href="#Embedder-564"><span class="linenos">564</span></a>
</span><span id="Embedder-565"><a href="#Embedder-565"><span class="linenos">565</span></a>                    <span class="c1">## Second MOV is current, both can be scheduled now.</span>
</span><span id="Embedder-566"><a href="#Embedder-566"><span class="linenos">566</span></a>
</span><span id="Embedder-567"><a href="#Embedder-567"><span class="linenos">567</span></a>                    <span class="c1"># Set flag with first MOV - This is only tag for</span>
</span><span id="Embedder-568"><a href="#Embedder-568"><span class="linenos">568</span></a>                    <span class="c1"># knowledge that first MOV was tried to be scheduled.</span>
</span><span id="Embedder-569"><a href="#Embedder-569"><span class="linenos">569</span></a>                    <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Embedder-570"><a href="#Embedder-570"><span class="linenos">570</span></a>
</span><span id="Embedder-571"><a href="#Embedder-571"><span class="linenos">571</span></a>                    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__can_schedule_mov</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span>
</span><span id="Embedder-572"><a href="#Embedder-572"><span class="linenos">572</span></a>                                              <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="Embedder-573"><a href="#Embedder-573"><span class="linenos">573</span></a>                    
</span><span id="Embedder-574"><a href="#Embedder-574"><span class="linenos">574</span></a>                        <span class="n">next_mov</span> <span class="o">=</span> <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Embedder-575"><a href="#Embedder-575"><span class="linenos">575</span></a>                        
</span><span id="Embedder-576"><a href="#Embedder-576"><span class="linenos">576</span></a>                        <span class="c1"># Find out desired order for MOVs according to</span>
</span><span id="Embedder-577"><a href="#Embedder-577"><span class="linenos">577</span></a>                        <span class="c1"># the encoding.</span>
</span><span id="Embedder-578"><a href="#Embedder-578"><span class="linenos">578</span></a>                        <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder-579"><a href="#Embedder-579"><span class="linenos">579</span></a>
</span><span id="Embedder-580"><a href="#Embedder-580"><span class="linenos">580</span></a>                        <span class="c1"># Decide if both MOVs should be swapped according to</span>
</span><span id="Embedder-581"><a href="#Embedder-581"><span class="linenos">581</span></a>                        <span class="c1"># the next secret message bits or if they are in the</span>
</span><span id="Embedder-582"><a href="#Embedder-582"><span class="linenos">582</span></a>                        <span class="c1"># right order.</span>
</span><span id="Embedder-583"><a href="#Embedder-583"><span class="linenos">583</span></a>                        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__should_swap_mov</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">next_mov</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="Embedder-584"><a href="#Embedder-584"><span class="linenos">584</span></a>                            <span class="c1"># MOVs are going to be swapped.</span>
</span><span id="Embedder-585"><a href="#Embedder-585"><span class="linenos">585</span></a>                            
</span><span id="Embedder-586"><a href="#Embedder-586"><span class="linenos">586</span></a>                            <span class="c1"># Read instruction bytes of 1st MOV.</span>
</span><span id="Embedder-587"><a href="#Embedder-587"><span class="linenos">587</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-588"><a href="#Embedder-588"><span class="linenos">588</span></a>                            <span class="n">b_mov0_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder-589"><a href="#Embedder-589"><span class="linenos">589</span></a>                            
</span><span id="Embedder-590"><a href="#Embedder-590"><span class="linenos">590</span></a>                            <span class="c1"># Read instruction bytes of 2nd MOV.</span>
</span><span id="Embedder-591"><a href="#Embedder-591"><span class="linenos">591</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-592"><a href="#Embedder-592"><span class="linenos">592</span></a>                            <span class="n">b_mov1_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">instruction</span><span class="p">))</span>
</span><span id="Embedder-593"><a href="#Embedder-593"><span class="linenos">593</span></a>                            
</span><span id="Embedder-594"><a href="#Embedder-594"><span class="linenos">594</span></a>                            <span class="c1"># Swap them.</span>
</span><span id="Embedder-595"><a href="#Embedder-595"><span class="linenos">595</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-596"><a href="#Embedder-596"><span class="linenos">596</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_mov1_fromf</span><span class="p">)</span>
</span><span id="Embedder-597"><a href="#Embedder-597"><span class="linenos">597</span></a>                            
</span><span id="Embedder-598"><a href="#Embedder-598"><span class="linenos">598</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">instruction</span><span class="p">))</span>
</span><span id="Embedder-599"><a href="#Embedder-599"><span class="linenos">599</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_mov0_fromf</span><span class="p">)</span>
</span><span id="Embedder-600"><a href="#Embedder-600"><span class="linenos">600</span></a>                            
</span><span id="Embedder-601"><a href="#Embedder-601"><span class="linenos">601</span></a>                        <span class="c1"># Delete already embedded order bit from list.</span>
</span><span id="Embedder-602"><a href="#Embedder-602"><span class="linenos">602</span></a>                        <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-603"><a href="#Embedder-603"><span class="linenos">603</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-604"><a href="#Embedder-604"><span class="linenos">604</span></a>                    <span class="c1"># Unset flag with second MOV.</span>
</span><span id="Embedder-605"><a href="#Embedder-605"><span class="linenos">605</span></a>                    <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Embedder-606"><a href="#Embedder-606"><span class="linenos">606</span></a>                
</span><span id="Embedder-607"><a href="#Embedder-607"><span class="linenos">607</span></a>                
</span><span id="Embedder-608"><a href="#Embedder-608"><span class="linenos">608</span></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:MOV|ADD|SUB|AND|OR|XOR|CMP|ADC|SBB)$&quot;</span><span class="p">,</span>
</span><span id="Embedder-609"><a href="#Embedder-609"><span class="linenos">609</span></a>                          <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="p">):</span>
</span><span id="Embedder-610"><a href="#Embedder-610"><span class="linenos">610</span></a>                    <span class="c1"># Form of instruction changes (r/m, r &lt;=&gt; r, r/m),</span>
</span><span id="Embedder-611"><a href="#Embedder-611"><span class="linenos">611</span></a>                    <span class="c1"># therefore, also, operands must be changed. If REX</span>
</span><span id="Embedder-612"><a href="#Embedder-612"><span class="linenos">612</span></a>                    <span class="c1"># prefix is present, proper bits of prefix are</span>
</span><span id="Embedder-613"><a href="#Embedder-613"><span class="linenos">613</span></a>                    <span class="c1"># exchanged, as well.</span>
</span><span id="Embedder-614"><a href="#Embedder-614"><span class="linenos">614</span></a>                    <span class="c1"># MOV instruction form this class can also be</span>
</span><span id="Embedder-615"><a href="#Embedder-615"><span class="linenos">615</span></a>                    <span class="c1"># scheduled.</span>
</span><span id="Embedder-616"><a href="#Embedder-616"><span class="linenos">616</span></a>
</span><span id="Embedder-617"><a href="#Embedder-617"><span class="linenos">617</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder-618"><a href="#Embedder-618"><span class="linenos">618</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder-619"><a href="#Embedder-619"><span class="linenos">619</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-620"><a href="#Embedder-620"><span class="linenos">620</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder-621"><a href="#Embedder-621"><span class="linenos">621</span></a>                    
</span><span id="Embedder-622"><a href="#Embedder-622"><span class="linenos">622</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder-623"><a href="#Embedder-623"><span class="linenos">623</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder-624"><a href="#Embedder-624"><span class="linenos">624</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder-625"><a href="#Embedder-625"><span class="linenos">625</span></a>                    
</span><span id="Embedder-626"><a href="#Embedder-626"><span class="linenos">626</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder-627"><a href="#Embedder-627"><span class="linenos">627</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder-628"><a href="#Embedder-628"><span class="linenos">628</span></a>                    
</span><span id="Embedder-629"><a href="#Embedder-629"><span class="linenos">629</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder-630"><a href="#Embedder-630"><span class="linenos">630</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder-631"><a href="#Embedder-631"><span class="linenos">631</span></a>                    
</span><span id="Embedder-632"><a href="#Embedder-632"><span class="linenos">632</span></a>                    <span class="c1"># Find Direction bit to embed according to the</span>
</span><span id="Embedder-633"><a href="#Embedder-633"><span class="linenos">633</span></a>                    <span class="c1"># encoding.</span>
</span><span id="Embedder-634"><a href="#Embedder-634"><span class="linenos">634</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder-635"><a href="#Embedder-635"><span class="linenos">635</span></a>                    <span class="n">new_dir_bit</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder-636"><a href="#Embedder-636"><span class="linenos">636</span></a>                    
</span><span id="Embedder-637"><a href="#Embedder-637"><span class="linenos">637</span></a>                    <span class="n">dir_bit_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="Embedder-638"><a href="#Embedder-638"><span class="linenos">638</span></a>                    <span class="c1"># decide if Direction bit is going to be swapped.</span>
</span><span id="Embedder-639"><a href="#Embedder-639"><span class="linenos">639</span></a>                    <span class="k">if</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> \
</span><span id="Embedder-640"><a href="#Embedder-640"><span class="linenos">640</span></a>                        <span class="n">new_dir_bit</span><span class="p">:</span>
</span><span id="Embedder-641"><a href="#Embedder-641"><span class="linenos">641</span></a>                    
</span><span id="Embedder-642"><a href="#Embedder-642"><span class="linenos">642</span></a>                        <span class="c1"># Direction bit is going to be changed.</span>
</span><span id="Embedder-643"><a href="#Embedder-643"><span class="linenos">643</span></a>                        <span class="n">rex_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_rex_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="Embedder-644"><a href="#Embedder-644"><span class="linenos">644</span></a>                        
</span><span id="Embedder-645"><a href="#Embedder-645"><span class="linenos">645</span></a>                        <span class="c1"># Exchange Reg/Opcode and rm field of ModR/M byte.</span>
</span><span id="Embedder-646"><a href="#Embedder-646"><span class="linenos">646</span></a>                        <span class="bp">cls</span><span class="o">.</span><span class="n">__swap_rm_r_operands</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">,</span>
</span><span id="Embedder-647"><a href="#Embedder-647"><span class="linenos">647</span></a>                                                <span class="n">opcode_idx</span><span class="p">,</span>
</span><span id="Embedder-648"><a href="#Embedder-648"><span class="linenos">648</span></a>                                                <span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder-649"><a href="#Embedder-649"><span class="linenos">649</span></a>                        
</span><span id="Embedder-650"><a href="#Embedder-650"><span class="linenos">650</span></a>                        <span class="c1"># Rewrite Direction bit inside opcode of instruction.</span>
</span><span id="Embedder-651"><a href="#Embedder-651"><span class="linenos">651</span></a>                        <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="Embedder-652"><a href="#Embedder-652"><span class="linenos">652</span></a>                            <span class="n">new_dir_bit</span>
</span><span id="Embedder-653"><a href="#Embedder-653"><span class="linenos">653</span></a>                        
</span><span id="Embedder-654"><a href="#Embedder-654"><span class="linenos">654</span></a>                        <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder-655"><a href="#Embedder-655"><span class="linenos">655</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-656"><a href="#Embedder-656"><span class="linenos">656</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder-657"><a href="#Embedder-657"><span class="linenos">657</span></a>                    
</span><span id="Embedder-658"><a href="#Embedder-658"><span class="linenos">658</span></a>                    <span class="c1"># Always 1, because embedded was only Direction bit.</span>
</span><span id="Embedder-659"><a href="#Embedder-659"><span class="linenos">659</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-660"><a href="#Embedder-660"><span class="linenos">660</span></a>                
</span><span id="Embedder-661"><a href="#Embedder-661"><span class="linenos">661</span></a>                
</span><span id="Embedder-662"><a href="#Embedder-662"><span class="linenos">662</span></a>                <span class="c1"># Encoding is lexicographic order of used registers name</span>
</span><span id="Embedder-663"><a href="#Embedder-663"><span class="linenos">663</span></a>                <span class="c1"># and it&#39;s determined by configuration file.</span>
</span><span id="Embedder-664"><a href="#Embedder-664"><span class="linenos">664</span></a>                <span class="k">if</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;Swap base-index registers 32-bit&quot;</span><span class="p">:</span>
</span><span id="Embedder-665"><a href="#Embedder-665"><span class="linenos">665</span></a>                    <span class="c1"># Instruction form changes (SIB.base &lt;=&gt; SIB.index),</span>
</span><span id="Embedder-666"><a href="#Embedder-666"><span class="linenos">666</span></a>                    <span class="c1"># therefore, also, operands must be changed. If REX</span>
</span><span id="Embedder-667"><a href="#Embedder-667"><span class="linenos">667</span></a>                    <span class="c1"># prefix is present, proper bits of prefix are</span>
</span><span id="Embedder-668"><a href="#Embedder-668"><span class="linenos">668</span></a>                    <span class="c1"># exchanged, as well.</span>
</span><span id="Embedder-669"><a href="#Embedder-669"><span class="linenos">669</span></a>                    <span class="c1"># MOV instruction form this class can also be</span>
</span><span id="Embedder-670"><a href="#Embedder-670"><span class="linenos">670</span></a>                    <span class="c1"># scheduled.</span>
</span><span id="Embedder-671"><a href="#Embedder-671"><span class="linenos">671</span></a>
</span><span id="Embedder-672"><a href="#Embedder-672"><span class="linenos">672</span></a>                    <span class="c1"># Find out desired order for base-index according to</span>
</span><span id="Embedder-673"><a href="#Embedder-673"><span class="linenos">673</span></a>                    <span class="c1"># the encoding.</span>
</span><span id="Embedder-674"><a href="#Embedder-674"><span class="linenos">674</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder-675"><a href="#Embedder-675"><span class="linenos">675</span></a>                    
</span><span id="Embedder-676"><a href="#Embedder-676"><span class="linenos">676</span></a>                    <span class="c1"># Decide if base and index registers should be</span>
</span><span id="Embedder-677"><a href="#Embedder-677"><span class="linenos">677</span></a>                    <span class="c1"># swapped according to the next secret message bits</span>
</span><span id="Embedder-678"><a href="#Embedder-678"><span class="linenos">678</span></a>                    <span class="c1"># or if they are in the right order.</span>
</span><span id="Embedder-679"><a href="#Embedder-679"><span class="linenos">679</span></a>                    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__should_swap_base_index</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="Embedder-680"><a href="#Embedder-680"><span class="linenos">680</span></a>
</span><span id="Embedder-681"><a href="#Embedder-681"><span class="linenos">681</span></a>                        <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder-682"><a href="#Embedder-682"><span class="linenos">682</span></a>                        <span class="c1"># modify it.</span>
</span><span id="Embedder-683"><a href="#Embedder-683"><span class="linenos">683</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-684"><a href="#Embedder-684"><span class="linenos">684</span></a>                        <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder-685"><a href="#Embedder-685"><span class="linenos">685</span></a>                       
</span><span id="Embedder-686"><a href="#Embedder-686"><span class="linenos">686</span></a>                        <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder-687"><a href="#Embedder-687"><span class="linenos">687</span></a>                        <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder-688"><a href="#Embedder-688"><span class="linenos">688</span></a>                        <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder-689"><a href="#Embedder-689"><span class="linenos">689</span></a>                        
</span><span id="Embedder-690"><a href="#Embedder-690"><span class="linenos">690</span></a>                        <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder-691"><a href="#Embedder-691"><span class="linenos">691</span></a>                        <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder-692"><a href="#Embedder-692"><span class="linenos">692</span></a>                        
</span><span id="Embedder-693"><a href="#Embedder-693"><span class="linenos">693</span></a>                        <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder-694"><a href="#Embedder-694"><span class="linenos">694</span></a>                                                           <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder-695"><a href="#Embedder-695"><span class="linenos">695</span></a>                        
</span><span id="Embedder-696"><a href="#Embedder-696"><span class="linenos">696</span></a>                        <span class="n">rex_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_rex_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="Embedder-697"><a href="#Embedder-697"><span class="linenos">697</span></a>                        
</span><span id="Embedder-698"><a href="#Embedder-698"><span class="linenos">698</span></a>                        <span class="c1"># Swap registers. If swap is not successful,</span>
</span><span id="Embedder-699"><a href="#Embedder-699"><span class="linenos">699</span></a>                        <span class="c1"># nothing is embeddded and instr. is skipped.</span>
</span><span id="Embedder-700"><a href="#Embedder-700"><span class="linenos">700</span></a>                        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__swap_base_index</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">,</span> <span class="n">bits_instr</span><span class="p">):</span>                        
</span><span id="Embedder-701"><a href="#Embedder-701"><span class="linenos">701</span></a>                            <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder-702"><a href="#Embedder-702"><span class="linenos">702</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-703"><a href="#Embedder-703"><span class="linenos">703</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder-704"><a href="#Embedder-704"><span class="linenos">704</span></a>                            
</span><span id="Embedder-705"><a href="#Embedder-705"><span class="linenos">705</span></a>                            <span class="c1"># Delete already embedded bit from list.</span>
</span><span id="Embedder-706"><a href="#Embedder-706"><span class="linenos">706</span></a>                            <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-707"><a href="#Embedder-707"><span class="linenos">707</span></a>
</span><span id="Embedder-708"><a href="#Embedder-708"><span class="linenos">708</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-709"><a href="#Embedder-709"><span class="linenos">709</span></a>                        <span class="c1"># Delete already embedded bit from list.</span>
</span><span id="Embedder-710"><a href="#Embedder-710"><span class="linenos">710</span></a>                        <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-711"><a href="#Embedder-711"><span class="linenos">711</span></a>                        
</span><span id="Embedder-712"><a href="#Embedder-712"><span class="linenos">712</span></a>                
</span><span id="Embedder-713"><a href="#Embedder-713"><span class="linenos">713</span></a>                <span class="c1"># Classes can be together as their usage is based on</span>
</span><span id="Embedder-714"><a href="#Embedder-714"><span class="linenos">714</span></a>                <span class="c1"># exactly same principle.</span>
</span><span id="Embedder-715"><a href="#Embedder-715"><span class="linenos">715</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;2 Bytes Long NOP&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder-716"><a href="#Embedder-716"><span class="linenos">716</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;3 Bytes Long NOP&quot;</span><span class="p">:</span>
</span><span id="Embedder-717"><a href="#Embedder-717"><span class="linenos">717</span></a>
</span><span id="Embedder-718"><a href="#Embedder-718"><span class="linenos">718</span></a>                    <span class="c1"># Set skip flag for next instructions skipping.</span>
</span><span id="Embedder-719"><a href="#Embedder-719"><span class="linenos">719</span></a>                    <span class="n">skip</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">set_skip_flag</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span>
</span><span id="Embedder-720"><a href="#Embedder-720"><span class="linenos">720</span></a>                                                <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="Embedder-721"><a href="#Embedder-721"><span class="linenos">721</span></a>
</span><span id="Embedder-722"><a href="#Embedder-722"><span class="linenos">722</span></a>                    <span class="c1"># Find bits to embed according to the encoding.</span>
</span><span id="Embedder-723"><a href="#Embedder-723"><span class="linenos">723</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder-724"><a href="#Embedder-724"><span class="linenos">724</span></a>
</span><span id="Embedder-725"><a href="#Embedder-725"><span class="linenos">725</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder-726"><a href="#Embedder-726"><span class="linenos">726</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-727"><a href="#Embedder-727"><span class="linenos">727</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>
</span><span id="Embedder-728"><a href="#Embedder-728"><span class="linenos">728</span></a>                    
</span><span id="Embedder-729"><a href="#Embedder-729"><span class="linenos">729</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder-730"><a href="#Embedder-730"><span class="linenos">730</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-731"><a href="#Embedder-731"><span class="linenos">731</span></a>
</span><span id="Embedder-732"><a href="#Embedder-732"><span class="linenos">732</span></a>                
</span><span id="Embedder-733"><a href="#Embedder-733"><span class="linenos">733</span></a>                <span class="c1"># Class does not encodes class members, as it does not</span>
</span><span id="Embedder-734"><a href="#Embedder-734"><span class="linenos">734</span></a>                <span class="c1"># have any. In this case, bits from message are simply</span>
</span><span id="Embedder-735"><a href="#Embedder-735"><span class="linenos">735</span></a>                <span class="c1"># embedded to the last useable instruction bytes.</span>
</span><span id="Embedder-736"><a href="#Embedder-736"><span class="linenos">736</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;&gt;3 Bytes Long NOP&quot;</span><span class="p">:</span>
</span><span id="Embedder-737"><a href="#Embedder-737"><span class="linenos">737</span></a>
</span><span id="Embedder-738"><a href="#Embedder-738"><span class="linenos">738</span></a>                    <span class="c1"># Get number of bits available for embedding.</span>
</span><span id="Embedder-739"><a href="#Embedder-739"><span class="linenos">739</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-740"><a href="#Embedder-740"><span class="linenos">740</span></a>                    <span class="n">bits_cnt</span> <span class="o">=</span> \
</span><span id="Embedder-741"><a href="#Embedder-741"><span class="linenos">741</span></a>                        <span class="n">common</span><span class="o">.</span><span class="n">count_useable_bits_from_nop</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span>
</span><span id="Embedder-742"><a href="#Embedder-742"><span class="linenos">742</span></a>                                                           <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)))</span>
</span><span id="Embedder-743"><a href="#Embedder-743"><span class="linenos">743</span></a>                    <span class="c1"># Take bits needed to embed.</span>
</span><span id="Embedder-744"><a href="#Embedder-744"><span class="linenos">744</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="n">bits_cnt</span><span class="p">]</span>
</span><span id="Embedder-745"><a href="#Embedder-745"><span class="linenos">745</span></a>
</span><span id="Embedder-746"><a href="#Embedder-746"><span class="linenos">746</span></a>                    <span class="c1"># There is 100% chance that it will be multiple of 8.</span>
</span><span id="Embedder-747"><a href="#Embedder-747"><span class="linenos">747</span></a>                    <span class="n">b_cnt</span> <span class="o">=</span> <span class="n">bits_cnt</span> <span class="o">//</span> <span class="mi">8</span>
</span><span id="Embedder-748"><a href="#Embedder-748"><span class="linenos">748</span></a>                    
</span><span id="Embedder-749"><a href="#Embedder-749"><span class="linenos">749</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder-750"><a href="#Embedder-750"><span class="linenos">750</span></a>                    <span class="n">pos</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">-</span> <span class="n">b_cnt</span><span class="p">)</span>
</span><span id="Embedder-751"><a href="#Embedder-751"><span class="linenos">751</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
</span><span id="Embedder-752"><a href="#Embedder-752"><span class="linenos">752</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_to_embed</span><span class="p">)</span>
</span><span id="Embedder-753"><a href="#Embedder-753"><span class="linenos">753</span></a>
</span><span id="Embedder-754"><a href="#Embedder-754"><span class="linenos">754</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder-755"><a href="#Embedder-755"><span class="linenos">755</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">bits_to_embed</span><span class="p">)]</span>
</span><span id="Embedder-756"><a href="#Embedder-756"><span class="linenos">756</span></a>
</span><span id="Embedder-757"><a href="#Embedder-757"><span class="linenos">757</span></a>                
</span><span id="Embedder-758"><a href="#Embedder-758"><span class="linenos">758</span></a>                <span class="c1"># These two classes can be merged as they modify only</span>
</span><span id="Embedder-759"><a href="#Embedder-759"><span class="linenos">759</span></a>                <span class="c1"># Reg/Opcode field inside ModR/M byte.</span>
</span><span id="Embedder-760"><a href="#Embedder-760"><span class="linenos">760</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SHL/SAL&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder-761"><a href="#Embedder-761"><span class="linenos">761</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;TEST non-accumulator register&quot;</span><span class="p">:</span>
</span><span id="Embedder-762"><a href="#Embedder-762"><span class="linenos">762</span></a>
</span><span id="Embedder-763"><a href="#Embedder-763"><span class="linenos">763</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder-764"><a href="#Embedder-764"><span class="linenos">764</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder-765"><a href="#Embedder-765"><span class="linenos">765</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-766"><a href="#Embedder-766"><span class="linenos">766</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder-767"><a href="#Embedder-767"><span class="linenos">767</span></a>                    
</span><span id="Embedder-768"><a href="#Embedder-768"><span class="linenos">768</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder-769"><a href="#Embedder-769"><span class="linenos">769</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder-770"><a href="#Embedder-770"><span class="linenos">770</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder-771"><a href="#Embedder-771"><span class="linenos">771</span></a>                    
</span><span id="Embedder-772"><a href="#Embedder-772"><span class="linenos">772</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder-773"><a href="#Embedder-773"><span class="linenos">773</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder-774"><a href="#Embedder-774"><span class="linenos">774</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder-775"><a href="#Embedder-775"><span class="linenos">775</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder-776"><a href="#Embedder-776"><span class="linenos">776</span></a>                    
</span><span id="Embedder-777"><a href="#Embedder-777"><span class="linenos">777</span></a>                    <span class="c1"># Find bits to embed according to the encoding.</span>
</span><span id="Embedder-778"><a href="#Embedder-778"><span class="linenos">778</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder-779"><a href="#Embedder-779"><span class="linenos">779</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder-780"><a href="#Embedder-780"><span class="linenos">780</span></a>
</span><span id="Embedder-781"><a href="#Embedder-781"><span class="linenos">781</span></a>                    <span class="c1"># Locate Reg/Opcode field inside ModR/M byte.</span>
</span><span id="Embedder-782"><a href="#Embedder-782"><span class="linenos">782</span></a>                    <span class="n">reg_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="Embedder-783"><a href="#Embedder-783"><span class="linenos">783</span></a>                    <span class="c1"># Rewrite required bits inside instruction.</span>
</span><span id="Embedder-784"><a href="#Embedder-784"><span class="linenos">784</span></a>                    <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> \
</span><span id="Embedder-785"><a href="#Embedder-785"><span class="linenos">785</span></a>                        <span class="n">bits_to_embed</span>
</span><span id="Embedder-786"><a href="#Embedder-786"><span class="linenos">786</span></a>
</span><span id="Embedder-787"><a href="#Embedder-787"><span class="linenos">787</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder-788"><a href="#Embedder-788"><span class="linenos">788</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-789"><a href="#Embedder-789"><span class="linenos">789</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder-790"><a href="#Embedder-790"><span class="linenos">790</span></a>
</span><span id="Embedder-791"><a href="#Embedder-791"><span class="linenos">791</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder-792"><a href="#Embedder-792"><span class="linenos">792</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-793"><a href="#Embedder-793"><span class="linenos">793</span></a>                
</span><span id="Embedder-794"><a href="#Embedder-794"><span class="linenos">794</span></a>                
</span><span id="Embedder-795"><a href="#Embedder-795"><span class="linenos">795</span></a>                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:ADD|SUB|AND|OR|XOR|CMP|ADC|SBB) 32-bit$&quot;</span><span class="p">,</span>
</span><span id="Embedder-796"><a href="#Embedder-796"><span class="linenos">796</span></a>                          <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="p">):</span>
</span><span id="Embedder-797"><a href="#Embedder-797"><span class="linenos">797</span></a>
</span><span id="Embedder-798"><a href="#Embedder-798"><span class="linenos">798</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder-799"><a href="#Embedder-799"><span class="linenos">799</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder-800"><a href="#Embedder-800"><span class="linenos">800</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-801"><a href="#Embedder-801"><span class="linenos">801</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder-802"><a href="#Embedder-802"><span class="linenos">802</span></a>                    
</span><span id="Embedder-803"><a href="#Embedder-803"><span class="linenos">803</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder-804"><a href="#Embedder-804"><span class="linenos">804</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder-805"><a href="#Embedder-805"><span class="linenos">805</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder-806"><a href="#Embedder-806"><span class="linenos">806</span></a>                    
</span><span id="Embedder-807"><a href="#Embedder-807"><span class="linenos">807</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder-808"><a href="#Embedder-808"><span class="linenos">808</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder-809"><a href="#Embedder-809"><span class="linenos">809</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder-810"><a href="#Embedder-810"><span class="linenos">810</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder-811"><a href="#Embedder-811"><span class="linenos">811</span></a>
</span><span id="Embedder-812"><a href="#Embedder-812"><span class="linenos">812</span></a>                    <span class="c1"># Find Direction bit to embed according to the</span>
</span><span id="Embedder-813"><a href="#Embedder-813"><span class="linenos">813</span></a>                    <span class="c1"># encoding.</span>
</span><span id="Embedder-814"><a href="#Embedder-814"><span class="linenos">814</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder-815"><a href="#Embedder-815"><span class="linenos">815</span></a>                    <span class="n">dir_bit</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder-816"><a href="#Embedder-816"><span class="linenos">816</span></a>                    
</span><span id="Embedder-817"><a href="#Embedder-817"><span class="linenos">817</span></a>                    <span class="c1"># Rewrite Direction bit inside opcode of instruction.</span>
</span><span id="Embedder-818"><a href="#Embedder-818"><span class="linenos">818</span></a>                    <span class="n">dir_bit_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="Embedder-819"><a href="#Embedder-819"><span class="linenos">819</span></a>                    <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir_bit</span>
</span><span id="Embedder-820"><a href="#Embedder-820"><span class="linenos">820</span></a>
</span><span id="Embedder-821"><a href="#Embedder-821"><span class="linenos">821</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder-822"><a href="#Embedder-822"><span class="linenos">822</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-823"><a href="#Embedder-823"><span class="linenos">823</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder-824"><a href="#Embedder-824"><span class="linenos">824</span></a>                    
</span><span id="Embedder-825"><a href="#Embedder-825"><span class="linenos">825</span></a>                    <span class="c1"># Always 1, because embedded was only Direction bit.</span>
</span><span id="Embedder-826"><a href="#Embedder-826"><span class="linenos">826</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-827"><a href="#Embedder-827"><span class="linenos">827</span></a>                
</span><span id="Embedder-828"><a href="#Embedder-828"><span class="linenos">828</span></a>                
</span><span id="Embedder-829"><a href="#Embedder-829"><span class="linenos">829</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SUB/XOR&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder-830"><a href="#Embedder-830"><span class="linenos">830</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;TEST/AND/OR&quot;</span><span class="p">:</span>
</span><span id="Embedder-831"><a href="#Embedder-831"><span class="linenos">831</span></a>
</span><span id="Embedder-832"><a href="#Embedder-832"><span class="linenos">832</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder-833"><a href="#Embedder-833"><span class="linenos">833</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder-834"><a href="#Embedder-834"><span class="linenos">834</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-835"><a href="#Embedder-835"><span class="linenos">835</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder-836"><a href="#Embedder-836"><span class="linenos">836</span></a>                    
</span><span id="Embedder-837"><a href="#Embedder-837"><span class="linenos">837</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder-838"><a href="#Embedder-838"><span class="linenos">838</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder-839"><a href="#Embedder-839"><span class="linenos">839</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder-840"><a href="#Embedder-840"><span class="linenos">840</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder-841"><a href="#Embedder-841"><span class="linenos">841</span></a>                    
</span><span id="Embedder-842"><a href="#Embedder-842"><span class="linenos">842</span></a>                    <span class="c1"># Find Reg/Opcode bits to embed according to the</span>
</span><span id="Embedder-843"><a href="#Embedder-843"><span class="linenos">843</span></a>                    <span class="c1"># encoding.</span>
</span><span id="Embedder-844"><a href="#Embedder-844"><span class="linenos">844</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder-845"><a href="#Embedder-845"><span class="linenos">845</span></a>                    
</span><span id="Embedder-846"><a href="#Embedder-846"><span class="linenos">846</span></a>                    <span class="c1"># Creates desired opcode according to encoding bits.</span>
</span><span id="Embedder-847"><a href="#Embedder-847"><span class="linenos">847</span></a>                    <span class="n">b_new_opcode</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__create_opcode</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="Embedder-848"><a href="#Embedder-848"><span class="linenos">848</span></a>                    
</span><span id="Embedder-849"><a href="#Embedder-849"><span class="linenos">849</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder-850"><a href="#Embedder-850"><span class="linenos">850</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="Embedder-851"><a href="#Embedder-851"><span class="linenos">851</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_new_opcode</span><span class="p">)</span>
</span><span id="Embedder-852"><a href="#Embedder-852"><span class="linenos">852</span></a>
</span><span id="Embedder-853"><a href="#Embedder-853"><span class="linenos">853</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder-854"><a href="#Embedder-854"><span class="linenos">854</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-855"><a href="#Embedder-855"><span class="linenos">855</span></a>
</span><span id="Embedder-856"><a href="#Embedder-856"><span class="linenos">856</span></a>                
</span><span id="Embedder-857"><a href="#Embedder-857"><span class="linenos">857</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;ADD negated&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder-858"><a href="#Embedder-858"><span class="linenos">858</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SUB negated&quot;</span><span class="p">:</span>
</span><span id="Embedder-859"><a href="#Embedder-859"><span class="linenos">859</span></a>                    <span class="k">continue</span>
</span><span id="Embedder-860"><a href="#Embedder-860"><span class="linenos">860</span></a>                    <span class="nb">print</span><span class="p">()</span>
</span><span id="Embedder-861"><a href="#Embedder-861"><span class="linenos">861</span></a>                    <span class="c1">## nulu nemozem negovat, zachovam ju</span>
</span><span id="Embedder-862"><a href="#Embedder-862"><span class="linenos">862</span></a>                    <span class="c1"># NEGACIA imm je dvojkovy doplnek</span>
</span><span id="Embedder-863"><a href="#Embedder-863"><span class="linenos">863</span></a>                    <span class="c1"># ^^ 0x42 =&gt; -0x42 == (extended sign)FFF..BE</span>
</span><span id="Embedder-864"><a href="#Embedder-864"><span class="linenos">864</span></a>                    
</span><span id="Embedder-865"><a href="#Embedder-865"><span class="linenos">865</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder-866"><a href="#Embedder-866"><span class="linenos">866</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder-867"><a href="#Embedder-867"><span class="linenos">867</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-868"><a href="#Embedder-868"><span class="linenos">868</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder-869"><a href="#Embedder-869"><span class="linenos">869</span></a>                    
</span><span id="Embedder-870"><a href="#Embedder-870"><span class="linenos">870</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder-871"><a href="#Embedder-871"><span class="linenos">871</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder-872"><a href="#Embedder-872"><span class="linenos">872</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder-873"><a href="#Embedder-873"><span class="linenos">873</span></a>                    
</span><span id="Embedder-874"><a href="#Embedder-874"><span class="linenos">874</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder-875"><a href="#Embedder-875"><span class="linenos">875</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder-876"><a href="#Embedder-876"><span class="linenos">876</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder-877"><a href="#Embedder-877"><span class="linenos">877</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder-878"><a href="#Embedder-878"><span class="linenos">878</span></a>                    
</span><span id="Embedder-879"><a href="#Embedder-879"><span class="linenos">879</span></a>                    <span class="c1"># Find Reg/Opcode bits to embed according to the</span>
</span><span id="Embedder-880"><a href="#Embedder-880"><span class="linenos">880</span></a>                    <span class="c1"># encoding.</span>
</span><span id="Embedder-881"><a href="#Embedder-881"><span class="linenos">881</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder-882"><a href="#Embedder-882"><span class="linenos">882</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder-883"><a href="#Embedder-883"><span class="linenos">883</span></a>                    
</span><span id="Embedder-884"><a href="#Embedder-884"><span class="linenos">884</span></a>                    <span class="n">operand_size</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">operand_size</span>
</span><span id="Embedder-885"><a href="#Embedder-885"><span class="linenos">885</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class: </span><span class="si">{</span><span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">instr: </span><span class="si">{</span><span class="n">instr</span><span class="si">}</span><span class="se">\n</span><span class="s2">b_instr_fromf: </span><span class="si">{</span><span class="n">b_instr_fromf</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">operand_size: </span><span class="si">{</span><span class="n">operand_size</span><span class="si">}</span><span class="se">\n</span><span class="s2">bits_to_embed: </span><span class="si">{</span><span class="n">bits_to_embed</span><span class="si">}</span><span class="se">\n</span><span class="s2">instr_opcode: </span><span class="si">{</span><span class="n">instr_opcode</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">opcode_idx</span><span class="si">}</span><span class="se">\n</span><span class="s2">bits_instr: </span><span class="si">{</span><span class="n">bits_instr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder-886"><a href="#Embedder-886"><span class="linenos">886</span></a>                    
</span><span id="Embedder-887"><a href="#Embedder-887"><span class="linenos">887</span></a>                    <span class="c1"># Embed ADD or SUB according to next encoding bits.</span>
</span><span id="Embedder-888"><a href="#Embedder-888"><span class="linenos">888</span></a>                    <span class="c1"># There is special case for 1 byte long AL register</span>
</span><span id="Embedder-889"><a href="#Embedder-889"><span class="linenos">889</span></a>                    <span class="c1"># operand which is also handled.</span>
</span><span id="Embedder-890"><a href="#Embedder-890"><span class="linenos">890</span></a>                    <span class="bp">cls</span><span class="o">.</span><span class="n">__make_ADD_SUB_opcode</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span>
</span><span id="Embedder-891"><a href="#Embedder-891"><span class="linenos">891</span></a>                                              <span class="n">opcode_idx</span><span class="p">,</span>
</span><span id="Embedder-892"><a href="#Embedder-892"><span class="linenos">892</span></a>                                              <span class="n">bits_to_embed</span><span class="p">,</span>
</span><span id="Embedder-893"><a href="#Embedder-893"><span class="linenos">893</span></a>                                              <span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder-894"><a href="#Embedder-894"><span class="linenos">894</span></a>                
</span><span id="Embedder-895"><a href="#Embedder-895"><span class="linenos">895</span></a>                    <span class="c1"># Make two&#39;s Complement of immediate (always last</span>
</span><span id="Embedder-896"><a href="#Embedder-896"><span class="linenos">896</span></a>                    <span class="c1"># bytes) if required - if ADD was changed to SUB and</span>
</span><span id="Embedder-897"><a href="#Embedder-897"><span class="linenos">897</span></a>                    <span class="c1"># vice versa. Also zero immediate can not be negated</span>
</span><span id="Embedder-898"><a href="#Embedder-898"><span class="linenos">898</span></a>                    <span class="c1"># as it has only one representation in two&#39;s</span>
</span><span id="Embedder-899"><a href="#Embedder-899"><span class="linenos">899</span></a>                    <span class="c1"># complement code.</span>
</span><span id="Embedder-900"><a href="#Embedder-900"><span class="linenos">900</span></a>                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> \
</span><span id="Embedder-901"><a href="#Embedder-901"><span class="linenos">901</span></a>                        <span class="p">(</span> <span class="p">(</span>
</span><span id="Embedder-902"><a href="#Embedder-902"><span class="linenos">902</span></a>                            <span class="n">instr</span><span class="o">.</span><span class="n">mnemonic</span> <span class="o">==</span> <span class="n">Mnemonic</span><span class="o">.</span><span class="n">ADD</span> <span class="ow">and</span> \
</span><span id="Embedder-903"><a href="#Embedder-903"><span class="linenos">903</span></a>                            <span class="n">bits_to_embed</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;101&#39;</span><span class="p">)</span>
</span><span id="Embedder-904"><a href="#Embedder-904"><span class="linenos">904</span></a>                        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="Embedder-905"><a href="#Embedder-905"><span class="linenos">905</span></a>                            <span class="n">instr</span><span class="o">.</span><span class="n">mnemonic</span> <span class="o">==</span> <span class="n">Mnemonic</span><span class="o">.</span><span class="n">SUB</span> <span class="ow">and</span> \
</span><span id="Embedder-906"><a href="#Embedder-906"><span class="linenos">906</span></a>                            <span class="n">bits_to_embed</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;000&#39;</span><span class="p">)</span>
</span><span id="Embedder-907"><a href="#Embedder-907"><span class="linenos">907</span></a>                        <span class="p">)</span> <span class="p">):</span>
</span><span id="Embedder-908"><a href="#Embedder-908"><span class="linenos">908</span></a>                        <span class="c1"># It&#39;s ADD changing to SUB =&gt; swap sign.</span>
</span><span id="Embedder-909"><a href="#Embedder-909"><span class="linenos">909</span></a>                        <span class="c1"># or..</span>
</span><span id="Embedder-910"><a href="#Embedder-910"><span class="linenos">910</span></a>                        <span class="c1"># It&#39;s SUB changing to ADD =&gt; swap sign.</span>
</span><span id="Embedder-911"><a href="#Embedder-911"><span class="linenos">911</span></a>                        
</span><span id="Embedder-912"><a href="#Embedder-912"><span class="linenos">912</span></a>                        <span class="c1"># Get operand size in bytes.</span>
</span><span id="Embedder-913"><a href="#Embedder-913"><span class="linenos">913</span></a>                        <span class="n">op_size</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">operand_size</span> <span class="o">//</span> <span class="mi">8</span>
</span><span id="Embedder-914"><a href="#Embedder-914"><span class="linenos">914</span></a>                        <span class="k">if</span> <span class="n">op_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder-915"><a href="#Embedder-915"><span class="linenos">915</span></a>                            <span class="c1"># For 1 byte long operands function returns 0.</span>
</span><span id="Embedder-916"><a href="#Embedder-916"><span class="linenos">916</span></a>                            <span class="n">op_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Embedder-917"><a href="#Embedder-917"><span class="linenos">917</span></a>                        <span class="k">elif</span> <span class="n">op_size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
</span><span id="Embedder-918"><a href="#Embedder-918"><span class="linenos">918</span></a>                            <span class="c1"># For all ADD/SUB instructions are always</span>
</span><span id="Embedder-919"><a href="#Embedder-919"><span class="linenos">919</span></a>                            <span class="c1"># 64 bits long immediates truncated to 32.</span>
</span><span id="Embedder-920"><a href="#Embedder-920"><span class="linenos">920</span></a>                            <span class="c1"># It can be done as Stack instructions are</span>
</span><span id="Embedder-921"><a href="#Embedder-921"><span class="linenos">921</span></a>                            <span class="c1"># not supported in this program (they do not</span>
</span><span id="Embedder-922"><a href="#Embedder-922"><span class="linenos">922</span></a>                            <span class="c1"># truncate 64 bits to 32).</span>
</span><span id="Embedder-923"><a href="#Embedder-923"><span class="linenos">923</span></a>                            <span class="n">op_size</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="Embedder-924"><a href="#Embedder-924"><span class="linenos">924</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">op_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder-925"><a href="#Embedder-925"><span class="linenos">925</span></a>                        <span class="c1"># Make 2&#39;s complement to negate immediate.</span>
</span><span id="Embedder-926"><a href="#Embedder-926"><span class="linenos">926</span></a>                        <span class="n">b_imm_compl</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__twos_complement</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">op_size</span><span class="p">)</span>
</span><span id="Embedder-927"><a href="#Embedder-927"><span class="linenos">927</span></a>                        <span class="c1"># Get position in instruction bytes where</span>
</span><span id="Embedder-928"><a href="#Embedder-928"><span class="linenos">928</span></a>                        <span class="c1"># immediate begins.</span>
</span><span id="Embedder-929"><a href="#Embedder-929"><span class="linenos">929</span></a>                        <span class="n">imm_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_imm_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder-930"><a href="#Embedder-930"><span class="linenos">930</span></a>                                                    <span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span id="Embedder-931"><a href="#Embedder-931"><span class="linenos">931</span></a>                                                    <span class="n">op_size</span><span class="p">)</span>
</span><span id="Embedder-932"><a href="#Embedder-932"><span class="linenos">932</span></a>                        
</span><span id="Embedder-933"><a href="#Embedder-933"><span class="linenos">933</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;imm_idx: </span><span class="si">{</span><span class="n">imm_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder-934"><a href="#Embedder-934"><span class="linenos">934</span></a>                        <span class="c1"># Substitute immediate operand for his 2&#39;s comp.</span>
</span><span id="Embedder-935"><a href="#Embedder-935"><span class="linenos">935</span></a>                        <span class="n">bits_imm</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder-936"><a href="#Embedder-936"><span class="linenos">936</span></a>                        <span class="n">bits_imm</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_imm_compl</span><span class="p">)</span>
</span><span id="Embedder-937"><a href="#Embedder-937"><span class="linenos">937</span></a>                        <span class="c1"># Truncate long sign extension.</span>
</span><span id="Embedder-938"><a href="#Embedder-938"><span class="linenos">938</span></a>                        <span class="n">imm_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">[</span><span class="n">imm_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:])</span>
</span><span id="Embedder-939"><a href="#Embedder-939"><span class="linenos">939</span></a>                        <span class="n">bits_instr</span><span class="p">[</span><span class="n">imm_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:]</span> <span class="o">=</span> <span class="n">bits_imm</span><span class="p">[:</span><span class="n">imm_len</span><span class="p">]</span>
</span><span id="Embedder-940"><a href="#Embedder-940"><span class="linenos">940</span></a>                        
</span><span id="Embedder-941"><a href="#Embedder-941"><span class="linenos">941</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b_imm_compl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder-942"><a href="#Embedder-942"><span class="linenos">942</span></a>                                                
</span><span id="Embedder-943"><a href="#Embedder-943"><span class="linenos">943</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bits_instr</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder-944"><a href="#Embedder-944"><span class="linenos">944</span></a>
</span><span id="Embedder-945"><a href="#Embedder-945"><span class="linenos">945</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder-946"><a href="#Embedder-946"><span class="linenos">946</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder-947"><a href="#Embedder-947"><span class="linenos">947</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder-948"><a href="#Embedder-948"><span class="linenos">948</span></a>
</span><span id="Embedder-949"><a href="#Embedder-949"><span class="linenos">949</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder-950"><a href="#Embedder-950"><span class="linenos">950</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder-951"><a href="#Embedder-951"><span class="linenos">951</span></a>                    <span class="c1"># sys.exit()</span>
</span><span id="Embedder-952"><a href="#Embedder-952"><span class="linenos">952</span></a>    
</span><span id="Embedder-953"><a href="#Embedder-953"><span class="linenos">953</span></a>                
</span><span id="Embedder-954"><a href="#Embedder-954"><span class="linenos">954</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder-955"><a href="#Embedder-955"><span class="linenos">955</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CAN NOT BE USED - NOT LEGACY INSTRUCTION.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder-956"><a href="#Embedder-956"><span class="linenos">956</span></a>                
</span><span id="Embedder-957"><a href="#Embedder-957"><span class="linenos">957</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_mess</span><span class="p">):</span>
</span><span id="Embedder-958"><a href="#Embedder-958"><span class="linenos">958</span></a>                <span class="c1"># All bits were embedded (whole message).</span>
</span><span id="Embedder-959"><a href="#Embedder-959"><span class="linenos">959</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Embedder-960"><a href="#Embedder-960"><span class="linenos">960</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All data was successfully embedded.&quot;</span><span class="p">)</span>
</span><span id="Embedder-961"><a href="#Embedder-961"><span class="linenos">961</span></a>                <span class="k">break</span>
</span><span id="Embedder-962"><a href="#Embedder-962"><span class="linenos">962</span></a>            
</span><span id="Embedder-963"><a href="#Embedder-963"><span class="linenos">963</span></a>        <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>

        </details>

            <div class="docstring"><p><code><a href="#Embedder">Embedder</a></code> is responsible for preprocessing secret message and
embedding it.</p>
</div>


                            <div id="Embedder.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Embedder.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">Embedder</span><span class="signature">()</span>
    </div>

    
    

                            </div>
                            <div id="Embedder.get_secret_data" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Embedder.get_secret_data">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">get_secret_data</span><span class="signature">(secret_message: str) -&gt; tuple</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embedder.get_secret_data-41"><a href="#Embedder.get_secret_data-41"><span class="linenos">41</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder.get_secret_data-42"><a href="#Embedder.get_secret_data-42"><span class="linenos">42</span></a>    <span class="k">def</span> <span class="nf">get_secret_data</span><span class="p">(</span><span class="n">secret_message</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
</span><span id="Embedder.get_secret_data-43"><a href="#Embedder.get_secret_data-43"><span class="linenos">43</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder.get_secret_data-44"><a href="#Embedder.get_secret_data-44"><span class="linenos">44</span></a><span class="sd">        Parse given secret message. If file path was given, content of</span>
</span><span id="Embedder.get_secret_data-45"><a href="#Embedder.get_secret_data-45"><span class="linenos">45</span></a><span class="sd">        it is going to be converted to bytes and embedded, and file</span>
</span><span id="Embedder.get_secret_data-46"><a href="#Embedder.get_secret_data-46"><span class="linenos">46</span></a><span class="sd">        extension is parsed and converted as well. If only string was</span>
</span><span id="Embedder.get_secret_data-47"><a href="#Embedder.get_secret_data-47"><span class="linenos">47</span></a><span class="sd">        given it&#39;s coverted to bytes as well, and file extension txt</span>
</span><span id="Embedder.get_secret_data-48"><a href="#Embedder.get_secret_data-48"><span class="linenos">48</span></a><span class="sd">        will be embedded.</span>
</span><span id="Embedder.get_secret_data-49"><a href="#Embedder.get_secret_data-49"><span class="linenos">49</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder.get_secret_data-50"><a href="#Embedder.get_secret_data-50"><span class="linenos">50</span></a>        
</span><span id="Embedder.get_secret_data-51"><a href="#Embedder.get_secret_data-51"><span class="linenos">51</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">secret_message</span><span class="p">):</span>
</span><span id="Embedder.get_secret_data-52"><a href="#Embedder.get_secret_data-52"><span class="linenos">52</span></a>            <span class="c1"># The whole file is going to be embedded.</span>
</span><span id="Embedder.get_secret_data-53"><a href="#Embedder.get_secret_data-53"><span class="linenos">53</span></a>            <span class="n">b_fext</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_file_extension</span><span class="p">(</span><span class="n">secret_message</span><span class="p">)</span>
</span><span id="Embedder.get_secret_data-54"><a href="#Embedder.get_secret_data-54"><span class="linenos">54</span></a>            
</span><span id="Embedder.get_secret_data-55"><a href="#Embedder.get_secret_data-55"><span class="linenos">55</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="Embedder.get_secret_data-56"><a href="#Embedder.get_secret_data-56"><span class="linenos">56</span></a>                <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">secret_message</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
</span><span id="Embedder.get_secret_data-57"><a href="#Embedder.get_secret_data-57"><span class="linenos">57</span></a>            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="Embedder.get_secret_data-58"><a href="#Embedder.get_secret_data-58"><span class="linenos">58</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR! Can not access file of embedding data: </span><span class="si">{args.secret_message}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder.get_secret_data-59"><a href="#Embedder.get_secret_data-59"><span class="linenos">59</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="Embedder.get_secret_data-60"><a href="#Embedder.get_secret_data-60"><span class="linenos">60</span></a>            
</span><span id="Embedder.get_secret_data-61"><a href="#Embedder.get_secret_data-61"><span class="linenos">61</span></a>            <span class="n">b_secret_data</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="Embedder.get_secret_data-62"><a href="#Embedder.get_secret_data-62"><span class="linenos">62</span></a>            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Embedder.get_secret_data-63"><a href="#Embedder.get_secret_data-63"><span class="linenos">63</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder.get_secret_data-64"><a href="#Embedder.get_secret_data-64"><span class="linenos">64</span></a>            <span class="c1"># Embedded will be just string.</span>
</span><span id="Embedder.get_secret_data-65"><a href="#Embedder.get_secret_data-65"><span class="linenos">65</span></a>            <span class="n">b_secret_data</span> <span class="o">=</span> <span class="n">secret_message</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span><span id="Embedder.get_secret_data-66"><a href="#Embedder.get_secret_data-66"><span class="linenos">66</span></a>            <span class="c1"># If no file was given, txt extension will be used (8 bytes).</span>
</span><span id="Embedder.get_secret_data-67"><a href="#Embedder.get_secret_data-67"><span class="linenos">67</span></a>            <span class="n">b_fext</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;txt&#39;</span>
</span><span id="Embedder.get_secret_data-68"><a href="#Embedder.get_secret_data-68"><span class="linenos">68</span></a>            <span class="n">b_fext</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_fext</span><span class="p">))</span>
</span><span id="Embedder.get_secret_data-69"><a href="#Embedder.get_secret_data-69"><span class="linenos">69</span></a>        
</span><span id="Embedder.get_secret_data-70"><a href="#Embedder.get_secret_data-70"><span class="linenos">70</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">b_secret_data</span><span class="p">,</span> <span class="n">b_fext</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Parse given secret message. If file path was given, content of
it is going to be converted to bytes and embedded, and file
extension is parsed and converted as well. If only string was
given it's coverted to bytes as well, and file extension txt
will be embedded.</p>
</div>


                            </div>
                            <div id="Embedder.compress" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Embedder.compress">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">compress</span><span class="signature">(content: bytes) -&gt; bytes</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embedder.compress-73"><a href="#Embedder.compress-73"><span class="linenos">73</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder.compress-74"><a href="#Embedder.compress-74"><span class="linenos">74</span></a>    <span class="k">def</span> <span class="nf">compress</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder.compress-75"><a href="#Embedder.compress-75"><span class="linenos">75</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder.compress-76"><a href="#Embedder.compress-76"><span class="linenos">76</span></a><span class="sd">        Compress given bytes with LZMA algorithm.</span>
</span><span id="Embedder.compress-77"><a href="#Embedder.compress-77"><span class="linenos">77</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder.compress-78"><a href="#Embedder.compress-78"><span class="linenos">78</span></a>        
</span><span id="Embedder.compress-79"><a href="#Embedder.compress-79"><span class="linenos">79</span></a>        <span class="n">lzc</span> <span class="o">=</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMACompressor</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">lzma</span><span class="o">.</span><span class="n">FORMAT_XZ</span><span class="p">,</span> <span class="n">preset</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="Embedder.compress-80"><a href="#Embedder.compress-80"><span class="linenos">80</span></a>        
</span><span id="Embedder.compress-81"><a href="#Embedder.compress-81"><span class="linenos">81</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Embedder.compress-82"><a href="#Embedder.compress-82"><span class="linenos">82</span></a>            <span class="n">b_comp1</span> <span class="o">=</span> <span class="n">lzc</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
</span><span id="Embedder.compress-83"><a href="#Embedder.compress-83"><span class="linenos">83</span></a>        <span class="k">except</span> <span class="n">lzma</span><span class="o">.</span><span class="n">LZMAError</span><span class="p">:</span>
</span><span id="Embedder.compress-84"><a href="#Embedder.compress-84"><span class="linenos">84</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR! While preprocessing secret message an error occured.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder.compress-85"><a href="#Embedder.compress-85"><span class="linenos">85</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="Embedder.compress-86"><a href="#Embedder.compress-86"><span class="linenos">86</span></a>        
</span><span id="Embedder.compress-87"><a href="#Embedder.compress-87"><span class="linenos">87</span></a>        <span class="n">b_comp2</span> <span class="o">=</span> <span class="n">lzc</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="Embedder.compress-88"><a href="#Embedder.compress-88"><span class="linenos">88</span></a>        
</span><span id="Embedder.compress-89"><a href="#Embedder.compress-89"><span class="linenos">89</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">b_comp1</span> <span class="o">+</span> <span class="n">b_comp2</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Compress given bytes with LZMA algorithm.</p>
</div>


                            </div>
                            <div id="Embedder.encrypt_data" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Embedder.encrypt_data">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">encrypt_data</span><span class="signature">(cls, data: bytes, passwd: str) -&gt; bytes</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embedder.encrypt_data-92"><a href="#Embedder.encrypt_data-92"><span class="linenos"> 92</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder.encrypt_data-93"><a href="#Embedder.encrypt_data-93"><span class="linenos"> 93</span></a>    <span class="k">def</span> <span class="nf">encrypt_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">passwd</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder.encrypt_data-94"><a href="#Embedder.encrypt_data-94"><span class="linenos"> 94</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder.encrypt_data-95"><a href="#Embedder.encrypt_data-95"><span class="linenos"> 95</span></a><span class="sd">        Encrypt given data in bytes with given password.</span>
</span><span id="Embedder.encrypt_data-96"><a href="#Embedder.encrypt_data-96"><span class="linenos"> 96</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder.encrypt_data-97"><a href="#Embedder.encrypt_data-97"><span class="linenos"> 97</span></a>        <span class="n">b_key</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">gen_key_from_passwd</span><span class="p">(</span><span class="n">passwd</span><span class="p">)</span>
</span><span id="Embedder.encrypt_data-98"><a href="#Embedder.encrypt_data-98"><span class="linenos"> 98</span></a>        <span class="n">cipher</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">b_key</span><span class="p">)</span>
</span><span id="Embedder.encrypt_data-99"><a href="#Embedder.encrypt_data-99"><span class="linenos"> 99</span></a>        <span class="n">b_encrypted</span> <span class="o">=</span> <span class="n">cipher</span><span class="o">.</span><span class="n">encrypt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span id="Embedder.encrypt_data-100"><a href="#Embedder.encrypt_data-100"><span class="linenos">100</span></a>        
</span><span id="Embedder.encrypt_data-101"><a href="#Embedder.encrypt_data-101"><span class="linenos">101</span></a>        <span class="k">return</span> <span class="n">b_encrypted</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Encrypt given data in bytes with given password.</p>
</div>


                            </div>
                            <div id="Embedder.xor_data_len" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Embedder.xor_data_len">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">xor_data_len</span><span class="signature">(cls, encrypted: bytes) -&gt; bytes</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embedder.xor_data_len-104"><a href="#Embedder.xor_data_len-104"><span class="linenos">104</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder.xor_data_len-105"><a href="#Embedder.xor_data_len-105"><span class="linenos">105</span></a>    <span class="k">def</span> <span class="nf">xor_data_len</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">encrypted</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder.xor_data_len-106"><a href="#Embedder.xor_data_len-106"><span class="linenos">106</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder.xor_data_len-107"><a href="#Embedder.xor_data_len-107"><span class="linenos">107</span></a><span class="sd">        Function returns XORed length of embedding data.</span>
</span><span id="Embedder.xor_data_len-108"><a href="#Embedder.xor_data_len-108"><span class="linenos">108</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder.xor_data_len-109"><a href="#Embedder.xor_data_len-109"><span class="linenos">109</span></a>
</span><span id="Embedder.xor_data_len-110"><a href="#Embedder.xor_data_len-110"><span class="linenos">110</span></a>        <span class="c1"># Must be in bytes, because password is in the bytes as well.</span>
</span><span id="Embedder.xor_data_len-111"><a href="#Embedder.xor_data_len-111"><span class="linenos">111</span></a>        <span class="n">b_encrypted_len</span> <span class="o">=</span> \
</span><span id="Embedder.xor_data_len-112"><a href="#Embedder.xor_data_len-112"><span class="linenos">112</span></a>           <span class="nb">len</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="Embedder.xor_data_len-113"><a href="#Embedder.xor_data_len-113"><span class="linenos">113</span></a>        
</span><span id="Embedder.xor_data_len-114"><a href="#Embedder.xor_data_len-114"><span class="linenos">114</span></a>        <span class="c1"># Prepare password length ONLY for XOR operation.</span>
</span><span id="Embedder.xor_data_len-115"><a href="#Embedder.xor_data_len-115"><span class="linenos">115</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">:</span>
</span><span id="Embedder.xor_data_len-116"><a href="#Embedder.xor_data_len-116"><span class="linenos">116</span></a>            <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span>
</span><span id="Embedder.xor_data_len-117"><a href="#Embedder.xor_data_len-117"><span class="linenos">117</span></a>            <span class="n">b_passwd</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">))</span>
</span><span id="Embedder.xor_data_len-118"><a href="#Embedder.xor_data_len-118"><span class="linenos">118</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder.xor_data_len-119"><a href="#Embedder.xor_data_len-119"><span class="linenos">119</span></a>            <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">[:</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span><span class="p">]</span>
</span><span id="Embedder.xor_data_len-120"><a href="#Embedder.xor_data_len-120"><span class="linenos">120</span></a>
</span><span id="Embedder.xor_data_len-121"><a href="#Embedder.xor_data_len-121"><span class="linenos">121</span></a>        <span class="c1"># Data length bytes are going to be XORed with password of same</span>
</span><span id="Embedder.xor_data_len-122"><a href="#Embedder.xor_data_len-122"><span class="linenos">122</span></a>        <span class="c1"># size. If given password is longer, it&#39;s truncated. This is</span>
</span><span id="Embedder.xor_data_len-123"><a href="#Embedder.xor_data_len-123"><span class="linenos">123</span></a>        <span class="c1"># security reason as if whole password bytes were XORed with null</span>
</span><span id="Embedder.xor_data_len-124"><a href="#Embedder.xor_data_len-124"><span class="linenos">124</span></a>        <span class="c1"># padding of data length bytes, password characters would map to</span>
</span><span id="Embedder.xor_data_len-125"><a href="#Embedder.xor_data_len-125"><span class="linenos">125</span></a>        <span class="c1"># the XORed data length and could be readable. Reversed cycle is</span>
</span><span id="Embedder.xor_data_len-126"><a href="#Embedder.xor_data_len-126"><span class="linenos">126</span></a>        <span class="c1"># used to avoid problem when null byte is in the middle of data.</span>
</span><span id="Embedder.xor_data_len-127"><a href="#Embedder.xor_data_len-127"><span class="linenos">127</span></a>        <span class="n">null_padding</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Embedder.xor_data_len-128"><a href="#Embedder.xor_data_len-128"><span class="linenos">128</span></a>        
</span><span id="Embedder.xor_data_len-129"><a href="#Embedder.xor_data_len-129"><span class="linenos">129</span></a>        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">b_encrypted_len</span><span class="p">):</span>
</span><span id="Embedder.xor_data_len-130"><a href="#Embedder.xor_data_len-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder.xor_data_len-131"><a href="#Embedder.xor_data_len-131"><span class="linenos">131</span></a>                <span class="k">break</span>
</span><span id="Embedder.xor_data_len-132"><a href="#Embedder.xor_data_len-132"><span class="linenos">132</span></a>            <span class="n">null_padding</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Embedder.xor_data_len-133"><a href="#Embedder.xor_data_len-133"><span class="linenos">133</span></a>        
</span><span id="Embedder.xor_data_len-134"><a href="#Embedder.xor_data_len-134"><span class="linenos">134</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="n">null_padding</span>
</span><span id="Embedder.xor_data_len-135"><a href="#Embedder.xor_data_len-135"><span class="linenos">135</span></a>        
</span><span id="Embedder.xor_data_len-136"><a href="#Embedder.xor_data_len-136"><span class="linenos">136</span></a>        <span class="n">b_xored_len</span> <span class="o">=</span> \
</span><span id="Embedder.xor_data_len-137"><a href="#Embedder.xor_data_len-137"><span class="linenos">137</span></a>            <span class="nb">bytes</span><span class="p">([</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">b_encrypted_len</span><span class="p">,</span> <span class="n">b_passwd</span><span class="p">[:</span><span class="n">i</span><span class="p">])])</span>
</span><span id="Embedder.xor_data_len-138"><a href="#Embedder.xor_data_len-138"><span class="linenos">138</span></a>        
</span><span id="Embedder.xor_data_len-139"><a href="#Embedder.xor_data_len-139"><span class="linenos">139</span></a>        <span class="c1"># Add null bytes after XOR.</span>
</span><span id="Embedder.xor_data_len-140"><a href="#Embedder.xor_data_len-140"><span class="linenos">140</span></a>        <span class="n">b_xored_len</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_DATA_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_xored_len</span><span class="p">))</span>
</span><span id="Embedder.xor_data_len-141"><a href="#Embedder.xor_data_len-141"><span class="linenos">141</span></a>        
</span><span id="Embedder.xor_data_len-142"><a href="#Embedder.xor_data_len-142"><span class="linenos">142</span></a>        <span class="k">return</span> <span class="n">b_xored_len</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Function returns XORed length of embedding data.</p>
</div>


                            </div>
                            <div id="Embedder.xor_fext" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Embedder.xor_fext">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">xor_fext</span><span class="signature">(cls, fext: bytes) -&gt; bytes</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embedder.xor_fext-145"><a href="#Embedder.xor_fext-145"><span class="linenos">145</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder.xor_fext-146"><a href="#Embedder.xor_fext-146"><span class="linenos">146</span></a>    <span class="k">def</span> <span class="nf">xor_fext</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fext</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span><span id="Embedder.xor_fext-147"><a href="#Embedder.xor_fext-147"><span class="linenos">147</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder.xor_fext-148"><a href="#Embedder.xor_fext-148"><span class="linenos">148</span></a><span class="sd">        XOR given file extension in bytes with password and return it.</span>
</span><span id="Embedder.xor_fext-149"><a href="#Embedder.xor_fext-149"><span class="linenos">149</span></a><span class="sd">        &quot;&quot;&quot;</span>   
</span><span id="Embedder.xor_fext-150"><a href="#Embedder.xor_fext-150"><span class="linenos">150</span></a>
</span><span id="Embedder.xor_fext-151"><a href="#Embedder.xor_fext-151"><span class="linenos">151</span></a>        <span class="c1"># XOR only if there is any file extension.</span>
</span><span id="Embedder.xor_fext-152"><a href="#Embedder.xor_fext-152"><span class="linenos">152</span></a>        <span class="k">if</span> <span class="n">fext</span> <span class="o">!=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">):</span>
</span><span id="Embedder.xor_fext-153"><a href="#Embedder.xor_fext-153"><span class="linenos">153</span></a>            <span class="c1"># Prepare password length ONLY for XOR operation.</span>
</span><span id="Embedder.xor_fext-154"><a href="#Embedder.xor_fext-154"><span class="linenos">154</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">:</span>
</span><span id="Embedder.xor_fext-155"><a href="#Embedder.xor_fext-155"><span class="linenos">155</span></a>                <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span>
</span><span id="Embedder.xor_fext-156"><a href="#Embedder.xor_fext-156"><span class="linenos">156</span></a>                <span class="n">b_passwd</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">))</span>
</span><span id="Embedder.xor_fext-157"><a href="#Embedder.xor_fext-157"><span class="linenos">157</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder.xor_fext-158"><a href="#Embedder.xor_fext-158"><span class="linenos">158</span></a>                <span class="n">b_passwd</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__b_passwd</span><span class="p">[:</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span><span class="p">]</span>
</span><span id="Embedder.xor_fext-159"><a href="#Embedder.xor_fext-159"><span class="linenos">159</span></a>            
</span><span id="Embedder.xor_fext-160"><a href="#Embedder.xor_fext-160"><span class="linenos">160</span></a>            <span class="c1"># File extension bytes are going to be XORed with password</span>
</span><span id="Embedder.xor_fext-161"><a href="#Embedder.xor_fext-161"><span class="linenos">161</span></a>            <span class="c1"># of same size. If given password is longer, it&#39;s truncated.</span>
</span><span id="Embedder.xor_fext-162"><a href="#Embedder.xor_fext-162"><span class="linenos">162</span></a>            <span class="c1"># This is security reason as if whole password bytes were</span>
</span><span id="Embedder.xor_fext-163"><a href="#Embedder.xor_fext-163"><span class="linenos">163</span></a>            <span class="c1"># XORed with null padding of data length bytes, password</span>
</span><span id="Embedder.xor_fext-164"><a href="#Embedder.xor_fext-164"><span class="linenos">164</span></a>            <span class="c1"># characters would map to the XORed data length and could be</span>
</span><span id="Embedder.xor_fext-165"><a href="#Embedder.xor_fext-165"><span class="linenos">165</span></a>            <span class="c1"># readable. Reversed cycle is used to avoid problem when</span>
</span><span id="Embedder.xor_fext-166"><a href="#Embedder.xor_fext-166"><span class="linenos">166</span></a>            <span class="c1"># null byte is in the middle of data.</span>
</span><span id="Embedder.xor_fext-167"><a href="#Embedder.xor_fext-167"><span class="linenos">167</span></a>            <span class="n">null_padding</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Embedder.xor_fext-168"><a href="#Embedder.xor_fext-168"><span class="linenos">168</span></a>            
</span><span id="Embedder.xor_fext-169"><a href="#Embedder.xor_fext-169"><span class="linenos">169</span></a>            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">fext</span><span class="p">):</span>
</span><span id="Embedder.xor_fext-170"><a href="#Embedder.xor_fext-170"><span class="linenos">170</span></a>                <span class="k">if</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder.xor_fext-171"><a href="#Embedder.xor_fext-171"><span class="linenos">171</span></a>                    <span class="k">break</span>
</span><span id="Embedder.xor_fext-172"><a href="#Embedder.xor_fext-172"><span class="linenos">172</span></a>                <span class="n">null_padding</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="Embedder.xor_fext-173"><a href="#Embedder.xor_fext-173"><span class="linenos">173</span></a>            
</span><span id="Embedder.xor_fext-174"><a href="#Embedder.xor_fext-174"><span class="linenos">174</span></a>            <span class="n">i</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="n">null_padding</span>
</span><span id="Embedder.xor_fext-175"><a href="#Embedder.xor_fext-175"><span class="linenos">175</span></a>            
</span><span id="Embedder.xor_fext-176"><a href="#Embedder.xor_fext-176"><span class="linenos">176</span></a>            <span class="n">b_xored_fext</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">a</span> <span class="o">^</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fext</span><span class="p">,</span> <span class="n">b_passwd</span><span class="p">[:</span><span class="n">i</span><span class="p">])])</span>
</span><span id="Embedder.xor_fext-177"><a href="#Embedder.xor_fext-177"><span class="linenos">177</span></a>            
</span><span id="Embedder.xor_fext-178"><a href="#Embedder.xor_fext-178"><span class="linenos">178</span></a>            <span class="c1"># Add null bytes after XOR.</span>
</span><span id="Embedder.xor_fext-179"><a href="#Embedder.xor_fext-179"><span class="linenos">179</span></a>            <span class="n">b_xored_fext</span> <span class="o">+=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SIZE_OF_FEXT</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_xored_fext</span><span class="p">))</span>
</span><span id="Embedder.xor_fext-180"><a href="#Embedder.xor_fext-180"><span class="linenos">180</span></a>            
</span><span id="Embedder.xor_fext-181"><a href="#Embedder.xor_fext-181"><span class="linenos">181</span></a>            <span class="k">return</span> <span class="n">b_xored_fext</span>
</span><span id="Embedder.xor_fext-182"><a href="#Embedder.xor_fext-182"><span class="linenos">182</span></a>        
</span><span id="Embedder.xor_fext-183"><a href="#Embedder.xor_fext-183"><span class="linenos">183</span></a>        <span class="k">return</span> <span class="n">fext</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>XOR given file extension in bytes with password and return it.</p>
</div>


                            </div>
                            <div id="Embedder.check_cap" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Embedder.check_cap">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">check_cap</span><span class="signature">(mess_len: int, analyzer: <a href="analyzer.html#Analyzer">analyzer.Analyzer</a>) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embedder.check_cap-186"><a href="#Embedder.check_cap-186"><span class="linenos">186</span></a>    <span class="nd">@staticmethod</span>
</span><span id="Embedder.check_cap-187"><a href="#Embedder.check_cap-187"><span class="linenos">187</span></a>    <span class="k">def</span> <span class="nf">check_cap</span><span class="p">(</span><span class="n">mess_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">analyzer</span><span class="p">:</span> <span class="n">Analyzer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Embedder.check_cap-188"><a href="#Embedder.check_cap-188"><span class="linenos">188</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder.check_cap-189"><a href="#Embedder.check_cap-189"><span class="linenos">189</span></a><span class="sd">        Check if message with given length after preprocessing can be</span>
</span><span id="Embedder.check_cap-190"><a href="#Embedder.check_cap-190"><span class="linenos">190</span></a><span class="sd">        embedded and exit the program if not.</span>
</span><span id="Embedder.check_cap-191"><a href="#Embedder.check_cap-191"><span class="linenos">191</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder.check_cap-192"><a href="#Embedder.check_cap-192"><span class="linenos">192</span></a>
</span><span id="Embedder.check_cap-193"><a href="#Embedder.check_cap-193"><span class="linenos">193</span></a>        <span class="k">if</span> <span class="n">mess_len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">analyzer</span><span class="o">.</span><span class="n">min_capacity</span> <span class="o">/</span> <span class="mi">8</span><span class="p">):</span>
</span><span id="Embedder.check_cap-194"><a href="#Embedder.check_cap-194"><span class="linenos">194</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR! Capacity of cover-file is not sufficient and data can not be embedded!&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder.check_cap-195"><a href="#Embedder.check_cap-195"><span class="linenos">195</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Check if message with given length after preprocessing can be
embedded and exit the program if not.</p>
</div>


                            </div>
                            <div id="Embedder.embed" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#Embedder.embed">#&nbsp;&nbsp</a>

                <div class="decorator">@classmethod</div>

            <span class="def">def</span>
            <span class="name">embed</span><span class="signature">(
    cls,
    fexe: str,
    mess: bytes,
    potential_my_instrs: list,
    verbose: bool
) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embedder.embed-512"><a href="#Embedder.embed-512"><span class="linenos">512</span></a>    <span class="nd">@classmethod</span>
</span><span id="Embedder.embed-513"><a href="#Embedder.embed-513"><span class="linenos">513</span></a>    <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
</span><span id="Embedder.embed-514"><a href="#Embedder.embed-514"><span class="linenos">514</span></a>              <span class="n">fexe</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="Embedder.embed-515"><a href="#Embedder.embed-515"><span class="linenos">515</span></a>              <span class="n">mess</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span>
</span><span id="Embedder.embed-516"><a href="#Embedder.embed-516"><span class="linenos">516</span></a>              <span class="n">potential_my_instrs</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
</span><span id="Embedder.embed-517"><a href="#Embedder.embed-517"><span class="linenos">517</span></a>              <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Embedder.embed-518"><a href="#Embedder.embed-518"><span class="linenos">518</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embedder.embed-519"><a href="#Embedder.embed-519"><span class="linenos">519</span></a><span class="sd">        Embed given secret message.</span>
</span><span id="Embedder.embed-520"><a href="#Embedder.embed-520"><span class="linenos">520</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Embedder.embed-521"><a href="#Embedder.embed-521"><span class="linenos">521</span></a>
</span><span id="Embedder.embed-522"><a href="#Embedder.embed-522"><span class="linenos">522</span></a>        <span class="c1"># Skip flag defines how many next instructions should be</span>
</span><span id="Embedder.embed-523"><a href="#Embedder.embed-523"><span class="linenos">523</span></a>        <span class="c1"># skipped as they were already used by first instruction</span>
</span><span id="Embedder.embed-524"><a href="#Embedder.embed-524"><span class="linenos">524</span></a>        <span class="c1"># from their group (3 and 2 Bytes Long NOP classes).</span>
</span><span id="Embedder.embed-525"><a href="#Embedder.embed-525"><span class="linenos">525</span></a>        <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Embedder.embed-526"><a href="#Embedder.embed-526"><span class="linenos">526</span></a>        
</span><span id="Embedder.embed-527"><a href="#Embedder.embed-527"><span class="linenos">527</span></a>        <span class="c1"># Determines if MOVs were already scheduled. It&#39;s False at the</span>
</span><span id="Embedder.embed-528"><a href="#Embedder.embed-528"><span class="linenos">528</span></a>        <span class="c1"># beginning, but first MOV set it to True after they are</span>
</span><span id="Embedder.embed-529"><a href="#Embedder.embed-529"><span class="linenos">529</span></a>        <span class="c1"># scheduled.</span>
</span><span id="Embedder.embed-530"><a href="#Embedder.embed-530"><span class="linenos">530</span></a>        <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Embedder.embed-531"><a href="#Embedder.embed-531"><span class="linenos">531</span></a>        
</span><span id="Embedder.embed-532"><a href="#Embedder.embed-532"><span class="linenos">532</span></a>        <span class="n">bits_mess</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="s2">&quot;little&quot;</span><span class="p">)</span>
</span><span id="Embedder.embed-533"><a href="#Embedder.embed-533"><span class="linenos">533</span></a>        <span class="n">bits_mess</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">mess</span><span class="p">)</span>
</span><span id="Embedder.embed-534"><a href="#Embedder.embed-534"><span class="linenos">534</span></a>        
</span><span id="Embedder.embed-535"><a href="#Embedder.embed-535"><span class="linenos">535</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Embedder.embed-536"><a href="#Embedder.embed-536"><span class="linenos">536</span></a>            <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fexe</span><span class="p">,</span> <span class="s2">&quot;r+b&quot;</span><span class="p">)</span>
</span><span id="Embedder.embed-537"><a href="#Embedder.embed-537"><span class="linenos">537</span></a>        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="Embedder.embed-538"><a href="#Embedder.embed-538"><span class="linenos">538</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR! Can not open cover file for embedding: </span><span class="si">{</span><span class="n">fexe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Embedder.embed-539"><a href="#Embedder.embed-539"><span class="linenos">539</span></a>                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder.embed-540"><a href="#Embedder.embed-540"><span class="linenos">540</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">104</span><span class="p">)</span>
</span><span id="Embedder.embed-541"><a href="#Embedder.embed-541"><span class="linenos">541</span></a>        
</span><span id="Embedder.embed-542"><a href="#Embedder.embed-542"><span class="linenos">542</span></a>        <span class="k">for</span> <span class="n">instr_idx</span><span class="p">,</span> <span class="n">my_instr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">potential_my_instrs</span><span class="p">):</span>
</span><span id="Embedder.embed-543"><a href="#Embedder.embed-543"><span class="linenos">543</span></a>            
</span><span id="Embedder.embed-544"><a href="#Embedder.embed-544"><span class="linenos">544</span></a>            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
</span><span id="Embedder.embed-545"><a href="#Embedder.embed-545"><span class="linenos">545</span></a>                <span class="c1"># Skip current NOP instruction.</span>
</span><span id="Embedder.embed-546"><a href="#Embedder.embed-546"><span class="linenos">546</span></a>                <span class="n">skip</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="Embedder.embed-547"><a href="#Embedder.embed-547"><span class="linenos">547</span></a>                <span class="k">continue</span>
</span><span id="Embedder.embed-548"><a href="#Embedder.embed-548"><span class="linenos">548</span></a>            
</span><span id="Embedder.embed-549"><a href="#Embedder.embed-549"><span class="linenos">549</span></a>            <span class="c1"># For speed performance.</span>
</span><span id="Embedder.embed-550"><a href="#Embedder.embed-550"><span class="linenos">550</span></a>            <span class="n">eq_class</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">eq_class</span>
</span><span id="Embedder.embed-551"><a href="#Embedder.embed-551"><span class="linenos">551</span></a>            <span class="n">instr</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">instruction</span>
</span><span id="Embedder.embed-552"><a href="#Embedder.embed-552"><span class="linenos">552</span></a>            
</span><span id="Embedder.embed-553"><a href="#Embedder.embed-553"><span class="linenos">553</span></a>            <span class="c1"># Instructions that don&#39;t have encoding LEGACY are skipped.</span>
</span><span id="Embedder.embed-554"><a href="#Embedder.embed-554"><span class="linenos">554</span></a>            <span class="c1"># Legacy encoding for opcodes of instructions is mainly used</span>
</span><span id="Embedder.embed-555"><a href="#Embedder.embed-555"><span class="linenos">555</span></a>            <span class="c1"># in each PE and ELF (32- and 64-bit) executables and others</span>
</span><span id="Embedder.embed-556"><a href="#Embedder.embed-556"><span class="linenos">556</span></a>            <span class="c1"># encodings are very rare.</span>
</span><span id="Embedder.embed-557"><a href="#Embedder.embed-557"><span class="linenos">557</span></a>            <span class="k">if</span> <span class="n">eq_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
</span><span id="Embedder.embed-558"><a href="#Embedder.embed-558"><span class="linenos">558</span></a>                <span class="n">instr</span><span class="o">.</span><span class="n">encoding</span> <span class="o">==</span> <span class="n">EncodingKind</span><span class="o">.</span><span class="n">LEGACY</span><span class="p">:</span>
</span><span id="Embedder.embed-559"><a href="#Embedder.embed-559"><span class="linenos">559</span></a>                
</span><span id="Embedder.embed-560"><a href="#Embedder.embed-560"><span class="linenos">560</span></a>                <span class="c1"># Encoding is lexicographic order of used instructions</span>
</span><span id="Embedder.embed-561"><a href="#Embedder.embed-561"><span class="linenos">561</span></a>                <span class="c1"># strings and it&#39;s determined by configuration file.</span>
</span><span id="Embedder.embed-562"><a href="#Embedder.embed-562"><span class="linenos">562</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;MOV Scheduling&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder.embed-563"><a href="#Embedder.embed-563"><span class="linenos">563</span></a>                    <span class="n">my_instr</span><span class="o">.</span><span class="n">mov_scheduling_flag</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">movs_scheduled</span><span class="p">:</span>
</span><span id="Embedder.embed-564"><a href="#Embedder.embed-564"><span class="linenos">564</span></a>
</span><span id="Embedder.embed-565"><a href="#Embedder.embed-565"><span class="linenos">565</span></a>                    <span class="c1">## Second MOV is current, both can be scheduled now.</span>
</span><span id="Embedder.embed-566"><a href="#Embedder.embed-566"><span class="linenos">566</span></a>
</span><span id="Embedder.embed-567"><a href="#Embedder.embed-567"><span class="linenos">567</span></a>                    <span class="c1"># Set flag with first MOV - This is only tag for</span>
</span><span id="Embedder.embed-568"><a href="#Embedder.embed-568"><span class="linenos">568</span></a>                    <span class="c1"># knowledge that first MOV was tried to be scheduled.</span>
</span><span id="Embedder.embed-569"><a href="#Embedder.embed-569"><span class="linenos">569</span></a>                    <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Embedder.embed-570"><a href="#Embedder.embed-570"><span class="linenos">570</span></a>
</span><span id="Embedder.embed-571"><a href="#Embedder.embed-571"><span class="linenos">571</span></a>                    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__can_schedule_mov</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span>
</span><span id="Embedder.embed-572"><a href="#Embedder.embed-572"><span class="linenos">572</span></a>                                              <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
</span><span id="Embedder.embed-573"><a href="#Embedder.embed-573"><span class="linenos">573</span></a>                    
</span><span id="Embedder.embed-574"><a href="#Embedder.embed-574"><span class="linenos">574</span></a>                        <span class="n">next_mov</span> <span class="o">=</span> <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Embedder.embed-575"><a href="#Embedder.embed-575"><span class="linenos">575</span></a>                        
</span><span id="Embedder.embed-576"><a href="#Embedder.embed-576"><span class="linenos">576</span></a>                        <span class="c1"># Find out desired order for MOVs according to</span>
</span><span id="Embedder.embed-577"><a href="#Embedder.embed-577"><span class="linenos">577</span></a>                        <span class="c1"># the encoding.</span>
</span><span id="Embedder.embed-578"><a href="#Embedder.embed-578"><span class="linenos">578</span></a>                        <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder.embed-579"><a href="#Embedder.embed-579"><span class="linenos">579</span></a>
</span><span id="Embedder.embed-580"><a href="#Embedder.embed-580"><span class="linenos">580</span></a>                        <span class="c1"># Decide if both MOVs should be swapped according to</span>
</span><span id="Embedder.embed-581"><a href="#Embedder.embed-581"><span class="linenos">581</span></a>                        <span class="c1"># the next secret message bits or if they are in the</span>
</span><span id="Embedder.embed-582"><a href="#Embedder.embed-582"><span class="linenos">582</span></a>                        <span class="c1"># right order.</span>
</span><span id="Embedder.embed-583"><a href="#Embedder.embed-583"><span class="linenos">583</span></a>                        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__should_swap_mov</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">next_mov</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="Embedder.embed-584"><a href="#Embedder.embed-584"><span class="linenos">584</span></a>                            <span class="c1"># MOVs are going to be swapped.</span>
</span><span id="Embedder.embed-585"><a href="#Embedder.embed-585"><span class="linenos">585</span></a>                            
</span><span id="Embedder.embed-586"><a href="#Embedder.embed-586"><span class="linenos">586</span></a>                            <span class="c1"># Read instruction bytes of 1st MOV.</span>
</span><span id="Embedder.embed-587"><a href="#Embedder.embed-587"><span class="linenos">587</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-588"><a href="#Embedder.embed-588"><span class="linenos">588</span></a>                            <span class="n">b_mov0_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder.embed-589"><a href="#Embedder.embed-589"><span class="linenos">589</span></a>                            
</span><span id="Embedder.embed-590"><a href="#Embedder.embed-590"><span class="linenos">590</span></a>                            <span class="c1"># Read instruction bytes of 2nd MOV.</span>
</span><span id="Embedder.embed-591"><a href="#Embedder.embed-591"><span class="linenos">591</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-592"><a href="#Embedder.embed-592"><span class="linenos">592</span></a>                            <span class="n">b_mov1_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">instruction</span><span class="p">))</span>
</span><span id="Embedder.embed-593"><a href="#Embedder.embed-593"><span class="linenos">593</span></a>                            
</span><span id="Embedder.embed-594"><a href="#Embedder.embed-594"><span class="linenos">594</span></a>                            <span class="c1"># Swap them.</span>
</span><span id="Embedder.embed-595"><a href="#Embedder.embed-595"><span class="linenos">595</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-596"><a href="#Embedder.embed-596"><span class="linenos">596</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_mov1_fromf</span><span class="p">)</span>
</span><span id="Embedder.embed-597"><a href="#Embedder.embed-597"><span class="linenos">597</span></a>                            
</span><span id="Embedder.embed-598"><a href="#Embedder.embed-598"><span class="linenos">598</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_mov</span><span class="o">.</span><span class="n">instruction</span><span class="p">))</span>
</span><span id="Embedder.embed-599"><a href="#Embedder.embed-599"><span class="linenos">599</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_mov0_fromf</span><span class="p">)</span>
</span><span id="Embedder.embed-600"><a href="#Embedder.embed-600"><span class="linenos">600</span></a>                            
</span><span id="Embedder.embed-601"><a href="#Embedder.embed-601"><span class="linenos">601</span></a>                        <span class="c1"># Delete already embedded order bit from list.</span>
</span><span id="Embedder.embed-602"><a href="#Embedder.embed-602"><span class="linenos">602</span></a>                        <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-603"><a href="#Embedder.embed-603"><span class="linenos">603</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder.embed-604"><a href="#Embedder.embed-604"><span class="linenos">604</span></a>                    <span class="c1"># Unset flag with second MOV.</span>
</span><span id="Embedder.embed-605"><a href="#Embedder.embed-605"><span class="linenos">605</span></a>                    <span class="n">movs_scheduled</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Embedder.embed-606"><a href="#Embedder.embed-606"><span class="linenos">606</span></a>                
</span><span id="Embedder.embed-607"><a href="#Embedder.embed-607"><span class="linenos">607</span></a>                
</span><span id="Embedder.embed-608"><a href="#Embedder.embed-608"><span class="linenos">608</span></a>                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:MOV|ADD|SUB|AND|OR|XOR|CMP|ADC|SBB)$&quot;</span><span class="p">,</span>
</span><span id="Embedder.embed-609"><a href="#Embedder.embed-609"><span class="linenos">609</span></a>                          <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="p">):</span>
</span><span id="Embedder.embed-610"><a href="#Embedder.embed-610"><span class="linenos">610</span></a>                    <span class="c1"># Form of instruction changes (r/m, r &lt;=&gt; r, r/m),</span>
</span><span id="Embedder.embed-611"><a href="#Embedder.embed-611"><span class="linenos">611</span></a>                    <span class="c1"># therefore, also, operands must be changed. If REX</span>
</span><span id="Embedder.embed-612"><a href="#Embedder.embed-612"><span class="linenos">612</span></a>                    <span class="c1"># prefix is present, proper bits of prefix are</span>
</span><span id="Embedder.embed-613"><a href="#Embedder.embed-613"><span class="linenos">613</span></a>                    <span class="c1"># exchanged, as well.</span>
</span><span id="Embedder.embed-614"><a href="#Embedder.embed-614"><span class="linenos">614</span></a>                    <span class="c1"># MOV instruction form this class can also be</span>
</span><span id="Embedder.embed-615"><a href="#Embedder.embed-615"><span class="linenos">615</span></a>                    <span class="c1"># scheduled.</span>
</span><span id="Embedder.embed-616"><a href="#Embedder.embed-616"><span class="linenos">616</span></a>
</span><span id="Embedder.embed-617"><a href="#Embedder.embed-617"><span class="linenos">617</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder.embed-618"><a href="#Embedder.embed-618"><span class="linenos">618</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder.embed-619"><a href="#Embedder.embed-619"><span class="linenos">619</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-620"><a href="#Embedder.embed-620"><span class="linenos">620</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder.embed-621"><a href="#Embedder.embed-621"><span class="linenos">621</span></a>                    
</span><span id="Embedder.embed-622"><a href="#Embedder.embed-622"><span class="linenos">622</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder.embed-623"><a href="#Embedder.embed-623"><span class="linenos">623</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder.embed-624"><a href="#Embedder.embed-624"><span class="linenos">624</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder.embed-625"><a href="#Embedder.embed-625"><span class="linenos">625</span></a>                    
</span><span id="Embedder.embed-626"><a href="#Embedder.embed-626"><span class="linenos">626</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder.embed-627"><a href="#Embedder.embed-627"><span class="linenos">627</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder.embed-628"><a href="#Embedder.embed-628"><span class="linenos">628</span></a>                    
</span><span id="Embedder.embed-629"><a href="#Embedder.embed-629"><span class="linenos">629</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder.embed-630"><a href="#Embedder.embed-630"><span class="linenos">630</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder.embed-631"><a href="#Embedder.embed-631"><span class="linenos">631</span></a>                    
</span><span id="Embedder.embed-632"><a href="#Embedder.embed-632"><span class="linenos">632</span></a>                    <span class="c1"># Find Direction bit to embed according to the</span>
</span><span id="Embedder.embed-633"><a href="#Embedder.embed-633"><span class="linenos">633</span></a>                    <span class="c1"># encoding.</span>
</span><span id="Embedder.embed-634"><a href="#Embedder.embed-634"><span class="linenos">634</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder.embed-635"><a href="#Embedder.embed-635"><span class="linenos">635</span></a>                    <span class="n">new_dir_bit</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder.embed-636"><a href="#Embedder.embed-636"><span class="linenos">636</span></a>                    
</span><span id="Embedder.embed-637"><a href="#Embedder.embed-637"><span class="linenos">637</span></a>                    <span class="n">dir_bit_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="Embedder.embed-638"><a href="#Embedder.embed-638"><span class="linenos">638</span></a>                    <span class="c1"># decide if Direction bit is going to be swapped.</span>
</span><span id="Embedder.embed-639"><a href="#Embedder.embed-639"><span class="linenos">639</span></a>                    <span class="k">if</span> <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> \
</span><span id="Embedder.embed-640"><a href="#Embedder.embed-640"><span class="linenos">640</span></a>                        <span class="n">new_dir_bit</span><span class="p">:</span>
</span><span id="Embedder.embed-641"><a href="#Embedder.embed-641"><span class="linenos">641</span></a>                    
</span><span id="Embedder.embed-642"><a href="#Embedder.embed-642"><span class="linenos">642</span></a>                        <span class="c1"># Direction bit is going to be changed.</span>
</span><span id="Embedder.embed-643"><a href="#Embedder.embed-643"><span class="linenos">643</span></a>                        <span class="n">rex_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_rex_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="Embedder.embed-644"><a href="#Embedder.embed-644"><span class="linenos">644</span></a>                        
</span><span id="Embedder.embed-645"><a href="#Embedder.embed-645"><span class="linenos">645</span></a>                        <span class="c1"># Exchange Reg/Opcode and rm field of ModR/M byte.</span>
</span><span id="Embedder.embed-646"><a href="#Embedder.embed-646"><span class="linenos">646</span></a>                        <span class="bp">cls</span><span class="o">.</span><span class="n">__swap_rm_r_operands</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">,</span>
</span><span id="Embedder.embed-647"><a href="#Embedder.embed-647"><span class="linenos">647</span></a>                                                <span class="n">opcode_idx</span><span class="p">,</span>
</span><span id="Embedder.embed-648"><a href="#Embedder.embed-648"><span class="linenos">648</span></a>                                                <span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder.embed-649"><a href="#Embedder.embed-649"><span class="linenos">649</span></a>                        
</span><span id="Embedder.embed-650"><a href="#Embedder.embed-650"><span class="linenos">650</span></a>                        <span class="c1"># Rewrite Direction bit inside opcode of instruction.</span>
</span><span id="Embedder.embed-651"><a href="#Embedder.embed-651"><span class="linenos">651</span></a>                        <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
</span><span id="Embedder.embed-652"><a href="#Embedder.embed-652"><span class="linenos">652</span></a>                            <span class="n">new_dir_bit</span>
</span><span id="Embedder.embed-653"><a href="#Embedder.embed-653"><span class="linenos">653</span></a>                        
</span><span id="Embedder.embed-654"><a href="#Embedder.embed-654"><span class="linenos">654</span></a>                        <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder.embed-655"><a href="#Embedder.embed-655"><span class="linenos">655</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-656"><a href="#Embedder.embed-656"><span class="linenos">656</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder.embed-657"><a href="#Embedder.embed-657"><span class="linenos">657</span></a>                    
</span><span id="Embedder.embed-658"><a href="#Embedder.embed-658"><span class="linenos">658</span></a>                    <span class="c1"># Always 1, because embedded was only Direction bit.</span>
</span><span id="Embedder.embed-659"><a href="#Embedder.embed-659"><span class="linenos">659</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-660"><a href="#Embedder.embed-660"><span class="linenos">660</span></a>                
</span><span id="Embedder.embed-661"><a href="#Embedder.embed-661"><span class="linenos">661</span></a>                
</span><span id="Embedder.embed-662"><a href="#Embedder.embed-662"><span class="linenos">662</span></a>                <span class="c1"># Encoding is lexicographic order of used registers name</span>
</span><span id="Embedder.embed-663"><a href="#Embedder.embed-663"><span class="linenos">663</span></a>                <span class="c1"># and it&#39;s determined by configuration file.</span>
</span><span id="Embedder.embed-664"><a href="#Embedder.embed-664"><span class="linenos">664</span></a>                <span class="k">if</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;Swap base-index registers 32-bit&quot;</span><span class="p">:</span>
</span><span id="Embedder.embed-665"><a href="#Embedder.embed-665"><span class="linenos">665</span></a>                    <span class="c1"># Instruction form changes (SIB.base &lt;=&gt; SIB.index),</span>
</span><span id="Embedder.embed-666"><a href="#Embedder.embed-666"><span class="linenos">666</span></a>                    <span class="c1"># therefore, also, operands must be changed. If REX</span>
</span><span id="Embedder.embed-667"><a href="#Embedder.embed-667"><span class="linenos">667</span></a>                    <span class="c1"># prefix is present, proper bits of prefix are</span>
</span><span id="Embedder.embed-668"><a href="#Embedder.embed-668"><span class="linenos">668</span></a>                    <span class="c1"># exchanged, as well.</span>
</span><span id="Embedder.embed-669"><a href="#Embedder.embed-669"><span class="linenos">669</span></a>                    <span class="c1"># MOV instruction form this class can also be</span>
</span><span id="Embedder.embed-670"><a href="#Embedder.embed-670"><span class="linenos">670</span></a>                    <span class="c1"># scheduled.</span>
</span><span id="Embedder.embed-671"><a href="#Embedder.embed-671"><span class="linenos">671</span></a>
</span><span id="Embedder.embed-672"><a href="#Embedder.embed-672"><span class="linenos">672</span></a>                    <span class="c1"># Find out desired order for base-index according to</span>
</span><span id="Embedder.embed-673"><a href="#Embedder.embed-673"><span class="linenos">673</span></a>                    <span class="c1"># the encoding.</span>
</span><span id="Embedder.embed-674"><a href="#Embedder.embed-674"><span class="linenos">674</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder.embed-675"><a href="#Embedder.embed-675"><span class="linenos">675</span></a>                    
</span><span id="Embedder.embed-676"><a href="#Embedder.embed-676"><span class="linenos">676</span></a>                    <span class="c1"># Decide if base and index registers should be</span>
</span><span id="Embedder.embed-677"><a href="#Embedder.embed-677"><span class="linenos">677</span></a>                    <span class="c1"># swapped according to the next secret message bits</span>
</span><span id="Embedder.embed-678"><a href="#Embedder.embed-678"><span class="linenos">678</span></a>                    <span class="c1"># or if they are in the right order.</span>
</span><span id="Embedder.embed-679"><a href="#Embedder.embed-679"><span class="linenos">679</span></a>                    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__should_swap_base_index</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
</span><span id="Embedder.embed-680"><a href="#Embedder.embed-680"><span class="linenos">680</span></a>
</span><span id="Embedder.embed-681"><a href="#Embedder.embed-681"><span class="linenos">681</span></a>                        <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder.embed-682"><a href="#Embedder.embed-682"><span class="linenos">682</span></a>                        <span class="c1"># modify it.</span>
</span><span id="Embedder.embed-683"><a href="#Embedder.embed-683"><span class="linenos">683</span></a>                        <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-684"><a href="#Embedder.embed-684"><span class="linenos">684</span></a>                        <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder.embed-685"><a href="#Embedder.embed-685"><span class="linenos">685</span></a>                       
</span><span id="Embedder.embed-686"><a href="#Embedder.embed-686"><span class="linenos">686</span></a>                        <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder.embed-687"><a href="#Embedder.embed-687"><span class="linenos">687</span></a>                        <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder.embed-688"><a href="#Embedder.embed-688"><span class="linenos">688</span></a>                        <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder.embed-689"><a href="#Embedder.embed-689"><span class="linenos">689</span></a>                        
</span><span id="Embedder.embed-690"><a href="#Embedder.embed-690"><span class="linenos">690</span></a>                        <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder.embed-691"><a href="#Embedder.embed-691"><span class="linenos">691</span></a>                        <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder.embed-692"><a href="#Embedder.embed-692"><span class="linenos">692</span></a>                        
</span><span id="Embedder.embed-693"><a href="#Embedder.embed-693"><span class="linenos">693</span></a>                        <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder.embed-694"><a href="#Embedder.embed-694"><span class="linenos">694</span></a>                                                           <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder.embed-695"><a href="#Embedder.embed-695"><span class="linenos">695</span></a>                        
</span><span id="Embedder.embed-696"><a href="#Embedder.embed-696"><span class="linenos">696</span></a>                        <span class="n">rex_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_rex_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="Embedder.embed-697"><a href="#Embedder.embed-697"><span class="linenos">697</span></a>                        
</span><span id="Embedder.embed-698"><a href="#Embedder.embed-698"><span class="linenos">698</span></a>                        <span class="c1"># Swap registers. If swap is not successful,</span>
</span><span id="Embedder.embed-699"><a href="#Embedder.embed-699"><span class="linenos">699</span></a>                        <span class="c1"># nothing is embeddded and instr. is skipped.</span>
</span><span id="Embedder.embed-700"><a href="#Embedder.embed-700"><span class="linenos">700</span></a>                        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__swap_base_index</span><span class="p">(</span><span class="n">rex_idx</span><span class="p">,</span> <span class="n">opcode_idx</span><span class="p">,</span> <span class="n">bits_instr</span><span class="p">):</span>                        
</span><span id="Embedder.embed-701"><a href="#Embedder.embed-701"><span class="linenos">701</span></a>                            <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder.embed-702"><a href="#Embedder.embed-702"><span class="linenos">702</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-703"><a href="#Embedder.embed-703"><span class="linenos">703</span></a>                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder.embed-704"><a href="#Embedder.embed-704"><span class="linenos">704</span></a>                            
</span><span id="Embedder.embed-705"><a href="#Embedder.embed-705"><span class="linenos">705</span></a>                            <span class="c1"># Delete already embedded bit from list.</span>
</span><span id="Embedder.embed-706"><a href="#Embedder.embed-706"><span class="linenos">706</span></a>                            <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-707"><a href="#Embedder.embed-707"><span class="linenos">707</span></a>
</span><span id="Embedder.embed-708"><a href="#Embedder.embed-708"><span class="linenos">708</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder.embed-709"><a href="#Embedder.embed-709"><span class="linenos">709</span></a>                        <span class="c1"># Delete already embedded bit from list.</span>
</span><span id="Embedder.embed-710"><a href="#Embedder.embed-710"><span class="linenos">710</span></a>                        <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-711"><a href="#Embedder.embed-711"><span class="linenos">711</span></a>                        
</span><span id="Embedder.embed-712"><a href="#Embedder.embed-712"><span class="linenos">712</span></a>                
</span><span id="Embedder.embed-713"><a href="#Embedder.embed-713"><span class="linenos">713</span></a>                <span class="c1"># Classes can be together as their usage is based on</span>
</span><span id="Embedder.embed-714"><a href="#Embedder.embed-714"><span class="linenos">714</span></a>                <span class="c1"># exactly same principle.</span>
</span><span id="Embedder.embed-715"><a href="#Embedder.embed-715"><span class="linenos">715</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;2 Bytes Long NOP&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder.embed-716"><a href="#Embedder.embed-716"><span class="linenos">716</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;3 Bytes Long NOP&quot;</span><span class="p">:</span>
</span><span id="Embedder.embed-717"><a href="#Embedder.embed-717"><span class="linenos">717</span></a>
</span><span id="Embedder.embed-718"><a href="#Embedder.embed-718"><span class="linenos">718</span></a>                    <span class="c1"># Set skip flag for next instructions skipping.</span>
</span><span id="Embedder.embed-719"><a href="#Embedder.embed-719"><span class="linenos">719</span></a>                    <span class="n">skip</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">set_skip_flag</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span>
</span><span id="Embedder.embed-720"><a href="#Embedder.embed-720"><span class="linenos">720</span></a>                                                <span class="n">potential_my_instrs</span><span class="p">[</span><span class="n">instr_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="Embedder.embed-721"><a href="#Embedder.embed-721"><span class="linenos">721</span></a>
</span><span id="Embedder.embed-722"><a href="#Embedder.embed-722"><span class="linenos">722</span></a>                    <span class="c1"># Find bits to embed according to the encoding.</span>
</span><span id="Embedder.embed-723"><a href="#Embedder.embed-723"><span class="linenos">723</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder.embed-724"><a href="#Embedder.embed-724"><span class="linenos">724</span></a>
</span><span id="Embedder.embed-725"><a href="#Embedder.embed-725"><span class="linenos">725</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder.embed-726"><a href="#Embedder.embed-726"><span class="linenos">726</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-727"><a href="#Embedder.embed-727"><span class="linenos">727</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">2</span><span class="p">:]))</span>
</span><span id="Embedder.embed-728"><a href="#Embedder.embed-728"><span class="linenos">728</span></a>                    
</span><span id="Embedder.embed-729"><a href="#Embedder.embed-729"><span class="linenos">729</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder.embed-730"><a href="#Embedder.embed-730"><span class="linenos">730</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-731"><a href="#Embedder.embed-731"><span class="linenos">731</span></a>
</span><span id="Embedder.embed-732"><a href="#Embedder.embed-732"><span class="linenos">732</span></a>                
</span><span id="Embedder.embed-733"><a href="#Embedder.embed-733"><span class="linenos">733</span></a>                <span class="c1"># Class does not encodes class members, as it does not</span>
</span><span id="Embedder.embed-734"><a href="#Embedder.embed-734"><span class="linenos">734</span></a>                <span class="c1"># have any. In this case, bits from message are simply</span>
</span><span id="Embedder.embed-735"><a href="#Embedder.embed-735"><span class="linenos">735</span></a>                <span class="c1"># embedded to the last useable instruction bytes.</span>
</span><span id="Embedder.embed-736"><a href="#Embedder.embed-736"><span class="linenos">736</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;&gt;3 Bytes Long NOP&quot;</span><span class="p">:</span>
</span><span id="Embedder.embed-737"><a href="#Embedder.embed-737"><span class="linenos">737</span></a>
</span><span id="Embedder.embed-738"><a href="#Embedder.embed-738"><span class="linenos">738</span></a>                    <span class="c1"># Get number of bits available for embedding.</span>
</span><span id="Embedder.embed-739"><a href="#Embedder.embed-739"><span class="linenos">739</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-740"><a href="#Embedder.embed-740"><span class="linenos">740</span></a>                    <span class="n">bits_cnt</span> <span class="o">=</span> \
</span><span id="Embedder.embed-741"><a href="#Embedder.embed-741"><span class="linenos">741</span></a>                        <span class="n">common</span><span class="o">.</span><span class="n">count_useable_bits_from_nop</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span>
</span><span id="Embedder.embed-742"><a href="#Embedder.embed-742"><span class="linenos">742</span></a>                                                           <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)))</span>
</span><span id="Embedder.embed-743"><a href="#Embedder.embed-743"><span class="linenos">743</span></a>                    <span class="c1"># Take bits needed to embed.</span>
</span><span id="Embedder.embed-744"><a href="#Embedder.embed-744"><span class="linenos">744</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="n">bits_cnt</span><span class="p">]</span>
</span><span id="Embedder.embed-745"><a href="#Embedder.embed-745"><span class="linenos">745</span></a>
</span><span id="Embedder.embed-746"><a href="#Embedder.embed-746"><span class="linenos">746</span></a>                    <span class="c1"># There is 100% chance that it will be multiple of 8.</span>
</span><span id="Embedder.embed-747"><a href="#Embedder.embed-747"><span class="linenos">747</span></a>                    <span class="n">b_cnt</span> <span class="o">=</span> <span class="n">bits_cnt</span> <span class="o">//</span> <span class="mi">8</span>
</span><span id="Embedder.embed-748"><a href="#Embedder.embed-748"><span class="linenos">748</span></a>                    
</span><span id="Embedder.embed-749"><a href="#Embedder.embed-749"><span class="linenos">749</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder.embed-750"><a href="#Embedder.embed-750"><span class="linenos">750</span></a>                    <span class="n">pos</span> <span class="o">=</span> <span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span> <span class="o">-</span> <span class="n">b_cnt</span><span class="p">)</span>
</span><span id="Embedder.embed-751"><a href="#Embedder.embed-751"><span class="linenos">751</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
</span><span id="Embedder.embed-752"><a href="#Embedder.embed-752"><span class="linenos">752</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_to_embed</span><span class="p">)</span>
</span><span id="Embedder.embed-753"><a href="#Embedder.embed-753"><span class="linenos">753</span></a>
</span><span id="Embedder.embed-754"><a href="#Embedder.embed-754"><span class="linenos">754</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder.embed-755"><a href="#Embedder.embed-755"><span class="linenos">755</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">bits_to_embed</span><span class="p">)]</span>
</span><span id="Embedder.embed-756"><a href="#Embedder.embed-756"><span class="linenos">756</span></a>
</span><span id="Embedder.embed-757"><a href="#Embedder.embed-757"><span class="linenos">757</span></a>                
</span><span id="Embedder.embed-758"><a href="#Embedder.embed-758"><span class="linenos">758</span></a>                <span class="c1"># These two classes can be merged as they modify only</span>
</span><span id="Embedder.embed-759"><a href="#Embedder.embed-759"><span class="linenos">759</span></a>                <span class="c1"># Reg/Opcode field inside ModR/M byte.</span>
</span><span id="Embedder.embed-760"><a href="#Embedder.embed-760"><span class="linenos">760</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SHL/SAL&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder.embed-761"><a href="#Embedder.embed-761"><span class="linenos">761</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;TEST non-accumulator register&quot;</span><span class="p">:</span>
</span><span id="Embedder.embed-762"><a href="#Embedder.embed-762"><span class="linenos">762</span></a>
</span><span id="Embedder.embed-763"><a href="#Embedder.embed-763"><span class="linenos">763</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder.embed-764"><a href="#Embedder.embed-764"><span class="linenos">764</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder.embed-765"><a href="#Embedder.embed-765"><span class="linenos">765</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-766"><a href="#Embedder.embed-766"><span class="linenos">766</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder.embed-767"><a href="#Embedder.embed-767"><span class="linenos">767</span></a>                    
</span><span id="Embedder.embed-768"><a href="#Embedder.embed-768"><span class="linenos">768</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder.embed-769"><a href="#Embedder.embed-769"><span class="linenos">769</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder.embed-770"><a href="#Embedder.embed-770"><span class="linenos">770</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder.embed-771"><a href="#Embedder.embed-771"><span class="linenos">771</span></a>                    
</span><span id="Embedder.embed-772"><a href="#Embedder.embed-772"><span class="linenos">772</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder.embed-773"><a href="#Embedder.embed-773"><span class="linenos">773</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder.embed-774"><a href="#Embedder.embed-774"><span class="linenos">774</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder.embed-775"><a href="#Embedder.embed-775"><span class="linenos">775</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder.embed-776"><a href="#Embedder.embed-776"><span class="linenos">776</span></a>                    
</span><span id="Embedder.embed-777"><a href="#Embedder.embed-777"><span class="linenos">777</span></a>                    <span class="c1"># Find bits to embed according to the encoding.</span>
</span><span id="Embedder.embed-778"><a href="#Embedder.embed-778"><span class="linenos">778</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder.embed-779"><a href="#Embedder.embed-779"><span class="linenos">779</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder.embed-780"><a href="#Embedder.embed-780"><span class="linenos">780</span></a>
</span><span id="Embedder.embed-781"><a href="#Embedder.embed-781"><span class="linenos">781</span></a>                    <span class="c1"># Locate Reg/Opcode field inside ModR/M byte.</span>
</span><span id="Embedder.embed-782"><a href="#Embedder.embed-782"><span class="linenos">782</span></a>                    <span class="n">reg_field_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span>
</span><span id="Embedder.embed-783"><a href="#Embedder.embed-783"><span class="linenos">783</span></a>                    <span class="c1"># Rewrite required bits inside instruction.</span>
</span><span id="Embedder.embed-784"><a href="#Embedder.embed-784"><span class="linenos">784</span></a>                    <span class="n">bits_instr</span><span class="p">[</span><span class="n">reg_field_offset</span><span class="p">:(</span><span class="n">reg_field_offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> \
</span><span id="Embedder.embed-785"><a href="#Embedder.embed-785"><span class="linenos">785</span></a>                        <span class="n">bits_to_embed</span>
</span><span id="Embedder.embed-786"><a href="#Embedder.embed-786"><span class="linenos">786</span></a>
</span><span id="Embedder.embed-787"><a href="#Embedder.embed-787"><span class="linenos">787</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder.embed-788"><a href="#Embedder.embed-788"><span class="linenos">788</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-789"><a href="#Embedder.embed-789"><span class="linenos">789</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder.embed-790"><a href="#Embedder.embed-790"><span class="linenos">790</span></a>
</span><span id="Embedder.embed-791"><a href="#Embedder.embed-791"><span class="linenos">791</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder.embed-792"><a href="#Embedder.embed-792"><span class="linenos">792</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-793"><a href="#Embedder.embed-793"><span class="linenos">793</span></a>                
</span><span id="Embedder.embed-794"><a href="#Embedder.embed-794"><span class="linenos">794</span></a>                
</span><span id="Embedder.embed-795"><a href="#Embedder.embed-795"><span class="linenos">795</span></a>                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:ADD|SUB|AND|OR|XOR|CMP|ADC|SBB) 32-bit$&quot;</span><span class="p">,</span>
</span><span id="Embedder.embed-796"><a href="#Embedder.embed-796"><span class="linenos">796</span></a>                          <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="p">):</span>
</span><span id="Embedder.embed-797"><a href="#Embedder.embed-797"><span class="linenos">797</span></a>
</span><span id="Embedder.embed-798"><a href="#Embedder.embed-798"><span class="linenos">798</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder.embed-799"><a href="#Embedder.embed-799"><span class="linenos">799</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder.embed-800"><a href="#Embedder.embed-800"><span class="linenos">800</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-801"><a href="#Embedder.embed-801"><span class="linenos">801</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder.embed-802"><a href="#Embedder.embed-802"><span class="linenos">802</span></a>                    
</span><span id="Embedder.embed-803"><a href="#Embedder.embed-803"><span class="linenos">803</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder.embed-804"><a href="#Embedder.embed-804"><span class="linenos">804</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder.embed-805"><a href="#Embedder.embed-805"><span class="linenos">805</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder.embed-806"><a href="#Embedder.embed-806"><span class="linenos">806</span></a>                    
</span><span id="Embedder.embed-807"><a href="#Embedder.embed-807"><span class="linenos">807</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder.embed-808"><a href="#Embedder.embed-808"><span class="linenos">808</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder.embed-809"><a href="#Embedder.embed-809"><span class="linenos">809</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder.embed-810"><a href="#Embedder.embed-810"><span class="linenos">810</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder.embed-811"><a href="#Embedder.embed-811"><span class="linenos">811</span></a>
</span><span id="Embedder.embed-812"><a href="#Embedder.embed-812"><span class="linenos">812</span></a>                    <span class="c1"># Find Direction bit to embed according to the</span>
</span><span id="Embedder.embed-813"><a href="#Embedder.embed-813"><span class="linenos">813</span></a>                    <span class="c1"># encoding.</span>
</span><span id="Embedder.embed-814"><a href="#Embedder.embed-814"><span class="linenos">814</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder.embed-815"><a href="#Embedder.embed-815"><span class="linenos">815</span></a>                    <span class="n">dir_bit</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder.embed-816"><a href="#Embedder.embed-816"><span class="linenos">816</span></a>                    
</span><span id="Embedder.embed-817"><a href="#Embedder.embed-817"><span class="linenos">817</span></a>                    <span class="c1"># Rewrite Direction bit inside opcode of instruction.</span>
</span><span id="Embedder.embed-818"><a href="#Embedder.embed-818"><span class="linenos">818</span></a>                    <span class="n">dir_bit_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span>
</span><span id="Embedder.embed-819"><a href="#Embedder.embed-819"><span class="linenos">819</span></a>                    <span class="n">bits_instr</span><span class="p">[</span><span class="n">dir_bit_offset</span><span class="p">:</span><span class="n">dir_bit_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dir_bit</span>
</span><span id="Embedder.embed-820"><a href="#Embedder.embed-820"><span class="linenos">820</span></a>
</span><span id="Embedder.embed-821"><a href="#Embedder.embed-821"><span class="linenos">821</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder.embed-822"><a href="#Embedder.embed-822"><span class="linenos">822</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-823"><a href="#Embedder.embed-823"><span class="linenos">823</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder.embed-824"><a href="#Embedder.embed-824"><span class="linenos">824</span></a>                    
</span><span id="Embedder.embed-825"><a href="#Embedder.embed-825"><span class="linenos">825</span></a>                    <span class="c1"># Always 1, because embedded was only Direction bit.</span>
</span><span id="Embedder.embed-826"><a href="#Embedder.embed-826"><span class="linenos">826</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-827"><a href="#Embedder.embed-827"><span class="linenos">827</span></a>                
</span><span id="Embedder.embed-828"><a href="#Embedder.embed-828"><span class="linenos">828</span></a>                
</span><span id="Embedder.embed-829"><a href="#Embedder.embed-829"><span class="linenos">829</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SUB/XOR&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder.embed-830"><a href="#Embedder.embed-830"><span class="linenos">830</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;TEST/AND/OR&quot;</span><span class="p">:</span>
</span><span id="Embedder.embed-831"><a href="#Embedder.embed-831"><span class="linenos">831</span></a>
</span><span id="Embedder.embed-832"><a href="#Embedder.embed-832"><span class="linenos">832</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder.embed-833"><a href="#Embedder.embed-833"><span class="linenos">833</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder.embed-834"><a href="#Embedder.embed-834"><span class="linenos">834</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-835"><a href="#Embedder.embed-835"><span class="linenos">835</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder.embed-836"><a href="#Embedder.embed-836"><span class="linenos">836</span></a>                    
</span><span id="Embedder.embed-837"><a href="#Embedder.embed-837"><span class="linenos">837</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder.embed-838"><a href="#Embedder.embed-838"><span class="linenos">838</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder.embed-839"><a href="#Embedder.embed-839"><span class="linenos">839</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder.embed-840"><a href="#Embedder.embed-840"><span class="linenos">840</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder.embed-841"><a href="#Embedder.embed-841"><span class="linenos">841</span></a>                    
</span><span id="Embedder.embed-842"><a href="#Embedder.embed-842"><span class="linenos">842</span></a>                    <span class="c1"># Find Reg/Opcode bits to embed according to the</span>
</span><span id="Embedder.embed-843"><a href="#Embedder.embed-843"><span class="linenos">843</span></a>                    <span class="c1"># encoding.</span>
</span><span id="Embedder.embed-844"><a href="#Embedder.embed-844"><span class="linenos">844</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder.embed-845"><a href="#Embedder.embed-845"><span class="linenos">845</span></a>                    
</span><span id="Embedder.embed-846"><a href="#Embedder.embed-846"><span class="linenos">846</span></a>                    <span class="c1"># Creates desired opcode according to encoding bits.</span>
</span><span id="Embedder.embed-847"><a href="#Embedder.embed-847"><span class="linenos">847</span></a>                    <span class="n">b_new_opcode</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__create_opcode</span><span class="p">(</span><span class="n">my_instr</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="Embedder.embed-848"><a href="#Embedder.embed-848"><span class="linenos">848</span></a>                    
</span><span id="Embedder.embed-849"><a href="#Embedder.embed-849"><span class="linenos">849</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder.embed-850"><a href="#Embedder.embed-850"><span class="linenos">850</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span> <span class="o">+</span> <span class="n">opcode_idx</span><span class="p">)</span>
</span><span id="Embedder.embed-851"><a href="#Embedder.embed-851"><span class="linenos">851</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">b_new_opcode</span><span class="p">)</span>
</span><span id="Embedder.embed-852"><a href="#Embedder.embed-852"><span class="linenos">852</span></a>
</span><span id="Embedder.embed-853"><a href="#Embedder.embed-853"><span class="linenos">853</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder.embed-854"><a href="#Embedder.embed-854"><span class="linenos">854</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-855"><a href="#Embedder.embed-855"><span class="linenos">855</span></a>
</span><span id="Embedder.embed-856"><a href="#Embedder.embed-856"><span class="linenos">856</span></a>                
</span><span id="Embedder.embed-857"><a href="#Embedder.embed-857"><span class="linenos">857</span></a>                <span class="k">elif</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;ADD negated&quot;</span> <span class="ow">or</span> \
</span><span id="Embedder.embed-858"><a href="#Embedder.embed-858"><span class="linenos">858</span></a>                    <span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span> <span class="o">==</span> <span class="s2">&quot;SUB negated&quot;</span><span class="p">:</span>
</span><span id="Embedder.embed-859"><a href="#Embedder.embed-859"><span class="linenos">859</span></a>                    <span class="k">continue</span>
</span><span id="Embedder.embed-860"><a href="#Embedder.embed-860"><span class="linenos">860</span></a>                    <span class="nb">print</span><span class="p">()</span>
</span><span id="Embedder.embed-861"><a href="#Embedder.embed-861"><span class="linenos">861</span></a>                    <span class="c1">## nulu nemozem negovat, zachovam ju</span>
</span><span id="Embedder.embed-862"><a href="#Embedder.embed-862"><span class="linenos">862</span></a>                    <span class="c1"># NEGACIA imm je dvojkovy doplnek</span>
</span><span id="Embedder.embed-863"><a href="#Embedder.embed-863"><span class="linenos">863</span></a>                    <span class="c1"># ^^ 0x42 =&gt; -0x42 == (extended sign)FFF..BE</span>
</span><span id="Embedder.embed-864"><a href="#Embedder.embed-864"><span class="linenos">864</span></a>                    
</span><span id="Embedder.embed-865"><a href="#Embedder.embed-865"><span class="linenos">865</span></a>                    <span class="c1"># Read instruction bytes from file to be able to</span>
</span><span id="Embedder.embed-866"><a href="#Embedder.embed-866"><span class="linenos">866</span></a>                    <span class="c1"># modify it.</span>
</span><span id="Embedder.embed-867"><a href="#Embedder.embed-867"><span class="linenos">867</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-868"><a href="#Embedder.embed-868"><span class="linenos">868</span></a>                    <span class="n">b_instr_fromf</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instr</span><span class="p">))</span>
</span><span id="Embedder.embed-869"><a href="#Embedder.embed-869"><span class="linenos">869</span></a>                    
</span><span id="Embedder.embed-870"><a href="#Embedder.embed-870"><span class="linenos">870</span></a>                    <span class="c1"># Convert read instruction from bytes to bits.</span>
</span><span id="Embedder.embed-871"><a href="#Embedder.embed-871"><span class="linenos">871</span></a>                    <span class="n">bits_instr</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder.embed-872"><a href="#Embedder.embed-872"><span class="linenos">872</span></a>                    <span class="n">bits_instr</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">)</span>
</span><span id="Embedder.embed-873"><a href="#Embedder.embed-873"><span class="linenos">873</span></a>                    
</span><span id="Embedder.embed-874"><a href="#Embedder.embed-874"><span class="linenos">874</span></a>                    <span class="c1"># Get and find an opcode of instruction.</span>
</span><span id="Embedder.embed-875"><a href="#Embedder.embed-875"><span class="linenos">875</span></a>                    <span class="n">instr_opcode</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">op_code</span>
</span><span id="Embedder.embed-876"><a href="#Embedder.embed-876"><span class="linenos">876</span></a>                    <span class="n">opcode_idx</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_opcode_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder.embed-877"><a href="#Embedder.embed-877"><span class="linenos">877</span></a>                                                       <span class="n">instr_opcode</span><span class="p">)</span>
</span><span id="Embedder.embed-878"><a href="#Embedder.embed-878"><span class="linenos">878</span></a>                    
</span><span id="Embedder.embed-879"><a href="#Embedder.embed-879"><span class="linenos">879</span></a>                    <span class="c1"># Find Reg/Opcode bits to embed according to the</span>
</span><span id="Embedder.embed-880"><a href="#Embedder.embed-880"><span class="linenos">880</span></a>                    <span class="c1"># encoding.</span>
</span><span id="Embedder.embed-881"><a href="#Embedder.embed-881"><span class="linenos">881</span></a>                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__find_encoded_idx</span><span class="p">(</span><span class="n">eq_class</span><span class="p">,</span> <span class="n">bits_mess</span><span class="p">)</span>
</span><span id="Embedder.embed-882"><a href="#Embedder.embed-882"><span class="linenos">882</span></a>                    <span class="n">bits_to_embed</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">members</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</span><span id="Embedder.embed-883"><a href="#Embedder.embed-883"><span class="linenos">883</span></a>                    
</span><span id="Embedder.embed-884"><a href="#Embedder.embed-884"><span class="linenos">884</span></a>                    <span class="n">operand_size</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">operand_size</span>
</span><span id="Embedder.embed-885"><a href="#Embedder.embed-885"><span class="linenos">885</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class: </span><span class="si">{</span><span class="n">eq_class</span><span class="o">.</span><span class="n">class_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">instr: </span><span class="si">{</span><span class="n">instr</span><span class="si">}</span><span class="se">\n</span><span class="s2">b_instr_fromf: </span><span class="si">{</span><span class="n">b_instr_fromf</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">operand_size: </span><span class="si">{</span><span class="n">operand_size</span><span class="si">}</span><span class="se">\n</span><span class="s2">bits_to_embed: </span><span class="si">{</span><span class="n">bits_to_embed</span><span class="si">}</span><span class="se">\n</span><span class="s2">instr_opcode: </span><span class="si">{</span><span class="n">instr_opcode</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">opcode_idx</span><span class="si">}</span><span class="se">\n</span><span class="s2">bits_instr: </span><span class="si">{</span><span class="n">bits_instr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder.embed-886"><a href="#Embedder.embed-886"><span class="linenos">886</span></a>                    
</span><span id="Embedder.embed-887"><a href="#Embedder.embed-887"><span class="linenos">887</span></a>                    <span class="c1"># Embed ADD or SUB according to next encoding bits.</span>
</span><span id="Embedder.embed-888"><a href="#Embedder.embed-888"><span class="linenos">888</span></a>                    <span class="c1"># There is special case for 1 byte long AL register</span>
</span><span id="Embedder.embed-889"><a href="#Embedder.embed-889"><span class="linenos">889</span></a>                    <span class="c1"># operand which is also handled.</span>
</span><span id="Embedder.embed-890"><a href="#Embedder.embed-890"><span class="linenos">890</span></a>                    <span class="bp">cls</span><span class="o">.</span><span class="n">__make_ADD_SUB_opcode</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span>
</span><span id="Embedder.embed-891"><a href="#Embedder.embed-891"><span class="linenos">891</span></a>                                              <span class="n">opcode_idx</span><span class="p">,</span>
</span><span id="Embedder.embed-892"><a href="#Embedder.embed-892"><span class="linenos">892</span></a>                                              <span class="n">bits_to_embed</span><span class="p">,</span>
</span><span id="Embedder.embed-893"><a href="#Embedder.embed-893"><span class="linenos">893</span></a>                                              <span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder.embed-894"><a href="#Embedder.embed-894"><span class="linenos">894</span></a>                
</span><span id="Embedder.embed-895"><a href="#Embedder.embed-895"><span class="linenos">895</span></a>                    <span class="c1"># Make two&#39;s Complement of immediate (always last</span>
</span><span id="Embedder.embed-896"><a href="#Embedder.embed-896"><span class="linenos">896</span></a>                    <span class="c1"># bytes) if required - if ADD was changed to SUB and</span>
</span><span id="Embedder.embed-897"><a href="#Embedder.embed-897"><span class="linenos">897</span></a>                    <span class="c1"># vice versa. Also zero immediate can not be negated</span>
</span><span id="Embedder.embed-898"><a href="#Embedder.embed-898"><span class="linenos">898</span></a>                    <span class="c1"># as it has only one representation in two&#39;s</span>
</span><span id="Embedder.embed-899"><a href="#Embedder.embed-899"><span class="linenos">899</span></a>                    <span class="c1"># complement code.</span>
</span><span id="Embedder.embed-900"><a href="#Embedder.embed-900"><span class="linenos">900</span></a>                    <span class="k">if</span> <span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> \
</span><span id="Embedder.embed-901"><a href="#Embedder.embed-901"><span class="linenos">901</span></a>                        <span class="p">(</span> <span class="p">(</span>
</span><span id="Embedder.embed-902"><a href="#Embedder.embed-902"><span class="linenos">902</span></a>                            <span class="n">instr</span><span class="o">.</span><span class="n">mnemonic</span> <span class="o">==</span> <span class="n">Mnemonic</span><span class="o">.</span><span class="n">ADD</span> <span class="ow">and</span> \
</span><span id="Embedder.embed-903"><a href="#Embedder.embed-903"><span class="linenos">903</span></a>                            <span class="n">bits_to_embed</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;101&#39;</span><span class="p">)</span>
</span><span id="Embedder.embed-904"><a href="#Embedder.embed-904"><span class="linenos">904</span></a>                        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
</span><span id="Embedder.embed-905"><a href="#Embedder.embed-905"><span class="linenos">905</span></a>                            <span class="n">instr</span><span class="o">.</span><span class="n">mnemonic</span> <span class="o">==</span> <span class="n">Mnemonic</span><span class="o">.</span><span class="n">SUB</span> <span class="ow">and</span> \
</span><span id="Embedder.embed-906"><a href="#Embedder.embed-906"><span class="linenos">906</span></a>                            <span class="n">bits_to_embed</span> <span class="o">==</span> <span class="n">bitarray</span><span class="p">(</span><span class="s1">&#39;000&#39;</span><span class="p">)</span>
</span><span id="Embedder.embed-907"><a href="#Embedder.embed-907"><span class="linenos">907</span></a>                        <span class="p">)</span> <span class="p">):</span>
</span><span id="Embedder.embed-908"><a href="#Embedder.embed-908"><span class="linenos">908</span></a>                        <span class="c1"># It&#39;s ADD changing to SUB =&gt; swap sign.</span>
</span><span id="Embedder.embed-909"><a href="#Embedder.embed-909"><span class="linenos">909</span></a>                        <span class="c1"># or..</span>
</span><span id="Embedder.embed-910"><a href="#Embedder.embed-910"><span class="linenos">910</span></a>                        <span class="c1"># It&#39;s SUB changing to ADD =&gt; swap sign.</span>
</span><span id="Embedder.embed-911"><a href="#Embedder.embed-911"><span class="linenos">911</span></a>                        
</span><span id="Embedder.embed-912"><a href="#Embedder.embed-912"><span class="linenos">912</span></a>                        <span class="c1"># Get operand size in bytes.</span>
</span><span id="Embedder.embed-913"><a href="#Embedder.embed-913"><span class="linenos">913</span></a>                        <span class="n">op_size</span> <span class="o">=</span> <span class="n">OpCodeInfo</span><span class="p">(</span><span class="n">instr</span><span class="o">.</span><span class="n">code</span><span class="p">)</span><span class="o">.</span><span class="n">operand_size</span> <span class="o">//</span> <span class="mi">8</span>
</span><span id="Embedder.embed-914"><a href="#Embedder.embed-914"><span class="linenos">914</span></a>                        <span class="k">if</span> <span class="n">op_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embedder.embed-915"><a href="#Embedder.embed-915"><span class="linenos">915</span></a>                            <span class="c1"># For 1 byte long operands function returns 0.</span>
</span><span id="Embedder.embed-916"><a href="#Embedder.embed-916"><span class="linenos">916</span></a>                            <span class="n">op_size</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="Embedder.embed-917"><a href="#Embedder.embed-917"><span class="linenos">917</span></a>                        <span class="k">elif</span> <span class="n">op_size</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
</span><span id="Embedder.embed-918"><a href="#Embedder.embed-918"><span class="linenos">918</span></a>                            <span class="c1"># For all ADD/SUB instructions are always</span>
</span><span id="Embedder.embed-919"><a href="#Embedder.embed-919"><span class="linenos">919</span></a>                            <span class="c1"># 64 bits long immediates truncated to 32.</span>
</span><span id="Embedder.embed-920"><a href="#Embedder.embed-920"><span class="linenos">920</span></a>                            <span class="c1"># It can be done as Stack instructions are</span>
</span><span id="Embedder.embed-921"><a href="#Embedder.embed-921"><span class="linenos">921</span></a>                            <span class="c1"># not supported in this program (they do not</span>
</span><span id="Embedder.embed-922"><a href="#Embedder.embed-922"><span class="linenos">922</span></a>                            <span class="c1"># truncate 64 bits to 32).</span>
</span><span id="Embedder.embed-923"><a href="#Embedder.embed-923"><span class="linenos">923</span></a>                            <span class="n">op_size</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="Embedder.embed-924"><a href="#Embedder.embed-924"><span class="linenos">924</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">op_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder.embed-925"><a href="#Embedder.embed-925"><span class="linenos">925</span></a>                        <span class="c1"># Make 2&#39;s complement to negate immediate.</span>
</span><span id="Embedder.embed-926"><a href="#Embedder.embed-926"><span class="linenos">926</span></a>                        <span class="n">b_imm_compl</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__twos_complement</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">op_size</span><span class="p">)</span>
</span><span id="Embedder.embed-927"><a href="#Embedder.embed-927"><span class="linenos">927</span></a>                        <span class="c1"># Get position in instruction bytes where</span>
</span><span id="Embedder.embed-928"><a href="#Embedder.embed-928"><span class="linenos">928</span></a>                        <span class="c1"># immediate begins.</span>
</span><span id="Embedder.embed-929"><a href="#Embedder.embed-929"><span class="linenos">929</span></a>                        <span class="n">imm_idx</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__get_imm_idx</span><span class="p">(</span><span class="n">b_instr_fromf</span><span class="p">,</span>
</span><span id="Embedder.embed-930"><a href="#Embedder.embed-930"><span class="linenos">930</span></a>                                                    <span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
</span><span id="Embedder.embed-931"><a href="#Embedder.embed-931"><span class="linenos">931</span></a>                                                    <span class="n">op_size</span><span class="p">)</span>
</span><span id="Embedder.embed-932"><a href="#Embedder.embed-932"><span class="linenos">932</span></a>                        
</span><span id="Embedder.embed-933"><a href="#Embedder.embed-933"><span class="linenos">933</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;imm_idx: </span><span class="si">{</span><span class="n">imm_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder.embed-934"><a href="#Embedder.embed-934"><span class="linenos">934</span></a>                        <span class="c1"># Substitute immediate operand for his 2&#39;s comp.</span>
</span><span id="Embedder.embed-935"><a href="#Embedder.embed-935"><span class="linenos">935</span></a>                        <span class="n">bits_imm</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">()</span>
</span><span id="Embedder.embed-936"><a href="#Embedder.embed-936"><span class="linenos">936</span></a>                        <span class="n">bits_imm</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">b_imm_compl</span><span class="p">)</span>
</span><span id="Embedder.embed-937"><a href="#Embedder.embed-937"><span class="linenos">937</span></a>                        <span class="c1"># Truncate long sign extension.</span>
</span><span id="Embedder.embed-938"><a href="#Embedder.embed-938"><span class="linenos">938</span></a>                        <span class="n">imm_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">[</span><span class="n">imm_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:])</span>
</span><span id="Embedder.embed-939"><a href="#Embedder.embed-939"><span class="linenos">939</span></a>                        <span class="n">bits_instr</span><span class="p">[</span><span class="n">imm_idx</span> <span class="o">*</span> <span class="mi">8</span><span class="p">:]</span> <span class="o">=</span> <span class="n">bits_imm</span><span class="p">[:</span><span class="n">imm_len</span><span class="p">]</span>
</span><span id="Embedder.embed-940"><a href="#Embedder.embed-940"><span class="linenos">940</span></a>                        
</span><span id="Embedder.embed-941"><a href="#Embedder.embed-941"><span class="linenos">941</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instr</span><span class="o">.</span><span class="n">immediate</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">b_imm_compl</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder.embed-942"><a href="#Embedder.embed-942"><span class="linenos">942</span></a>                                                
</span><span id="Embedder.embed-943"><a href="#Embedder.embed-943"><span class="linenos">943</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">bits_instr</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Embedder.embed-944"><a href="#Embedder.embed-944"><span class="linenos">944</span></a>
</span><span id="Embedder.embed-945"><a href="#Embedder.embed-945"><span class="linenos">945</span></a>                    <span class="c1"># Embed to the executable.</span>
</span><span id="Embedder.embed-946"><a href="#Embedder.embed-946"><span class="linenos">946</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">my_instr</span><span class="o">.</span><span class="n">foffset</span><span class="p">)</span>
</span><span id="Embedder.embed-947"><a href="#Embedder.embed-947"><span class="linenos">947</span></a>                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bits_instr</span><span class="p">)</span>
</span><span id="Embedder.embed-948"><a href="#Embedder.embed-948"><span class="linenos">948</span></a>
</span><span id="Embedder.embed-949"><a href="#Embedder.embed-949"><span class="linenos">949</span></a>                    <span class="c1"># Delete already embedded bits from list.</span>
</span><span id="Embedder.embed-950"><a href="#Embedder.embed-950"><span class="linenos">950</span></a>                    <span class="k">del</span> <span class="n">bits_mess</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">eq_class</span><span class="o">.</span><span class="n">encoded_idxs</span><span class="p">[</span><span class="n">idx</span><span class="p">])]</span>
</span><span id="Embedder.embed-951"><a href="#Embedder.embed-951"><span class="linenos">951</span></a>                    <span class="c1"># sys.exit()</span>
</span><span id="Embedder.embed-952"><a href="#Embedder.embed-952"><span class="linenos">952</span></a>    
</span><span id="Embedder.embed-953"><a href="#Embedder.embed-953"><span class="linenos">953</span></a>                
</span><span id="Embedder.embed-954"><a href="#Embedder.embed-954"><span class="linenos">954</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Embedder.embed-955"><a href="#Embedder.embed-955"><span class="linenos">955</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CAN NOT BE USED - NOT LEGACY INSTRUCTION.&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="Embedder.embed-956"><a href="#Embedder.embed-956"><span class="linenos">956</span></a>                
</span><span id="Embedder.embed-957"><a href="#Embedder.embed-957"><span class="linenos">957</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">bits_mess</span><span class="p">):</span>
</span><span id="Embedder.embed-958"><a href="#Embedder.embed-958"><span class="linenos">958</span></a>                <span class="c1"># All bits were embedded (whole message).</span>
</span><span id="Embedder.embed-959"><a href="#Embedder.embed-959"><span class="linenos">959</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="Embedder.embed-960"><a href="#Embedder.embed-960"><span class="linenos">960</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All data was successfully embedded.&quot;</span><span class="p">)</span>
</span><span id="Embedder.embed-961"><a href="#Embedder.embed-961"><span class="linenos">961</span></a>                <span class="k">break</span>
</span><span id="Embedder.embed-962"><a href="#Embedder.embed-962"><span class="linenos">962</span></a>            
</span><span id="Embedder.embed-963"><a href="#Embedder.embed-963"><span class="linenos">963</span></a>        <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></pre></div>

        </details>

            <div class="docstring"><p>Embed given secret message.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>